sequenceDiagram
    participant Client as Cliente/Aplicación
    participant OSB as OSB Proxy Service
    participant Validator as Validador Regional
    participant DBAdapter as DB Adapter PA
    participant OracleDB as Oracle Database PA
    participant ErrorHandler as Manejador de Errores

    Note over Client, OracleDB: Flujo Panamá (PA01) - ConsultaFinancierasACH

    Client->>OSB: SOAP Request
    Note right of Client: Header: SourceBank=PA01<br/>Body: DESTINATION_CODE

    OSB->>OSB: Validar Esquema XML
    Note right of OSB: Validar campos obligatorios<br/>consultaFinancierasACHTypes.xsd

    alt Validación Fallida
        OSB->>ErrorHandler: Error de Validación
        ErrorHandler->>OSB: Respuesta de Error
        OSB->>Client: SOAP Fault
    end

    OSB->>Validator: Validar Servicio Regional
    Note right of Validator: ServiceId: FICBCO0118<br/>Region: PA01

    Validator->>Validator: Consultar BD Regional
    
    alt Región No Válida
        Validator->>OSB: Error Regional
        OSB->>Client: Response con Error
    end

    Validator->>OSB: Validación Exitosa

    OSB->>OSB: Enrutamiento Regional
    Note right of OSB: Branch: SourceBank = 'PA01'

    OSB->>OSB: Transformar Request (XQuery)
    Note right of OSB: consultaFinancierasACHPAIn.xq<br/>Mapear DESTINATION_CODE → InputParameters

    OSB->>DBAdapter: Invocar Stored Procedure
    Note right of DBAdapter: Business Service: consultaFinancierasACH_db<br/>JCA: eis/DB/ConnectionProxyAbanksPA<br/>Operation: consultaFinancierasACH

    DBAdapter->>OracleDB: CALL OSB_K_CONFINANCIERAS.TOPLEVEL$OSB_P_CON_FINANCIERA
    Note right of OracleDB: Package: OSB_K_CONFINANCIERAS<br/>Procedure: TOPLEVEL$OSB_P_CON_FINANCIERA<br/>Input: DESTINATION_CODE

    OracleDB->>OracleDB: Ejecutar Stored Procedure
    Note right of OracleDB: Consultar entidades financieras<br/>Obtener productos por banco<br/>Sin TRANSFER_TYPE

    alt Consulta DB Exitosa
        OracleDB->>DBAdapter: OutputParameters
        Note right of OracleDB: Arrays Oracle PA:<br/>DESTINATION_CODES (TVARCHAR3)<br/>DESTINATION_NAMES (TVARCHAR50)<br/>TYPE_OF_PRODUCTS (TVARCHAR30)<br/>MIN/MAX_PRODUCT_ID_LENGTH<br/>LEADING_ZEROS_YES_NO<br/>PRODUCT_ID_SAMPLE (TVARCHAR256)<br/>ERROR_CODE = SUCCESS<br/>(Sin TRANSFER_TYPE)

        DBAdapter->>OSB: Response con Arrays
        Note right of DBAdapter: $rp = OutputParameters<br/>con arrays específicos PA

    else Error en DB
        OracleDB->>DBAdapter: Error Response
        Note right of OracleDB: ERROR_CODE != SUCCESS<br/>ERROR_MESSAGE con detalle
        
        DBAdapter->>OSB: Response con Error
        OSB->>ErrorHandler: Mapear Error DB
        ErrorHandler->>OSB: Error Mapeado
        OSB->>Client: Response con Error
    end

    OSB->>OSB: Transformar Response Body
    Note right of OSB: consultaFinancierasACHPAOut.xq<br/>Lógica agrupación por cambio código

    Note over OSB: Regla de Agrupación PA01:<br/>for $i in (1 to count($destinationCodes))<br/>where (data($destinationCodes[$i]) != data($destinationCodes[$i+1]))<br/>or ($i = count($destinationCodes))<br/>Agrupar por cambio de código destino

    OSB->>OSB: Procesar Arrays Oracle PA
    Note right of OSB: Extraer arrays:<br/>$destinationCodes, $destinationNames<br/>$typeOfProducts, $minProductIdLength<br/>$maxProductIdLength, $leadingZerosYesNO<br/>$productIdSampleItem<br/>(Sin $transferType)

    OSB->>OSB: Aplicar Búsqueda Retrospectiva
    Note right of OSB: if (($i - 4) <= 0) then<br/>  buscar desde 1 to $i<br/>else<br/>  buscar desde ($i - 4) to $i<br/>where destinationCodes[$j] = destinationCodes[$i]

    OSB->>OSB: Generar Detalles por Grupo
    Note right of OSB: Crear consultaFinancierasACHDetailResponseRecordType<br/>para cada producto del mismo banco<br/>Sin campo TRANSFER_TYPE

    OSB->>OSB: Transformar Response Header
    Note right of OSB: consultaFinancierasACHPAHeaderOut.xq<br/>Procesar ERROR_CODE/ERROR_MESSAGE

    OSB->>Client: SOAP Response
    Note right of Client: consultaFinancierasACHResponse<br/>con agrupación por cambio código<br/>Sin campo TRANSFER_TYPE

    alt Error en Procesamiento
        OSB->>ErrorHandler: Mapear Errores
        Note right of ErrorHandler: Servicio: MapeoErrores<br/>Código: FICBCO0118

        ErrorHandler->>ErrorHandler: Procesar Error
        Note right of ErrorHandler: mapeoErroresUsageIn.xq<br/>CODIGO_ERROR + MENSAJE_ERROR

        ErrorHandler->>OSB: Error Mapeado
        Note right of ErrorHandler: mapeoErroresUsageOut.xq<br/>ResponseHeader con error

        OSB->>Client: SOAP Response con Error
        Note right of Client: ResponseHeader con<br/>successIndicator = ERROR
    end

    Note over Client, OracleDB: Reglas de Negocio Aplicadas:<br/>1. Agrupación por cambio código destino<br/>2. Búsqueda retrospectiva limitada (4 pos)<br/>3. Filtro por código destino igual<br/>4. Sin campo TRANSFER_TYPE<br/>5. Arrays Oracle específicos PA<br/>6. Mapeo directo parámetros entrada