sequenceDiagram
    autonumber
    participant Consumidor as Consumidor/Aplicación
    participant API as Consulta FICOPEN - Product <br> Epica 2217: consultaFICOPEN <br> HU 5593:  GET - /market-operations/pension-fund-administration-retrieve/v1/retrieve-account-balance-history
    participant WFP as Wrapper FICOPEN <br> "api/v2/cuentas/relaciones/periodos"
    participant Errors as Control de Errores <br/> <<Librería de mapeo de errores>>

    Note over Consumidor, Errors: Flujo Honduras (HN01) - ConsultaFICOPEN

    alt FICOPEN Response Exitoso
        Consumidor->>API: REST Request
        Note right of Consumidor: Header: SourceBank=HN01 <br/> QueryParam: investmentProductReference, initiationDate, terminationDate

        API->>API: Validar Request
        Note over API: Valida campos obligatorios según contrato OpenAPI <br/>investmentProductReference (min 1 char) <br/> initiationDate (10 chars) <br/> terminationDate (10 chars)

        API->>API: Validación Exitosa

        API->>API: Validar Regionalización
        Note over API: key de config: PENSION_FUND_ADMINISTRATION_RETRIEVE

        API->>API: Validación Regional Exitosa

        API->>API: Constuir Request Wrapper FICOPEN
        Note over API: Trasnformar initiationDate y terminationDate al formato YYYYMMDD

        API->>WFP: CALL Wrapper FICOPEN
        Note over API: investmentProductReference <br> initiationDate <br> terminationDate

        WFP->API: Response Exitoso
        Note left of WFP: Datos de cliente, cuenta, contrato<br/>Array de balances

        API->>API: Transformar Response
         Note over API: Aplicar transfornación en response campo ACCOUNT_CURRENCY: <br> 1 = "HNL"  <br> 2 = "USD" <br> 3 = "EUR" 

        API->>Consumidor: REST Response exitoso
        Note right of Consumidor: body.data
    end

    activate API
    alt Exception occurs
        note over Errors: Error Library Handler
        activate Errors
            API->> Errors: Mapear código de error
            Errors -->> API: Retorna código mapeado
        deactivate Errors
        activate Consumidor
            API-->> Consumidor: Retorna error
        deactivate Consumidor
        Note over Consumidor,Errors: Diagrama guía de manejo de errores <br> http://bit.ly/4rpKVIU
    end
    deactivate API
