sequenceDiagram
    autonumber
    participant Consumidor as Consumidor/Aplicación
    participant API as Consulta FICOPEN - Product <br> Epica 2217: consultaFICOPEN <br> HU 5593:  GET - /market-operations/pension-fund-administration-retrieve/v1/retrieve-account-balance-history
    participant WrapperFicopenToken as Wrapper FICOPEN <br> "/auth"
    participant WrapperFicopenOP as Wrapper FICOPEN <br> "api/v2/cuentas/relaciones/periodos"
    participant Errors as Control de Errores <br/> <<Librería de mapeo de errores>>

    Note over Consumidor, Errors: Flujo Honduras (HN01) - ConsultaFICOPEN

    alt FICOPEN Response Exitoso
        Consumidor->>API: REST Request
        Note right of Consumidor: Header: SourceBank=HN01 <br/> Param: investmentProductReference, initiationDate, terminationDate

        API->>API: Validar Request
        Note over API: Valida campos obligatorios según contrato OpenAPI <br/>investmentProductReference (min 1 char) <br/> initiationDate (8 chars) <br/> terminationDate (8 chars)

        API->>API: Validación Exitosa

        API->>API: Validar Regionalización
        Note over API: key de config: PENSION_FUND_ADMINISTRATION_RETRIEVE

        API->>API: Validación Regional Exitosa

        API->>WrapperFicopenToken: Solicita OauthToken
        Note over API: Envía identificador de canal

        WrapperFicopenToken->>API: Recibe OatuhToken
        Note left of WrapperFicopenToken: Bearer Token para consumo de APIs FICOPEN

        API->>API: Constuir Request Wrapper FICOPEN

        API->>WrapperFicopenOP: CALL Wrapper FICOPEN
        Note over API: OauthToken <br/> investmentProductReference <br> initiationDate <br> terminationDate

        WrapperFicopenOP->API: Response Exitoso
        Note left of WrapperFicopenOP: Datos de cliente, cuenta, contrato<br/>Array de balances

        API->>API: Transformar Response

        API->>Consumidor: REST Response exitoso
        Note right of Consumidor: body.data
    end

    activate API
    alt Exception occurs
        note over Errors: Error Library Handler
        activate Errors
            API->> Errors: Mapear código de error
            Errors -->> API: Retorna código mapeado
        deactivate Errors
        activate Consumidor
            API-->> Consumidor: Retorna error
        deactivate Consumidor
        Note over Consumidor,Errors: Diagrama guía de manejo de errores <br> http://bit.ly/4rpKVIU
    end
    deactivate API
    Note left of Consumidor: Información completa de FICOPEN<br/>con balances por tipo
