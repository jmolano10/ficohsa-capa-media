
sequenceDiagram
    participant Consumidor as Consumidore/Aplicación
    participant API as API Consulta Puntos Disponible VISA <br> Epica 2382: ConsultaPuntosLealtad <br> HU 54371:  GET - XXXXXX
    participant CL as Caché Local
    participant Lambda as Lambda de parámetros
    participant Parameter as Parameter Store
    participant Lib as Librería Pipeline (ConfigMap)
    participant WVPLUS as Wrapper Vision Plus <br/> Operación: PointsAdjustmentInquiry <br> URI: http://172.28.1.146:7802/VisionPlusService
    participant Errors as Control de Errores <br> <<Librería de mapeo de errores>>
    
    Note over Consumidor, Errors: Flujos Guatemala, Panamá y Nicaragua (GT01 | PA01 | NI01) - ConsultaPuntosTransaccion Alcance

    Consumidor->>API: REST Request
    Note right of Consumidor: Header, queryParam: org, accountNumber, scheme

    API->>API: Validar Request
    Note over API: Valida campos obligatorios según contrato OpenAPI <br> noTarjetaCreditoRequestAPI (obligatorio)

    API->>API: Validación exitosa

    API->>API: Validar Servicio Regional
    Note over API: domain: XXXXX <br> name: CONFIG

    API->>API: Validación Regional Exitosa
    Note over API: Servicio habilitado para GT01 | PA01 | NI01

    alt Consulta parametros en caché local

        API->>CL: Consultar parámetros Lambda Parámetros caché local
        Note right of API: Domain: XXXXX <br> name: PARAM  

        CL->>API: Obtiene parámetros Lambda Parámetros Cahé Local
        Note left of CL: ObtenerParametrizacion 1 Parámetro: <br> value.param-name = ban-xrs-ic-parm-vision-plus-service-wsdl-<env>

        API->>CL: Consultar parámetros Parameter Store caché local
        Note right of API: Param Name: ban-xrs-ic-parm-vision-plus-service-wsdl-<env> <br> (Parámetro ya creado - Reutilizar)

        CL->>API: Obtiene parámetros Parameter Store Caché Local
        Note left of CL: ObtenerParametrizacion 3 Campos: <br> ip = “htts://172.28.1.146” <br> port: "7802" <br> basePath = VisionPlusService” 

    else Consulta  parametros en Lambda Parámetros / Parameter Store

        API->>Lambda: Consultar parámetros lambda parámetros
        Note right of API: Domain: XXXXX <br> name: PARAM

        Lambda->>API: Obtiene parámetros Lambda Parámetros
        Note left of Lambda: ObtenerParametrizacion 1 Parámetro: <br> value.param-name = ban-xrs-ic-parm-vision-plus-service-wsdl-<env> 

        API->>CL: Guarda parámetros lambda Parámetros en caché local
        Note right of API: value.param-name 

        API->>Parameter: Consultar parámetros Parameter Store
        Note right of API: Param Name: ban-xrs-ic-parm-vision-plus-service-wsdl-<env> <br> (Parámetro ya creado - Reutilizar)

        Parameter->>API: Obtiene parámetros Parameter Store
        Note left of Parameter: ObtenerParametrizacion 3 Campos: <br> ip = “htts://172.28.1.146” <br> port: "7802" <br> basePath = VisionPlusService” 

        API->>CL: Guarda parámetros Parameter Store en caché local
        Note right of API: ip, basePath

    end

    API->>Lib: Consulta Constantes
   
    Lib->>API: Retorna constantes necesarias
    Note left of Lib: operation = "PointsAdjustmentInquiry"

    API->>API: Construye Request Wrapper Vision Plus
    Note over API: Mapeo Campos : <br> operation = param.operation <br> payload.data = { <br> GPXAII-ORG = request.org (int), <br> GPXAII-ACCOUNT-NUMBER = request.accountNumber (string), <br> GPXAII-SCHEME = request.scheme (string) <br>} <br> paramName = value.param-name

    API->>WVPLUS: Consume Wrapper Vision Plus - PointsAdjustmentInquiry
    Note right of API: Body: operation, payload.data

    WVPLUS->>API: Response Wrapper Vision Plus - PointsAdjustmentInquiryResponse
    Note over WVPLUS: Response: <br> GPXAIO-OPEN-TO-RED-ON-SCR <br> 72 campos adicionales

    API->>API: Construye response API
    Note over API: Mapeo Campos : <br> availablePoints = GPXAIO-OPEN-TO-RED-ON-SCR <br> 72 campos adicionales según contrato OpenAPI

    API->>Consumidor: Response Exitoso
    Note left of API: HTTP 200: Response Body 

    Note over Consumidor, Errors: Flujo Alternativo - Error
    activate API
    alt Exception occurs
        note over Errors: Error Library Handler
        activate Errors
            API->> Errors: Mapear código de error
            Errors -->> API: Retorna código mapeado
        deactivate Errors
        activate Consumidor
            API-->> Consumidor: Retorna error
        deactivate Consumidor
        Note over Consumidor,Errors: Diagrama guía de manejo de errores <br> http://bit.ly/4rpKVIU
    end
    deactivate API