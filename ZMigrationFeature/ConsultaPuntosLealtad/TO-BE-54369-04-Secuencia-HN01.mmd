
sequenceDiagram
    autonumber
    participant Consumidor as Consumidore/Aplicación
    participant API as API Consulta Info Tarjetas Crédito <br> Epica 2382: ConsultaPuntosLealtad <br> HU 54369:  GET - /cards/credit-card-detail-retrieves/v1/retrieve-information
    participant CL as Caché Local
    participant Lambda as Lambda de parámetros
    participant Parameter as Parameter Store
    participant Lib as Librería Pipeline (ConfigMap)
    participant InfoTC as Información Tarjeta <br/> Operación: InformaciónTarjeta <br> URI DEV: http://172.16.100.43/WSInfoTarjetasProduccion/wsinfotarjetas.asmx
    participant Errors as Control de Errores <br> <<Librería de mapeo de errores>>
    
    Note over Consumidor, Errors: Flujo Honduras (HN01) - ConsultaPuntosTransaccion Alcance

    Consumidor->>API: REST Request
    Note right of Consumidor: Header, queryParam: noTarjetaCreditoRequestAPI

    API->>API: Validar Request
    Note over API: Valida campos obligatorios según contrato OpenAPI <br> noTarjetaCreditoRequestAPI (obligatorio)

    API->>API: Validación exitosa

    API->>API: Validar Servicio Regional
    Note over API: domain: CREDIT_CARD_DETAIL_RETRIEVES <br> name: CONFIG

    API->>API: Validación Regional Exitosa
    Note over API: Servicio habilitado para HN01

    alt Consulta parametros en caché local

        API->>CL: Consultar parámetros Lambda Parámetros caché local
        Note right of API: Domain: CREDIT_CARD_DETAIL_RETRIEVES <br> name: PARAM <br> country: HND 

        CL->>API: Obtiene parámetros Lambda Parámetros Cahé Local
        Note left of CL: ObtenerParametrizacion 1 Parámetro: <br> value.param-name = ban-hnd-lc-transaccion-alcance-ws-param-wsdl-<env>

        API->>CL: Consultar parámetros Parameter Store caché local
        Note right of API: Param Name: ban-hnd-lc-transaccion-alcance-ws-param-wsdl-<env>

        CL->>API: Obtiene parámetros Parameter Store Caché Local
        Note left of CL: ObtenerParametrizacion 2 Campos: <br> ip = “htts://172.16.100.43” <br> basePath = “WSInfoTarjetasProduccion/wsinfotarjetas.asmx” 

    else Consulta  parametros en Lambda Parámetros / Parameter Store

        API->>Lambda: Consultar parámetros lambda parámetros
        Note right of API: Domain: CREDIT_CARD_DETAIL_RETRIEVES <br> name: PARAM <br> country: HND

        Lambda->>API: Obtiene parámetros Lambda Parámetros
        Note left of Lambda: ObtenerParametrizacion 1 Parámetro: <br> value.param-name = ban-hnd-lc-transaccion-alcance-ws-param-wsdl-<env>

        API->>CL: Guarda parámetros lambda Parámetros en caché local
        Note right of API: value.param-name 

        API->>Parameter: Consultar parámetros Parameter Store
        Note right of API: Param Name: ban-hnd-lc-transaccion-alcance-ws-param-wsdl-<env>

        Parameter->>API: Obtiene parámetros Parameter Store
        Note left of Parameter: ObtenerParametrizacion 2 Campos: <br> ip = “htts://172.16.100.43” <br> basePath = “WSInfoTarjetasProduccion/wsinfotarjetas.asmx” 

        API->>CL: Guarda parámetros Parameter Store en caché local
        Note right of API: ip, basePath

    end

    API->>Lib: Consulta Constantes
   
    Lib->>API: Retorna constantes necesarias
    Note left of Lib: operation = "InformacionTarjeta"

    API->>API: Construye Request WS Transaccion Alcance
    Note over API: noTarjetaCredito = request.noTarjetaCreditoRequestAPI

    API->>InfoTC: Consume WS Transaccion Alcance - informacionTarjetas
    Note right of API: Body: noTarjetaCredito

    InfoTC->>API: Response WS Transaccion Alcance - InformacionTarjeta
    Note over InfoTC: Response: <br> EstatusConfirmacion, MensajeConfirmacion, NumeroCuenta, <br> NombreTarjetaTitular, NombreTarjetaHabiente, TipoTarjeta, <br> CodigoClienteCuenta, IdentificacionClienteCuenta, IdentificacionCLienteTarjeta, <br> Producto, GrupoAfinidad, EstadoCuenta, EstadoTarjeta, <br> FechaVencimiento, Producto_descripcion, GrupoAfinidad_descripcion

    API->>API: Construye response API
    Note over API: accountNumber = NumeroCuenta <br> cardHolderReference = NombreTarjetaTitular <br> cardHolderName = NombreTarjetaHabiente <br> cardType = TipoTarjeta <br> customerAccountCode = CodigoClienteCuenta <br> customerLegalReference = IdentificacionClienteCuenta <br> cardholderIdentification = IdentificacionCLienteTarjeta <br> productCode = Producto <br> affinityGroupCode = GrupoAfinidad <br> creditCardAccountStatus = EstadoCuenta <br> cardStatus = EstadoTarjeta <br> cardExpirationDate = FechaVencimiento <br> productDescription = Producto_descripcion <br> affinityGroupDescription = GrupoAfinidad_descripcion

    API->>Consumidor: Response Exitoso
    Note left of API: HTTP 200: Response Body 

    Note over Consumidor, Errors: Flujo Alternativo - Error
    activate API
    alt Exception occurs
        note over Errors: Error Library Handler
        activate Errors
            API->> Errors: Mapear código de error
            Errors -->> API: Retorna código mapeado
        deactivate Errors
        activate Consumidor
            API-->> Consumidor: Retorna error
        deactivate Consumidor
        Note over Consumidor,Errors: Diagrama guía de manejo de errores <br> http://bit.ly/4rpKVIU
    end
    deactivate API