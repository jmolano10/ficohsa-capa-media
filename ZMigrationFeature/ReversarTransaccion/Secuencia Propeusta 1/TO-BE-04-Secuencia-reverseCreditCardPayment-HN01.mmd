sequenceDiagram
    participant Consumidor as Consumidore/Aplicación
    participant API as API Reverso Credit Card Payment <br> Epica 2490: ReversarTransaccion <br> HU 6627: POST: 
    participant T24  as Wrapper T24 <br> svcResversaTransaccion/services <br> Operation: ReversionpagooretiroTC
    participant SM as Secret Manager
    participant T24Auth as Wrapper T24 <br> svcResversaTransaccion/services <br> Operation: AutorizareversapagooretiroTC
    participant Errors as Control de Errores <br/> <<Librería de mapeo de errores>>
    participant Reintentos as Componente de Idempotencia

    Note over Consumidor, Reintentos: Flujo Honduras (HN01) - ReversarTransaccion Credit Card Payment

    Consumidor->>API: Rest Request
    Note right of Consumidor: Header: SourceBank=HN01<br/>Body: transactionReference, transactionType

    API->>API: Validar Rquest
    Note over API: Validar campos según contrato OpenAPI <br/> transactionReference != vacío

    API->>API: Validar Servicio Regional
    Note over API: key de config: XXXXXXXX
    
    API->>API: Validación Regional Exitosa
    Note over API: Servicio habilitado para HN01

    API->>API: Validación Exitosa

    API->>API: Construir Request ReversionpagooretiroTC
    Note over API: Mapeo: <br> id = transactionReference

    API->>T24 : CALL ReversionpagooretiroTC
    Note right of API : id

    T24 ->>API: Response Reversión TC
    Note left of T24 : successIndicator

    API->>API: Evaluar Response ReversionpagooretiroTC
    Note over API: Validar successIndicator

    alt ReversionpagooretiroTC Exitoso - successIndicator = SUCCESS

        API->>Consumidor: REST Response exitoso
        Note right of Consumidor: body.data <br> transactionReference <br> transactionType <br> transactionDate

        Note over API: ¿¿¿¿como disparar flujo asíncrono????

        API->>SM: Consulta credenciales (username, password)
        Note right of API: Busca por nombre método

        SM->>API: Obtiene credenciales (username, password)
        Note left of SM: username <br> password

        API->>API: Construir Request AutorizareversapagooretiroTC
        Note over API: Mapeo: <br> userName = userName <br> password = password <br> transactionId = transactionReference

        API->>T24Auth: CALL AutorizareversapagooretiroTC
        Note right of API: userName, password, transactionId
    
        T24Auth->>API: Response Autorización
        Note left of T24Auth : successIndicator

        API->>API: Evaluar Response AutorizareversapagooretiroTC

        alt AutorizareversapagooretiroTC No Exitoso - successIndicator != SUCCESS
            
            note over API, Reintentos: ¿¿¿¿Como se maneja el envío a reintentos???
            API->> Reintentos: Envíar información al componente de reintentos
            Reintentos ->> API: Existe respuesta o se envía a una cola para reintentos???
        end

    else ReversionpagooretiroTC NO Exitoso - successIndicator != SUCCESS
    
        alt Exception occurs
            note over Errors: Error Library Handler
            activate Errors
                API->> Errors: Mapear código de error
                Errors -->> API: Retorna código mapeado
            deactivate Errors
            activate Consumidor
                API-->> Consumidor: Retorna error
            deactivate Consumidor
            Note over Consumidor,Errors: Diagrama guía de manejo de errores <br> http://bit.ly/4rpKVIU
        end
    end

    