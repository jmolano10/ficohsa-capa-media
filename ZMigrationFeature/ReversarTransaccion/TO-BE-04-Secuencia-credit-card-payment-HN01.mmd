sequenceDiagram
    participant Consumidor as Consumidore/Aplicación
    participant API as API Proxy Service
    participant API as Validador Regional
    participant T24  as Wrapper T24 <br> svcResversaTransaccion <br> Operation: ReversionpagoTC
    participant T24Auth as Wrapper T24 <br> svcResversaTransaccion <br> Operation: AutorizareversapagooretiroTC
    participant CB as ConnectionPagosWSTC <br> schema: PagosWSTC <br> SP: OSB_P_REGISTRA_REVERSION_TC_CB
    participant PagosTC as ConnectionTarjetas <br> schema: PagosTC <br> SP: OSBRegistraReversaTC
    participant Reintentos as Manejador de Errores

    Note over Consumidor, Reintentos: Flujo Honduras (HN01) - ReversarTransaccion

    Consumidor->>API: Rest Request
    Note right of Consumidor: Header: SourceBank=HN01<br/>Body: TRANSACTION_ID, TRANSACTION_TYPE

    API->>API: Validar Rquest
    Note right of API: Validar campos según contrato OpenAPI

    API->>API: Validar Servicio Regional
    Note right of API: key de config: XXXXXXXX
    
    API->>API: Validación Regional Exitosa
    Note right of API: Servicio habilitado para HN01

    API->>API: Validación Exitosa

    API->>Consumidor: Response Exitoso
    Note left of API: code: 202 <br> successIndicator: SUCCESS <br/> Body: Transacción recibida para reverso

    API->>API: Construir Request
    Note right of API: trxId = TRANSACTION_ID<br/>tipoTrx = substring(trxId, 1, 2)<br/>transactionType = TRANSACTION_TYPE

    API->>T24 : ReversionpagoTC
    Note right of T24 : XQuery: ReversarTransaccionPagoRetiroTCIn.xq<br/>Mapeo: TRANSACTION_ID → TFS

    T24 -->>API: Response Reversión TC

    API->>API: Evaluar Response
    Note right of API: Verificar status/messages

    alt Reversión TC Exitosa
        API->>T24Auth: AutorizareversapagooretiroTC
        Note left of T24Auth: XQuery: AutorizarReversionPagoRetiroTCIn.xq<br/>Autorización dual requerida
        
        T24Auth-->>API: Response Autorización

        API->>CB: registrarReversionTCCB
        Note left of CB: SP: registrarReversionTCCB<br/>Registro en Core Banking

        CB->>API: Response Registro

        API->>PagosTC: registraReversaTC
        Note left of PagosTC: SP: registraReversaTC<br/>Registro en sistema

        PagosTC->>API: Response Registro

    else Reversión TC Fallida
        API->>API: Asignar Mensaje Error
        Note right of API: messageReversion = Status/messages
    end

    activate API
    alt Envío para reintentos
    note over API, Reintentos: ¿¿¿¿Como se maneja el envío a reintentos???
        activate Reintentos
            API->> Reintentos: Envíar información al componente de reintentos
            Reintentos -->> API: Existe respuesta o se envía a una cola para reintentos???
        deactivate Reintentos
    end
    deactivate API