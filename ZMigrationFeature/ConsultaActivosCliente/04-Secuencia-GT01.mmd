sequenceDiagram
    participant Client as Cliente/Aplicación
    participant OSB as OSB Proxy<br/>ConsultaActivosCliente
    participant ValidaSvc as ValidaServicioRegional<br/>(DB)
    participant SplitJoin as sjConsultaActivosCliente<br/>(Split-Join Flow)
    participant DBCuentas as consultaListaCuentas_db<br/>(Oracle DB)
    participant DBDepositos as consultaListaDepositosCliente_db<br/>(Oracle DB)
    participant ValidaFunc as ValidaFuncionalidadUsuario<br/>(DB)
    participant MapeoErr as MapeoErrores<br/>(OSB)

    Note over Client, MapeoErr: Flujo Guatemala (GT01) - ConsultaActivosCliente

    Client->>OSB: SOAP Request HTTPS
    Note right of Client: Header: SourceBank=GT01<br/>UserName, Password<br/>Body: CUSTOMER_ID, ASSET_TYPE

    OSB->>ValidaSvc: ValidaServicioRegional
    Note right of OSB: PV_SERVICE_ID: FICBCO0043<br/>PV_SOURCE_BANK: GT01

    ValidaSvc-->>OSB: PV_CODIGO_ERROR, PV_MENSAJE_ERROR

    alt Región No Válida
        OSB->>OSB: successIndicator=ERROR
        OSB->>Client: Response con Error
    end

    OSB->>OSB: aplicarValoresPorDefectoRegion.xq
    Note right of OSB: Aplica valores por defecto

    OSB->>OSB: Enrutamiento Regional
    Note right of OSB: Branch: SourceBank = 'GT01'

    OSB->>OSB: Asignar Variables
    Note right of OSB: $product = ASSET_TYPE<br/>$customer = CUSTOMER_ID

    alt ASSET_TYPE = "AHO" OR "CHQ" OR "CTA"
        OSB->>DBCuentas: consultaListaCuentas
        Note right of OSB: XQuery: consultaListaCuentasGTIn.xq<br/>CUSTOMER_ID → PV_CUSTOMER_ID<br/>Conexión: ConnectionProxyAbanksGT<br/>SP: OSB_K_CONLISTACUENTAS.TOPLEVEL$OSB_P_CON_LISTA_CUEN

        DBCuentas-->>OSB: OutputParameters
        Note left of DBCuentas: PV_ERROR_CODE<br/>PV_ASSET_TYPE_OUT (array)<br/>PV_ASSET_NUMBER (array)<br/>PV_ASSET_NAME (array)<br/>PV_ASSET_CURRENCY (array)<br/>PV_ASSET_TOTAL_BALANCE (array)<br/>PV_ASSET_RESERVE_BALANCE (array)<br/>PV_ASSET_LOCKED_BALANCE (array)<br/>PV_ASSET_VISA_FLOATING_BALANCE (array)<br/>PV_ASSET_AVAILABLE_BALANCE (array)<br/>PV_ASSET_PRODUCT_TYPE (array)

        OSB->>OSB: consultaListaCuentasGTOut.xq
        Note right of OSB: Filtrar por tipo (AHO/CHQ)<br/>ASSET_SOURCE_BANK = "GT01"
    end

    alt ASSET_TYPE = "DEP"
        OSB->>DBDepositos: consultaListaDepositosCliente
        Note right of OSB: XQuery: consultaListaDepositosGTIn.xq<br/>CUSTOMER_ID → PV_CUSTOMER_ID<br/>Conexión: ConnectionProxyAbanksGT<br/>SP: Similar para depósitos

        DBDepositos-->>OSB: OutputParameters
        Note left of DBDepositos: PV_ERROR_CODE<br/>PV_ASSET_NUMBER (array)<br/>PV_ASSET_NAME (array)<br/>Campos de saldo

        OSB->>OSB: consultaListaDepositosGTOut.xq
        Note right of OSB: ASSET_TYPE = "DEP"<br/>ASSET_SOURCE_BANK = "GT01"
    end

    alt ASSET_TYPE = "ALL"
        OSB->>SplitJoin: sjConsultaActivosCliente
        Note right of OSB: XQuery: sjConsultaActivosClientesGTIn.xq<br/>CUSTOMER_ID → PV_CUSTOMER_ID<br/>ASSET_TYPE → PV_ASSET_TYPE

        Note over SplitJoin: Ejecución Paralela (BPEL Flow)

        par Consulta Cuentas
            SplitJoin->>DBCuentas: consultaListaCuentas
            Note right of SplitJoin: XQuery: consultaActivosClienteCtasGTIn.xq<br/>InputParameters → PV_CUSTOMER_ID<br/>Conexión: ConnectionProxyAbanksGT

            DBCuentas-->>SplitJoin: OutputParameters Cuentas
            Note left of DBCuentas: Arrays con AHO y CHQ
        and Consulta Depósitos
            SplitJoin->>DBDepositos: consultaListaDepositosCliente
            Note right of SplitJoin: XQuery: consultaActivosClienteDepsGTIn.xq<br/>InputParameters → PV_CUSTOMER_ID<br/>Conexión: ConnectionProxyAbanksGT

            DBDepositos-->>SplitJoin: OutputParameters Depósitos
            Note left of DBDepositos: Arrays con DEP
        end

        SplitJoin->>SplitJoin: Agregar Resultados
        Note right of SplitJoin: XQuery: consultaActivosClienteGTOut.xq<br/>Combina OutputParametersCuentas<br/>y OutputParametersDepositos

        SplitJoin-->>OSB: OutputParameters Consolidado
        Note left of SplitJoin: Todos los tipos de activos

        OSB->>OSB: sjConsultaActivosClienteGTOut.xq
        Note right of OSB: Mapeo completo:<br/>- Filtrar AHO de PV_ASSET_TYPE_OUT<br/>- Filtrar CHQ de PV_ASSET_TYPE_OUT<br/>- Mapear DEP<br/>- ASSET_SOURCE_BANK = "GT01"<br/>- Función mensajeRespuesta()
    end

    OSB->>ValidaFunc: ValidaFuncionalidadUsuario
    Note right of OSB: XQuery: consultaFuncionalidadUsuario.xq<br/>PV_USER_NAME: UserName<br/>PV_FUNCTIONALITY: SALDOS_ACTIVOS<br/>PV_SOURCE_BANK: GT01

    ValidaFunc-->>OSB: PV_CODIGO_ERROR, PV_VALOR

    alt Validación Exitosa
        OSB->>OSB: $functionalityIndicator = PV_VALOR
    else Validación Fallida
        OSB->>OSB: $functionalityIndicator = "ALL"
    end

    OSB->>OSB: Transformar Response
    Note right of OSB: Pipeline: GT01_ConsultaActivosCliente_response

    alt ASSET_TYPE = AHO, CHQ, CTA
        OSB->>OSB: consultaListaCuentasGTHeaderOut.xq
        Note right of OSB: OutputParameters → ResponseHeader

        OSB->>OSB: consultaListaCuentasGTOut.xq
        Note right of OSB: OutputParameters → Body
    end

    alt ASSET_TYPE = DEP
        OSB->>OSB: consultaListaDepositosGTHeaderOut.xq
        Note right of OSB: OutputParameters → ResponseHeader

        OSB->>OSB: consultaListaDepositosGTOut.xq
        Note right of OSB: OutputParameters → Body
    end

    alt ASSET_TYPE = ALL
        OSB->>OSB: sjConsultaActivosClienteGTHdrOut.xq
        Note right of OSB: OutputParameters → ResponseHeader

        OSB->>OSB: sjConsultaActivosClienteGTOut.xq
        Note right of OSB: OutputParameters → Body<br/>Incluye Ahorros, Corrientes, Depósitos
    end

    alt successIndicator != SUCCESS
        OSB->>MapeoErr: mapeoErrores
        Note right of OSB: XQuery: mapeoErroresUsageIn.xq<br/>CODIGO_ERROR: successIndicator<br/>MENSAJE_ERROR: FICBCO0043$#$messages

        MapeoErr-->>OSB: mapeoErroresResponse

        OSB->>OSB: mapeoErroresUsageOut.xq
        Note right of OSB: Actualiza ResponseHeader
    end

    OSB->>Client: SOAP Response
    Note left of OSB: ResponseHeader: successIndicator<br/>Body: consultaActivosClienteResponse<br/>Ahorros, Corrientes, Depósitos<br/>ASSET_SOURCE_BANK = "GT01"
