<bpel:process name="CallBothEnginesGetBatchStatusSJ" targetNamespace="http://xmlns.oracle.com/SBRG_MassivePayment/SBRG_MassivePayment_Router/" bea:name="CallBothEnginesGetBatchStatusSJ" rescon:snippetVersion="1.0" xmlns:tns="http://xmlns.oracle.com/SBRG_MassivePayment/SBRG_MassivePayment_Router/" xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable" xmlns:rescon="http://www.bea.com/alsb/flow/resources/config" xmlns:bea="http://www.bea.com/bpel/ui/extensions" xmlns:ext="http://www.bea.com/bpel/extensions" xmlns:expr="http://www.bea.com/wli/sb/stages/config" xmlns:trf="http://www.bea.com/wli/sb/stages/transform/config" xmlns:bind="http://www.ficohsa.com.hn/middleware.services/pagosMasivosPS/" xmlns:ns0="http://www.bea.com/wli/sb/reference" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:ns1="https://www.ficohsa.com/regional/massivePayment/apiPagosMasivosGatewayTypes" xmlns:ns2="http://www.bea.com/wli/sb/pipeline/config" xmlns:ns3="http://xmlns.oracle.com/SBRG_MassivePayment/SBRG_MassivePayment_Commons/LoggingRegionalRestBS" xmlns:ns4="http://xmlns.oracle.com/ServiceBusApplication/SBRG_MassivePayment_Router/ApiPagosMasivosGatewayRestBS"
              xmlns:pag="http://www.ficohsa.com.hn/middleware.services/pagosMasivosTypes">
    <rescon:importInfo>
        <rescon:schema-import ref="SBRG_MassivePayment_Router/Schemas/ApiPagosMasivosGatewayTypes"/>
    </rescon:importInfo>
    <bpel:partnerLinks>
        <bpel:partnerLink name="CallBothEnginesGetBatchStatusSJ" partnerLinkType="tns:CallBothEnginesGetBatchStatusSJ" myRole="CallBothEnginesGetBatchStatusSJ">
	       </bpel:partnerLink>
        <bpel:partnerLink name="ApiPagosMasivosGatewayRestBS" partnerLinkType="tns:ApiPagosMasivosGatewayRestBS" partnerRole="ApiPagosMasivosGatewayRestBS"/>
        <bpel:partnerLink name="CallLoggingRegional" partnerLinkType="tns:CallLoggingRegional" partnerRole="CallLoggingRegional"/>
        <bpel:partnerLink name="ConsultaLotesCliente11gBS" partnerLinkType="tns:ConsultaLotesCliente11gBS"
                          partnerRole="ConsultaLotesCliente11gBS"/>
        <bpel:partnerLink name="ConsultaLotesClienteSoapPS" partnerLinkType="tns:ConsultaLotesClienteSoapPS"
                          partnerRole="ConsultaLotesClienteSoapPS"/>
    </bpel:partnerLinks>

	   <bpel:variables>
        <bpel:variable name="sourceBank" type="xsd:string"/>
        <bpel:variable name="destinationBank" type="xsd:string"/>
        <bpel:variable name="user" type="xsd:string"/>
        <bpel:variable name="version" type="xsd:string"/>
        <bpel:variable name="service" type="xsd:string"/>
        <bpel:variable name="endPoint" type="xsd:string"/>
        <bpel:variable name="method" type="xsd:string"/>
        <bpel:variable name="successIndicatorOld" type="xsd:string"/>
        <bpel:variable name="successIndicatorNew" type="xsd:string"/>
        <bpel:variable name="customerId" type="xsd:string"/>
        <bpel:variable name="queryType" type="xsd:string"/>
        <bpel:variable name="queryValue" type="xsd:string"/>
        <bpel:variable name="requestApiGateway" messageType="ns4:System_inputMessage"/>
        <bpel:variable name="responseApiGateway" messageType="ns4:System_outputMessage"/>
        <bpel:variable name="system" type="xsd:string"/>
        <bpel:variable name="protocol" type="xsd:string"/>
        <bpel:variable name="operation" type="xsd:string"/>
        <bpel:variable name="successIndicatorApiGateway" type="xsd:string"/>
        <bpel:variable name="requestLoggingOld" messageType="ns3:SaveLogInFileSystem_inputMessage"/>
        <bpel:variable name="requestLoggingNew" messageType="ns3:SaveLogInFileSystem_inputMessage"/>
        <bpel:variable name="requestLoggingApiGateway" messageType="ns3:SaveLogInFileSystem_inputMessage"/>
        <bpel:variable name="request" messageType="bind:consultaLotesClienteRequest"/>
        <bpel:variable name="response" messageType="bind:consultaLotesClienteResponse"/>
        <bpel:variable name="responseOld" messageType="bind:consultaLotesClienteResponse"/>
        <bpel:variable name="responseNew" messageType="bind:consultaLotesClienteResponse"/>
        <bpel:variable name="totalBatchesOld" type="xsd:integer"/>
        <bpel:variable name="totalBatchesNew" type="xsd:integer"/>
        <bpel:variable name="batchesToInsert" type="xsd:anyType"/>
        <bpel:variable name="requestLoggingInformation" messageType="ns3:SaveLogInFileSystem_inputMessage"/>
    </bpel:variables>

    <bpel:sequence>
        <bpel:receive partnerLink="CallBothEnginesGetBatchStatusSJ" operation="consultaLotesCliente" createInstance="yes"
                      variable="request">
	           <rescon:receiveInfo>
                <rescon:wsdl ref="SBRG_MassivePayment_Commons_Virtual/Resources/PagosMasivos/consultaLotesClientePS"
                             binding="bind:consultaLotesClientePSSOAP"/>
            </rescon:receiveInfo>
        </bpel:receive>
        <bpel:scope bea:name="ScopeVariablesGenerales">
            <bpel:faultHandlers>
                <bpel:catchAll>
                    <bpel:sequence>
                        <bpel:empty/>
                        <bpel:assign>
                            <bpel:extensionAssignOperation>
                                <trf:assign varName="response.ResponseHeader">
                                    <trf:expr>
                                        <expr:xqueryText>&lt;ns2:ResponseHeader xmlns:ns2="http://www.ficohsa.com.hn/middleware.services/autType"&gt;
      &lt;messageId&gt;1&lt;/messageId&gt;
      &lt;successIndicator&gt;ERROR&lt;/successIndicator&gt;
      &lt;messages&gt;CallBothEnginesGetCustomerBatchSJ-ScopeVariablesGenerales&lt;/messages&gt;
    &lt;/ns2:ResponseHeader&gt;</expr:xqueryText>
                                    </trf:expr>
                                </trf:assign>
                            </bpel:extensionAssignOperation>
                            <bpel:extensionAssignOperation>
                                <trf:assign varName="response.result">
                                    <trf:expr>
                                        <expr:xqueryText>&lt;pag:consultaLotesClienteResponse xmlns:pag="http://www.ficohsa.com.hn/middleware.services/pagosMasivosTypes"/&gt;</expr:xqueryText>
                                    </trf:expr>
                                </trf:assign>
                            </bpel:extensionAssignOperation>
                        </bpel:assign>
                        <bpel:reply operation="consultaLotesCliente" partnerLink="CallBothEnginesGetBatchStatusSJ"
                                    variable="response"/>
                        <bpel:exit/>
                    </bpel:sequence>
                </bpel:catchAll>
            </bpel:faultHandlers>
            <bpel:sequence>
                <bpel:assign>
                    <bpel:extensionAssignOperation>
                        <trf:assign varName="sourceBank">
                            <trf:expr>
                                <expr:xqueryText>if(($request.RequestHeader/Region/SourceBank) and (data($request.RequestHeader/Region/SourceBank)!= '')) then
    data($request.RequestHeader/Region/SourceBank)
else(
    'HN01'
)</expr:xqueryText>
                            </trf:expr>
                        </trf:assign>
                    </bpel:extensionAssignOperation>
                    <bpel:extensionAssignOperation>
                        <trf:assign varName="destinationBank">
                            <trf:expr>
                                <expr:xqueryText>if(($request.RequestHeader/Region/DestinationBank) and (data($request.RequestHeader/Region/DestinationBank)!= '')) then
data($request.RequestHeader/Region/DestinationBank)
else(
$sourceBank
)</expr:xqueryText>
                            </trf:expr>
                        </trf:assign>
                    </bpel:extensionAssignOperation>
                    <bpel:extensionAssignOperation>
                        <trf:assign varName="protocol">
                            <trf:expr>
                                <expr:xqueryText>'SOAP'</expr:xqueryText>
                            </trf:expr>
                        </trf:assign>
                    </bpel:extensionAssignOperation>
                    <bpel:extensionAssignOperation>
                        <trf:assign varName="user">
                            <trf:expr>
                                <expr:xqueryText>data($request.RequestHeader/Authentication/UserName)</expr:xqueryText>
                            </trf:expr>
                        </trf:assign>
                    </bpel:extensionAssignOperation>
                    <bpel:extensionAssignOperation>
                        <trf:assign varName="version">
                            <trf:expr>
                                <expr:xqueryText>'v1'</expr:xqueryText>
                            </trf:expr>
                        </trf:assign>
                    </bpel:extensionAssignOperation>
                    <bpel:extensionAssignOperation>
                        <trf:assign varName="service">
                            <trf:expr>
                                <expr:xqueryText>'MassivePayment/Router/CallBothEnginesGetCustomerBatchSJ'</expr:xqueryText>
                            </trf:expr>
                        </trf:assign>
                    </bpel:extensionAssignOperation>
                    <bpel:extensionAssignOperation>
                        <trf:assign varName="endPoint">
                            <trf:expr>
                                <expr:xqueryText>'SBRG_MassivePayment_Router/SJ/CallBothEnginesGetCustomerBatchSJ.flow'</expr:xqueryText>
                            </trf:expr>
                        </trf:assign>
                    </bpel:extensionAssignOperation>
                    <bpel:extensionAssignOperation>
                        <trf:assign varName="operation">
                            <trf:expr>
                                <expr:xqueryText>'consultaLotesCliente'</expr:xqueryText>
                            </trf:expr>
                        </trf:assign>
                    </bpel:extensionAssignOperation>
                </bpel:assign>
            </bpel:sequence>
        </bpel:scope>
        <bpel:scope bea:name="ScopeVariablesParaApiGateway">
            <bpel:faultHandlers>
                <bpel:catchAll>
                    <bpel:sequence>
                        <bpel:empty/>
                        <bpel:assign>
                            <bpel:extensionAssignOperation>
                                <trf:assign varName="response.ResponseHeader">
                                    <trf:expr>
                                        <expr:xqueryText>&lt;ns2:ResponseHeader xmlns:ns2="http://www.ficohsa.com.hn/middleware.services/autType"&gt;
      &lt;messageId&gt;2&lt;/messageId&gt;
      &lt;successIndicator&gt;ERROR&lt;/successIndicator&gt;
      &lt;messages&gt;CallBothEnginesGetCustomerBatchSJ-ScopeVariablesParaApiGateway&lt;/messages&gt;
    &lt;/ns2:ResponseHeader&gt;</expr:xqueryText>
                                    </trf:expr>
                                </trf:assign>
                            </bpel:extensionAssignOperation>
                            <bpel:extensionAssignOperation>
                                <trf:assign varName="response.result">
                                    <trf:expr>
                                        <expr:xqueryText>&lt;pag:consultaLotesClienteResponse xmlns:pag="http://www.ficohsa.com.hn/middleware.services/pagosMasivosTypes"/&gt;</expr:xqueryText>
                                    </trf:expr>
                                </trf:assign>
                            </bpel:extensionAssignOperation>
                        </bpel:assign>
                        <bpel:reply operation="consultaLotesCliente" partnerLink="CallBothEnginesGetBatchStatusSJ"
                                    variable="response"/>
                        <bpel:exit/>
                    </bpel:sequence>
                </bpel:catchAll>
            </bpel:faultHandlers>
            <bpel:sequence>
                <bpel:assign>
                    <bpel:extensionAssignOperation>
                        <trf:assign varName="method">
                            <trf:expr>
                                <expr:xqueryText>'CONSULTALOTESCLIENTE'</expr:xqueryText>
                            </trf:expr>
                        </trf:assign>
                    </bpel:extensionAssignOperation>
                    <bpel:extensionAssignOperation>
                        <trf:assign varName="customerId">
                            <trf:expr>
                                <expr:xqueryText>fn:data($request.parameters/CUSTOMER_ID)</expr:xqueryText>
                            </trf:expr>
                        </trf:assign>
                    </bpel:extensionAssignOperation>
                    <bpel:extensionAssignOperation>
                        <trf:assign varName="requestApiGateway.request">
                            <trf:expr>
                                <expr:xqueryTransform>
                                    <expr:resource ref="SBRG_MassivePayment_Router/Transformations/ServiceToAPIGateway"/>
                                    <expr:param name="destinationBank">
                                        <expr:path>$destinationBank</expr:path>
                                    </expr:param>
                                    <expr:param name="method">
                                        <expr:path>$method</expr:path>
                                    </expr:param>
                                    <expr:param name="customerId">
                                        <expr:path>$customerId</expr:path>
                                    </expr:param>
                                    <expr:param name="queryValue">
                                        <expr:path>''</expr:path>
                                    </expr:param>
                                    <expr:param name="sourceBank">
                                        <expr:path>$sourceBank</expr:path>
                                    </expr:param>
                                    <expr:param name="queryType">
                                        <expr:path>''</expr:path>
                                    </expr:param>
                                </expr:xqueryTransform>
                            </trf:expr>
                        </trf:assign>
                    </bpel:extensionAssignOperation>
                </bpel:assign>
            </bpel:sequence>
        </bpel:scope>
        <bpel:scope bea:name="ScopeLoggingRequestApiGateway">
            <bpel:faultHandlers>
                <bpel:catchAll>
                    <bpel:sequence>
                        <bpel:empty/>
                    </bpel:sequence>
                </bpel:catchAll>
            </bpel:faultHandlers>
            <bpel:sequence>
                <bpel:assign>
                    <bpel:extensionAssignOperation>
                        <trf:assign varName="requestLoggingApiGateway.request">
                            <trf:expr>
                                <expr:xqueryTransform>
                                    <expr:resource ref="SBRG_MassivePayment_Commons/Transformations/ServiceToLog"/>
                                    <expr:param name="destinationBank">
                                        <expr:path>$destinationBank</expr:path>
                                    </expr:param>
                                    <expr:param name="method">
                                        <expr:path>$protocol</expr:path>
                                    </expr:param>
                                    <expr:param name="errorFlowName">
                                        <expr:path>''</expr:path>
                                    </expr:param>
                                    <expr:param name="channel">
                                        <expr:path>$user</expr:path>
                                    </expr:param>
                                    <expr:param name="messageError">
                                        <expr:path>''</expr:path>
                                    </expr:param>
                                    <expr:param name="body">
                                        <expr:path>$requestApiGateway.request</expr:path>
                                    </expr:param>
                                    <expr:param name="version">
                                        <expr:path>$version</expr:path>
                                    </expr:param>
                                    <expr:param name="targetSystem">
                                        <expr:path>'APIGATEWAYPMSV'</expr:path>
                                    </expr:param>
                                    <expr:param name="GlobalId">
                                        <expr:path>''</expr:path>
                                    </expr:param>
                                    <expr:param name="sourceBank">
                                        <expr:path>$sourceBank</expr:path>
                                    </expr:param>
                                    <expr:param name="endpoint">
                                        <expr:path>$endPoint</expr:path>
                                    </expr:param>
                                    <expr:param name="messageType">
                                        <expr:path>'REQUEST'</expr:path>
                                    </expr:param>
                                    <expr:param name="service">
                                        <expr:path>$service</expr:path>
                                    </expr:param>
                                    <expr:param name="codeError">
                                        <expr:path>''</expr:path>
                                    </expr:param>
                                    <expr:param name="state">
                                        <expr:path>''</expr:path>
                                    </expr:param>
                                    <expr:param name="operation">
                                        <expr:path>$operation</expr:path>
                                    </expr:param>
                                    <expr:param name="value">
                                        <expr:path>''</expr:path>
                                    </expr:param>
                                    <expr:param name="user">
                                        <expr:path>$user</expr:path>
                                    </expr:param>
                                    <expr:param name="parameters">
                                        <expr:path>''</expr:path>
                                    </expr:param>
                                    <expr:param name="key">
                                        <expr:path>''</expr:path>
                                    </expr:param>
                                    <expr:param name="errorDetails">
                                        <expr:path>''</expr:path>
                                    </expr:param>
                                </expr:xqueryTransform>
                            </trf:expr>
                        </trf:assign>
                    </bpel:extensionAssignOperation>
                </bpel:assign>
                <bpel:invoke partnerLink="CallLoggingRegional" operation="SaveLogInFileSystem" inputVariable="requestLoggingApiGateway">
                    <rescon:invokeInfo>
                        <rescon:service ref="SBRG_MassivePayment_Router/PP/CallLoggingRegionalPP" xsi:type="ns2:PipelineRef"/>
                    </rescon:invokeInfo>
                </bpel:invoke>
            </bpel:sequence>
        </bpel:scope>
        <bpel:flow>
            <bpel:scope bea:name="ScopeCallOldEngine">
                <bpel:faultHandlers>
                    <bpel:catchAll>
                        <bpel:sequence>
                            <bpel:empty/>
                            <bpel:assign>
                                <bpel:extensionAssignOperation>
                                    <trf:assign varName="successIndicatorOld">
                                        <trf:expr>
                                            <expr:xqueryText>'ERROR'</expr:xqueryText>
                                        </trf:expr>
                                    </trf:assign>
                                </bpel:extensionAssignOperation>
                            </bpel:assign>
                        </bpel:sequence>
                    </bpel:catchAll>
                </bpel:faultHandlers>
                <bpel:sequence>
                    <bpel:invoke partnerLink="ConsultaLotesCliente11gBS" operation="consultaLotesCliente"
                                 inputVariable="request" outputVariable="responseOld">
                        <rescon:invokeInfo>
                            <rescon:service ref="SBRG_MassivePayment_Router/BS/ConsultaLotesCliente11gBS"
                                            xsi:type="ns0:BusinessServiceRef"/>
                        </rescon:invokeInfo>
                    </bpel:invoke>
                    <bpel:assign>
                        <bpel:extensionAssignOperation>
                            <trf:assign varName="successIndicatorOld">
                                <trf:expr>
                                    <expr:xqueryText>fn:upper-case(fn:data($responseOld.ResponseHeader/successIndicator))</expr:xqueryText>
                                </trf:expr>
                            </trf:assign>
                        </bpel:extensionAssignOperation>
                    </bpel:assign>
                    <bpel:scope bea:name="ScopeLoggingOldEngine">
                        <bpel:faultHandlers>
                            <bpel:catchAll>
                                <bpel:sequence>
                                    <bpel:empty/>
                                </bpel:sequence>
                            </bpel:catchAll>
                        </bpel:faultHandlers>
                        <bpel:sequence>
                            <bpel:assign>
                                <bpel:extensionAssignOperation>
                                    <trf:assign varName="requestLoggingOld.request">
                                        <trf:expr>
                                            <expr:xqueryTransform>
                                                <expr:resource ref="SBRG_MassivePayment_Commons/Transformations/ServiceToLog"/>
                                                <expr:param name="destinationBank">
                                                    <expr:path>$destinationBank</expr:path>
                                                </expr:param>
                                                <expr:param name="method">
                                                    <expr:path>$protocol</expr:path>
                                                </expr:param>
                                                <expr:param name="errorFlowName">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="channel">
                                                    <expr:path>$user</expr:path>
                                                </expr:param>
                                                <expr:param name="messageError">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="body">
                                                    <expr:path>&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"&gt;
   &lt;soap-env:Header xmlns:soap-env="http://schemas.xmlsoap.org/soap/envelope/"&gt;
      { $responseOld.ResponseHeader }
   &lt;/soap-env:Header&gt;
   &lt;soap-env:Body xmlns:soap-env="http://schemas.xmlsoap.org/soap/envelope/"&gt;
      { $responseOld.result }
   &lt;/soap-env:Body&gt;
&lt;/soapenv:Envelope&gt;</expr:path>
                                                </expr:param>
                                                <expr:param name="version">
                                                    <expr:path>$version</expr:path>
                                                </expr:param>
                                                <expr:param name="targetSystem">
                                                    <expr:path>'OLDENGINEPMSV'</expr:path>
                                                </expr:param>
                                                <expr:param name="GlobalId">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="sourceBank">
                                                    <expr:path>$sourceBank</expr:path>
                                                </expr:param>
                                                <expr:param name="endpoint">
                                                    <expr:path>$endPoint</expr:path>
                                                </expr:param>
                                                <expr:param name="messageType">
                                                    <expr:path>'RESPONSE'</expr:path>
                                                </expr:param>
                                                <expr:param name="service">
                                                    <expr:path>$service</expr:path>
                                                </expr:param>
                                                <expr:param name="codeError">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="state">
                                                    <expr:path>$successIndicatorOld</expr:path>
                                                </expr:param>
                                                <expr:param name="operation">
                                                    <expr:path>$operation</expr:path>
                                                </expr:param>
                                                <expr:param name="value">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="user">
                                                    <expr:path>$user</expr:path>
                                                </expr:param>
                                                <expr:param name="parameters">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="key">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="errorDetails">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                            </expr:xqueryTransform>
                                        </trf:expr>
                                    </trf:assign>
                                </bpel:extensionAssignOperation>
                            </bpel:assign>
                            <bpel:invoke partnerLink="CallLoggingRegional" portType="ns3:LoggingRegionalRestBS_ptt" operation="SaveLogInFileSystem" inputVariable="requestLoggingOld">
                                <rescon:invokeInfo>
                                    <rescon:service ref="SBRG_MassivePayment_Router/PP/CallLoggingRegionalPP" xsi:type="ns2:PipelineRef"/>
                                </rescon:invokeInfo>
                            </bpel:invoke>
                        </bpel:sequence>
                    </bpel:scope>
                </bpel:sequence>
            </bpel:scope>
            <bpel:scope bea:name="ScopeCallNewEngine">
                <bpel:faultHandlers>
                    <bpel:catchAll>
                        <bpel:sequence>
                            <bpel:empty/>
                            <bpel:assign>
                                <bpel:extensionAssignOperation>
                                    <trf:assign varName="successIndicatorNew">
                                        <trf:expr>
                                            <expr:xqueryText>'ERROR'</expr:xqueryText>
                                        </trf:expr>
                                    </trf:assign>
                                </bpel:extensionAssignOperation>
                            </bpel:assign>
                        </bpel:sequence>
                    </bpel:catchAll>
                </bpel:faultHandlers>
                <bpel:sequence>
                    <bpel:invoke partnerLink="ConsultaLotesClienteSoapPS" operation="consultaLotesCliente"
                                 inputVariable="request" outputVariable="responseNew">
                        <rescon:invokeInfo>
                            <rescon:service ref="SBRG_MassivePayment_Commons_Virtual/PS/PagosMasivos/ConsultaLotesClienteSoapPS"
                                            xsi:type="ns0:ProxyRef"/>
                        </rescon:invokeInfo>
                    </bpel:invoke>
                    <bpel:assign>
                        <bpel:extensionAssignOperation>
                            <trf:assign varName="successIndicatorNew">
                                <trf:expr>
                                    <expr:xqueryText>fn:upper-case(fn:data($responseNew.ResponseHeader/successIndicator))</expr:xqueryText>
                                </trf:expr>
                            </trf:assign>
                        </bpel:extensionAssignOperation>
                    </bpel:assign>
                    <bpel:scope bea:name="ScopeLoggingNewEngine">
                        <bpel:faultHandlers>
                            <bpel:catchAll>
                                <bpel:sequence>
                                    <bpel:empty/>
                                </bpel:sequence>
                            </bpel:catchAll>
                        </bpel:faultHandlers>
                        <bpel:sequence>
                            <bpel:assign>
                                <bpel:extensionAssignOperation>
                                    <trf:assign varName="requestLoggingNew.request">
                                        <trf:expr>
                                            <expr:xqueryTransform>
                                                <expr:resource ref="SBRG_MassivePayment_Commons/Transformations/ServiceToLog"/>
                                                <expr:param name="destinationBank">
                                                    <expr:path>$destinationBank</expr:path>
                                                </expr:param>
                                                <expr:param name="method">
                                                    <expr:path>$protocol</expr:path>
                                                </expr:param>
                                                <expr:param name="errorFlowName">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="channel">
                                                    <expr:path>$user</expr:path>
                                                </expr:param>
                                                <expr:param name="messageError">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="body">
                                                    <expr:path>&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"&gt;
   &lt;soap-env:Header xmlns:soap-env="http://schemas.xmlsoap.org/soap/envelope/"&gt;
      { $responseNew.ResponseHeader }
   &lt;/soap-env:Header&gt;
   &lt;soap-env:Body xmlns:soap-env="http://schemas.xmlsoap.org/soap/envelope/"&gt;
      { $responseNew.result }
   &lt;/soap-env:Body&gt;
&lt;/soapenv:Envelope&gt;</expr:path>
                                                </expr:param>
                                                <expr:param name="version">
                                                    <expr:path>$version</expr:path>
                                                </expr:param>
                                                <expr:param name="targetSystem">
                                                    <expr:path>'NEWENGINEPMSV'</expr:path>
                                                </expr:param>
                                                <expr:param name="GlobalId">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="sourceBank">
                                                    <expr:path>$sourceBank</expr:path>
                                                </expr:param>
                                                <expr:param name="endpoint">
                                                    <expr:path>$endPoint</expr:path>
                                                </expr:param>
                                                <expr:param name="messageType">
                                                    <expr:path>'RESPONSE'</expr:path>
                                                </expr:param>
                                                <expr:param name="service">
                                                    <expr:path>$service</expr:path>
                                                </expr:param>
                                                <expr:param name="codeError">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="state">
                                                    <expr:path>$successIndicatorNew</expr:path>
                                                </expr:param>
                                                <expr:param name="operation">
                                                    <expr:path>$operation</expr:path>
                                                </expr:param>
                                                <expr:param name="value">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="user">
                                                    <expr:path>$user</expr:path>
                                                </expr:param>
                                                <expr:param name="parameters">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="key">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="errorDetails">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                            </expr:xqueryTransform>
                                        </trf:expr>
                                    </trf:assign>
                                </bpel:extensionAssignOperation>
                            </bpel:assign>
                            <bpel:invoke partnerLink="CallLoggingRegional" portType="ns3:LoggingRegionalRestBS_ptt" operation="SaveLogInFileSystem" inputVariable="requestLoggingNew">
                                <rescon:invokeInfo>
                                    <rescon:service ref="SBRG_MassivePayment_Router/PP/CallLoggingRegionalPP" xsi:type="ns2:PipelineRef"/>
                                </rescon:invokeInfo>
                            </bpel:invoke>
                        </bpel:sequence>
                    </bpel:scope>
                </bpel:sequence>
            </bpel:scope>
            <bpel:scope bea:name="ScopeCallApiGateway">
                <bpel:faultHandlers>
                    <bpel:catchAll>
                        <bpel:sequence>
                            <bpel:empty/>
                            <bpel:assign>
                                <bpel:extensionAssignOperation>
                                    <trf:assign varName="successIndicatorApiGateway">
                                        <trf:expr>
                                            <expr:xqueryText>'ERROR'</expr:xqueryText>
                                        </trf:expr>
                                    </trf:assign>
                                </bpel:extensionAssignOperation>
                            </bpel:assign>
                        </bpel:sequence>
                    </bpel:catchAll>
                </bpel:faultHandlers>
                <bpel:sequence>
                    <bpel:invoke partnerLink="ApiPagosMasivosGatewayRestBS" operation="System" inputVariable="requestApiGateway" outputVariable="responseApiGateway">
                        <rescon:invokeInfo>
                            <rescon:service ref="SBRG_MassivePayment_Router/BS/ApiPagosMasivosGatewayRestBS" xsi:type="ns0:BusinessServiceRef"/>
                        </rescon:invokeInfo>
                    </bpel:invoke>
                    <bpel:assign>
                        <bpel:extensionAssignOperation>
                            <trf:assign varName="successIndicatorApiGateway">
                                <trf:expr>
                                    <expr:xqueryText>fn:upper-case(fn:data($responseApiGateway.reply/successIndicator))</expr:xqueryText>
                                </trf:expr>
                            </trf:assign>
                        </bpel:extensionAssignOperation>
                    </bpel:assign>
                    <bpel:scope bea:name="ScopeLoggingNewEngine">
                        <bpel:faultHandlers>
                            <bpel:catchAll>
                                <bpel:sequence>
                                    <bpel:empty/>
                                </bpel:sequence>
                            </bpel:catchAll>
                        </bpel:faultHandlers>
                        <bpel:sequence>
                            <bpel:assign>
                                <bpel:extensionAssignOperation>
                                    <trf:assign varName="requestLoggingApiGateway.request">
                                        <trf:expr>
                                            <expr:xqueryTransform>
                                                <expr:resource ref="SBRG_MassivePayment_Commons/Transformations/ServiceToLog"/>
                                                <expr:param name="destinationBank">
                                                    <expr:path>$destinationBank</expr:path>
                                                </expr:param>
                                                <expr:param name="method">
                                                    <expr:path>$protocol</expr:path>
                                                </expr:param>
                                                <expr:param name="errorFlowName">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="channel">
                                                    <expr:path>$user</expr:path>
                                                </expr:param>
                                                <expr:param name="messageError">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="body">
                                                    <expr:path>$responseApiGateway.reply</expr:path>
                                                </expr:param>
                                                <expr:param name="version">
                                                    <expr:path>$version</expr:path>
                                                </expr:param>
                                                <expr:param name="targetSystem">
                                                    <expr:path>'APIGATEWAYPMSV'</expr:path>
                                                </expr:param>
                                                <expr:param name="GlobalId">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="sourceBank">
                                                    <expr:path>$sourceBank</expr:path>
                                                </expr:param>
                                                <expr:param name="endpoint">
                                                    <expr:path>$endPoint</expr:path>
                                                </expr:param>
                                                <expr:param name="messageType">
                                                    <expr:path>'RESPONSE'</expr:path>
                                                </expr:param>
                                                <expr:param name="service">
                                                    <expr:path>$service</expr:path>
                                                </expr:param>
                                                <expr:param name="codeError">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="state">
                                                    <expr:path>$successIndicatorApiGateway</expr:path>
                                                </expr:param>
                                                <expr:param name="operation">
                                                    <expr:path>$operation</expr:path>
                                                </expr:param>
                                                <expr:param name="value">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="user">
                                                    <expr:path>$user</expr:path>
                                                </expr:param>
                                                <expr:param name="parameters">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="key">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="errorDetails">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                            </expr:xqueryTransform>
                                        </trf:expr>
                                    </trf:assign>
                                </bpel:extensionAssignOperation>
                            </bpel:assign>
                            <bpel:invoke partnerLink="CallLoggingRegional" portType="ns3:LoggingRegionalRestBS_ptt" operation="SaveLogInFileSystem" inputVariable="requestLoggingApiGateway">
                                <rescon:invokeInfo>
                                    <rescon:service ref="SBRG_MassivePayment_Router/PP/CallLoggingRegionalPP" xsi:type="ns2:PipelineRef"/>
                                </rescon:invokeInfo>
                            </bpel:invoke>
                        </bpel:sequence>
                    </bpel:scope>
                </bpel:sequence>
            </bpel:scope>
        </bpel:flow>
        <bpel:scope bea:name="ScopeOtrasVariables">
            <bpel:faultHandlers>
                <bpel:catchAll>
                    <bpel:sequence>
                        <bpel:empty/>
                        <bpel:assign>
                            <bpel:extensionAssignOperation>
                                <trf:assign varName="response.ResponseHeader">
                                    <trf:expr>
                                        <expr:xqueryText>&lt;ns2:ResponseHeader xmlns:ns2="http://www.ficohsa.com.hn/middleware.services/autType"&gt;
      &lt;messageId&gt;6&lt;/messageId&gt;
      &lt;successIndicator&gt;ERROR&lt;/successIndicator&gt;
      &lt;messages&gt;CallBothEnginesGetCustomerBatchSJ-ScopeOtrasVariables&lt;/messages&gt;
    &lt;/ns2:ResponseHeader&gt;</expr:xqueryText>
                                    </trf:expr>
                                </trf:assign>
                            </bpel:extensionAssignOperation>
                            <bpel:extensionAssignOperation>
                                <trf:assign varName="response.result">
                                    <trf:expr>
                                        <expr:xqueryText>&lt;pag:consultaLotesClienteResponse xmlns:pag="http://www.ficohsa.com.hn/middleware.services/pagosMasivosTypes"/&gt;</expr:xqueryText>
                                    </trf:expr>
                                </trf:assign>
                            </bpel:extensionAssignOperation>
                        </bpel:assign>
                        <bpel:reply operation="consultaLotesCliente" partnerLink="CallBothEnginesGetBatchStatusSJ"
                                    variable="response"/>
                        <bpel:exit/>
                    </bpel:sequence>
                </bpel:catchAll>
            </bpel:faultHandlers>
            <bpel:sequence>
                <bpel:scope>
                    <bpel:faultHandlers>
                        <bpel:catchAll>
                            <bpel:sequence>
                                <bpel:empty/>
                                <bpel:assign>
                                    <bpel:extensionAssignOperation>
                                        <trf:assign varName="system">
                                            <trf:expr>
                                                <expr:xqueryText>'OLD'</expr:xqueryText>
                                            </trf:expr>
                                        </trf:assign>
                                    </bpel:extensionAssignOperation>
                                </bpel:assign>
                            </bpel:sequence>
                        </bpel:catchAll>
                    </bpel:faultHandlers>
                    <bpel:sequence>
                        <bpel:assign>
                            <bpel:extensionAssignOperation>
                                <trf:assign varName="system">
                                    <trf:expr>
                                        <expr:xqueryText>fn:data($responseApiGateway.reply/system)</expr:xqueryText>
                                    </trf:expr>
                                </trf:assign>
                            </bpel:extensionAssignOperation>
                        </bpel:assign>
                    </bpel:sequence>
                </bpel:scope>
                <bpel:scope>
                    <bpel:faultHandlers>
                        <bpel:catchAll>
                            <bpel:sequence>
                                <bpel:empty/>
                                <bpel:assign>
                                    <bpel:extensionAssignOperation>
                                        <trf:assign varName="totalBatchesOld">
                                            <trf:expr>
                                                <expr:xqueryText>0</expr:xqueryText>
                                            </trf:expr>
                                        </trf:assign>
                                    </bpel:extensionAssignOperation>
                                </bpel:assign>
                            </bpel:sequence>
                        </bpel:catchAll>
                    </bpel:faultHandlers>
                    <bpel:sequence>
                        <bpel:assign>
                            <bpel:extensionAssignOperation>
                                <trf:assign varName="totalBatchesOld">
                                    <trf:expr>
                                        <expr:xqueryText>fn:count($responseOld.result/BATCHES/BATCH[BANK_BATCH_ID != ''])</expr:xqueryText>
                                    </trf:expr>
                                </trf:assign>
                            </bpel:extensionAssignOperation>
                        </bpel:assign>
                    </bpel:sequence>
                </bpel:scope>
                <bpel:scope>
                    <bpel:faultHandlers>
                        <bpel:catchAll>
                            <bpel:sequence>
                                <bpel:empty/>
                                <bpel:assign>
                                    <bpel:extensionAssignOperation>
                                        <trf:assign varName="totalBatchesNew">
                                            <trf:expr>
                                                <expr:xqueryText>0</expr:xqueryText>
                                            </trf:expr>
                                        </trf:assign>
                                    </bpel:extensionAssignOperation>
                                </bpel:assign>
                            </bpel:sequence>
                        </bpel:catchAll>
                    </bpel:faultHandlers>
                    <bpel:sequence>
                        <bpel:assign>
                            <bpel:extensionAssignOperation>
                                <trf:assign varName="totalBatchesNew">
                                    <trf:expr>
                                        <expr:xqueryText>fn:count($responseNew.result/BATCHES/BATCH[BANK_BATCH_ID != ''])</expr:xqueryText>
                                    </trf:expr>
                                </trf:assign>
                            </bpel:extensionAssignOperation>
                        </bpel:assign>
                    </bpel:sequence>
                </bpel:scope>
                <bpel:assign>
                    <bpel:extensionAssignOperation>
                        <trf:assign varName="batchesToInsert">
                            <trf:expr>
                                <expr:xqueryText>&lt;BATCHES&gt;&lt;/BATCHES&gt;</expr:xqueryText>
                            </trf:expr>
                        </trf:assign>
                    </bpel:extensionAssignOperation>
                </bpel:assign>
            </bpel:sequence>
        </bpel:scope>
        <bpel:scope bea:name="ScopeIf">
            <bpel:faultHandlers>
                <bpel:catchAll>
                    <bpel:sequence>
                        <bpel:empty/>
                        <bpel:assign>
                            <bpel:extensionAssignOperation>
                                <trf:assign varName="response.ResponseHeader">
                                    <trf:expr>
                                        <expr:xqueryText>&lt;ns2:ResponseHeader xmlns:ns2="http://www.ficohsa.com.hn/middleware.services/autType"&gt;
      &lt;messageId&gt;7&lt;/messageId&gt;
      &lt;successIndicator&gt;ERROR&lt;/successIndicator&gt;
      &lt;messages&gt;CallBothEnginesGetCustomerBatchSJ-ScopeIf&lt;/messages&gt;
    &lt;/ns2:ResponseHeader&gt;</expr:xqueryText>
                                    </trf:expr>
                                </trf:assign>
                            </bpel:extensionAssignOperation>
                            <bpel:extensionAssignOperation>
                                <trf:assign varName="response.result">
                                    <trf:expr>
                                        <expr:xqueryText>&lt;pag:consultaLotesClienteResponse xmlns:pag="http://www.ficohsa.com.hn/middleware.services/pagosMasivosTypes"/&gt;</expr:xqueryText>
                                    </trf:expr>
                                </trf:assign>
                            </bpel:extensionAssignOperation>
                        </bpel:assign>
                        <bpel:reply operation="consultaLotesCliente" partnerLink="CallBothEnginesGetBatchStatusSJ"
                                    variable="response"/>
                        <bpel:exit/>
                    </bpel:sequence>
                </bpel:catchAll>
            </bpel:faultHandlers>
            <bpel:sequence>
                <bpel:if>
                    <bpel:condition>$successIndicatorOld = 'SUCCESS' and 
$successIndicatorNew = 'SUCCESS' and 
$totalBatchesOld &gt; 0 and 
$totalBatchesNew &gt; 0</bpel:condition>
                    <bpel:sequence>
                        <bpel:empty/>
                        <bpel:if>
                            <bpel:condition>$system='OLD'</bpel:condition>
                            <bpel:sequence>
                                <bpel:empty/>
                                <bpel:assign>
                                    <bpel:extensionAssignOperation>
                                        <trf:assign varName="response.ResponseHeader">
                                            <trf:expr>
                                                <expr:xqueryText>$responseOld.ResponseHeader</expr:xqueryText>
                                            </trf:expr>
                                        </trf:assign>
                                    </bpel:extensionAssignOperation>
                                    <bpel:extensionAssignOperation>
                                        <trf:assign varName="batchesToInsert">
                                            <trf:expr>
                                                <expr:xqueryText>&lt;BATCHES&gt;
    {
        for $batch in $responseNew.result/BATCHES/BATCH
        return
        element BATCH
        {
            element BANK_BATCH_ID { data($batch/BANK_BATCH_ID) },
            element CUSTOMER_BATCH_ID { data($batch/CUSTOMER_BATCH_ID) },
            element TYPE { data($batch/TYPE) },
            element TYPE_DESC { data($batch/TYPE_DESC) },
            element UPLOAD_DATE { data($batch/UPLOAD_DATE) },
            element APPLICATION_DATE { data($batch/APPLICATION_DATE) },
            element NUMBER_OF_TRANSACTIONS { data($batch/NUMBER_OF_TRANSACTIONS) },
            element NUMBER_OF_TRANSACTIONS_SUCCESS { data($batch/NUMBER_OF_TRANSACTIONS_SUCCESS) },
            element NUMBER_OF_TRANSACTIONS_ERROR { data($batch/NUMBER_OF_TRANSACTIONS_ERROR) },
            element TOTAL_AMOUNT { data($batch/TOTAL_AMOUNT) },
            element TOTAL_AMOUNT_ERROR { data($batch/TOTAL_AMOUNT_ERROR) },
            element STATUS { data($batch/STATUS) },
            element STATUS_DESC { data($batch/STATUS_DESC) }
        }
    }
&lt;/BATCHES&gt;</expr:xqueryText>
                                            </trf:expr>
                                        </trf:assign>
                                    </bpel:extensionAssignOperation>
                                    <bpel:extensionAssignOperation>
                                        <trf:insert varName="responseOld.result">
                                            <trf:location>
                                                <expr:xpathText>./BATCHES</expr:xpathText>
                                            </trf:location>
                                            <trf:where>last-child</trf:where>
                                            <trf:expr>
                                                <expr:xqueryText>$batchesToInsert//BATCH</expr:xqueryText>
                                            </trf:expr>
                                        </trf:insert>
                                    </bpel:extensionAssignOperation>
                                    <bpel:extensionAssignOperation>
                                        <trf:assign varName="response.result">
                                            <trf:expr>
                                                <expr:xqueryText>$responseOld.result</expr:xqueryText>
                                            </trf:expr>
                                        </trf:assign>
                                    </bpel:extensionAssignOperation>
                                </bpel:assign>
                            </bpel:sequence>
                            <bpel:else>
                                <bpel:sequence>
                                    <bpel:empty/>
                                    <bpel:assign>
                                        <bpel:extensionAssignOperation>
                                            <trf:assign varName="response.ResponseHeader">
                                                <trf:expr>
                                                    <expr:xqueryText>$responseNew.ResponseHeader</expr:xqueryText>
                                                </trf:expr>
                                            </trf:assign>
                                        </bpel:extensionAssignOperation>
                                        <bpel:extensionAssignOperation>
                                            <trf:assign varName="batchesToInsert">
                                                <trf:expr>
                                                    <expr:xqueryText>&lt;BATCHES&gt;
    {
        for $batch in $responseOld.result/BATCHES/BATCH
        return
        element BATCH
        {
            element BANK_BATCH_ID { data($batch/BANK_BATCH_ID) },
            element CUSTOMER_BATCH_ID { data($batch/CUSTOMER_BATCH_ID) },
            element TYPE { data($batch/TYPE) },
            element TYPE_DESC { data($batch/TYPE_DESC) },
            element UPLOAD_DATE { data($batch/UPLOAD_DATE) },
            element APPLICATION_DATE { data($batch/APPLICATION_DATE) },
            element NUMBER_OF_TRANSACTIONS { data($batch/NUMBER_OF_TRANSACTIONS) },
            element NUMBER_OF_TRANSACTIONS_SUCCESS { data($batch/NUMBER_OF_TRANSACTIONS_SUCCESS) },
            element NUMBER_OF_TRANSACTIONS_ERROR { data($batch/NUMBER_OF_TRANSACTIONS_ERROR) },
            element TOTAL_AMOUNT { data($batch/TOTAL_AMOUNT) },
            element TOTAL_AMOUNT_ERROR { data($batch/TOTAL_AMOUNT_ERROR) },
            element STATUS { data($batch/STATUS) },
            element STATUS_DESC { data($batch/STATUS_DESC) }
        }
    }
&lt;/BATCHES&gt;</expr:xqueryText>
                                                </trf:expr>
                                            </trf:assign>
                                        </bpel:extensionAssignOperation>
                                        <bpel:extensionAssignOperation>
                                            <trf:insert varName="responseNew.result">
                                                <trf:location>
                                                    <expr:xpathText>./BATCHES</expr:xpathText>
                                                </trf:location>
                                                <trf:where>first-child</trf:where>
                                                <trf:expr>
                                                    <expr:xqueryText>$batchesToInsert//BATCH</expr:xqueryText>
                                                </trf:expr>
                                            </trf:insert>
                                        </bpel:extensionAssignOperation>
                                        <bpel:extensionAssignOperation>
                                            <trf:assign varName="response.result">
                                                <trf:expr>
                                                    <expr:xqueryText>$responseNew.result</expr:xqueryText>
                                                </trf:expr>
                                            </trf:assign>
                                        </bpel:extensionAssignOperation>
                                    </bpel:assign>
                                </bpel:sequence>
                            </bpel:else>
                        </bpel:if>
                    </bpel:sequence>
                    <bpel:elseif>
                        <bpel:condition>$successIndicatorOld='SUCCESS' and 
$totalBatchesOld &gt; 0</bpel:condition>
                        <bpel:sequence>
                            <bpel:empty/>
                            <bpel:assign>
                                <bpel:extensionAssignOperation>
                                    <trf:assign varName="response.ResponseHeader">
                                        <trf:expr>
                                            <expr:xqueryText>$responseOld.ResponseHeader</expr:xqueryText>
                                        </trf:expr>
                                    </trf:assign>
                                </bpel:extensionAssignOperation>
                                <bpel:extensionAssignOperation>
                                    <trf:assign varName="response.result">
                                        <trf:expr>
                                            <expr:xqueryText>$responseOld.result</expr:xqueryText>
                                        </trf:expr>
                                    </trf:assign>
                                </bpel:extensionAssignOperation>
                            </bpel:assign>
                        </bpel:sequence>
                    </bpel:elseif>
                    <bpel:elseif>
                        <bpel:condition>$successIndicatorNew='SUCCESS' and 
$totalBatchesNew &gt; 0</bpel:condition>
                        <bpel:sequence>
                            <bpel:empty/>
                            <bpel:assign>
                                <bpel:extensionAssignOperation>
                                    <trf:assign varName="response.ResponseHeader">
                                        <trf:expr>
                                            <expr:xqueryText>$responseNew.ResponseHeader</expr:xqueryText>
                                        </trf:expr>
                                    </trf:assign>
                                </bpel:extensionAssignOperation>
                                <bpel:extensionAssignOperation>
                                    <trf:assign varName="response.result">
                                        <trf:expr>
                                            <expr:xqueryText>$responseNew.result</expr:xqueryText>
                                        </trf:expr>
                                    </trf:assign>
                                </bpel:extensionAssignOperation>
                            </bpel:assign>
                        </bpel:sequence>
                    </bpel:elseif>
                    <bpel:elseif>
                        <bpel:condition>$system='OLD'</bpel:condition>
                        <bpel:sequence>
                            <bpel:empty/>
                            <bpel:assign>
                                <bpel:extensionAssignOperation>
                                    <trf:assign varName="response.ResponseHeader">
                                        <trf:expr>
                                            <expr:xqueryText>$responseOld.ResponseHeader</expr:xqueryText>
                                        </trf:expr>
                                    </trf:assign>
                                </bpel:extensionAssignOperation>
                                <bpel:extensionAssignOperation>
                                    <trf:assign varName="response.result">
                                        <trf:expr>
                                            <expr:xqueryText>$responseOld.result</expr:xqueryText>
                                        </trf:expr>
                                    </trf:assign>
                                </bpel:extensionAssignOperation>
                            </bpel:assign>
                        </bpel:sequence>
                    </bpel:elseif>
                    <bpel:else>
                        <bpel:sequence>
                            <bpel:empty/>
                            <bpel:assign>
                                <bpel:extensionAssignOperation>
                                    <trf:assign varName="response.ResponseHeader">
                                        <trf:expr>
                                            <expr:xqueryText>$responseNew.ResponseHeader</expr:xqueryText>
                                        </trf:expr>
                                    </trf:assign>
                                </bpel:extensionAssignOperation>
                                <bpel:extensionAssignOperation>
                                    <trf:assign varName="response.result">
                                        <trf:expr>
                                            <expr:xqueryText>$responseNew.result</expr:xqueryText>
                                        </trf:expr>
                                    </trf:assign>
                                </bpel:extensionAssignOperation>
                            </bpel:assign>
                        </bpel:sequence>
                    </bpel:else>
                </bpel:if>
            </bpel:sequence>
        </bpel:scope>
        <bpel:scope bea:name="ScopeLoggingInformation">
            <bpel:faultHandlers>
                <bpel:catchAll>
                    <bpel:sequence>
                        <bpel:empty/>
                    </bpel:sequence>
                </bpel:catchAll>
            </bpel:faultHandlers>
            <bpel:sequence>
                <bpel:assign>
                    <bpel:extensionAssignOperation>
                        <trf:assign varName="requestLoggingInformation.request">
                            <trf:expr>
                                <expr:xqueryTransform>
                                    <expr:resource ref="SBRG_MassivePayment_Commons/Transformations/ServiceToLog"/>
                                    <expr:param name="destinationBank">
                                        <expr:path>$destinationBank</expr:path>
                                    </expr:param>
                                    <expr:param name="method">
                                        <expr:path>$protocol</expr:path>
                                    </expr:param>
                                    <expr:param name="errorFlowName">
                                        <expr:path>''</expr:path>
                                    </expr:param>
                                    <expr:param name="channel">
                                        <expr:path>$user</expr:path>
                                    </expr:param>
                                    <expr:param name="messageError">
                                        <expr:path>''</expr:path>
                                    </expr:param>
                                    <expr:param name="body">
                                        <expr:path>&lt;Informacion&gt;
    &lt;Variables&gt;
        &lt;successIndicatorOld&gt;{$successIndicatorOld}&lt;/successIndicatorOld&gt;
        &lt;successIndicatorNew&gt;{$successIndicatorNew}&lt;/successIndicatorNew&gt;
        &lt;successIndicatorApiGateway&gt;{$successIndicatorApiGateway}&lt;/successIndicatorApiGateway&gt;
        &lt;system&gt;{$system}&lt;/system&gt;
        &lt;totalBatchesOld&gt;{$totalBatchesOld}&lt;/totalBatchesOld&gt;
        &lt;totalBatchesNew&gt;{$totalBatchesNew}&lt;/totalBatchesNew&gt;
        &lt;batchesToInsert&gt;{$batchesToInsert}&lt;/batchesToInsert&gt;
    &lt;/Variables&gt;
    &lt;RespuestaMotorViejoHeader&gt;
        {$responseOld.ResponseHeader}
    &lt;/RespuestaMotorViejoHeader&gt;
    &lt;RespuestaMotorViejoBody&gt;
        {$responseOld.result}
    &lt;/RespuestaMotorViejoBody&gt;
    &lt;RespuestaMotorNuevoHeader&gt;
        {$responseNew.ResponseHeader}
    &lt;/RespuestaMotorNuevoHeader&gt;
    &lt;RespuestaMotorNuevoBody&gt;
        {$responseNew.result}
    &lt;/RespuestaMotorNuevoBody&gt;
    &lt;RespuestaApiGateway&gt;
        {$responseApiGateway.reply}
    &lt;/RespuestaApiGateway&gt;
&lt;/Informacion&gt;</expr:path>
                                    </expr:param>
                                    <expr:param name="version">
                                        <expr:path>$version</expr:path>
                                    </expr:param>
                                    <expr:param name="targetSystem">
                                        <expr:path>'OSB'</expr:path>
                                    </expr:param>
                                    <expr:param name="GlobalId">
                                        <expr:path>''</expr:path>
                                    </expr:param>
                                    <expr:param name="sourceBank">
                                        <expr:path>$sourceBank</expr:path>
                                    </expr:param>
                                    <expr:param name="endpoint">
                                        <expr:path>$endPoint</expr:path>
                                    </expr:param>
                                    <expr:param name="messageType">
                                        <expr:path>'RESPONSE'</expr:path>
                                    </expr:param>
                                    <expr:param name="service">
                                        <expr:path>$service</expr:path>
                                    </expr:param>
                                    <expr:param name="codeError">
                                        <expr:path>''</expr:path>
                                    </expr:param>
                                    <expr:param name="state">
                                        <expr:path>''</expr:path>
                                    </expr:param>
                                    <expr:param name="operation">
                                        <expr:path>$operation</expr:path>
                                    </expr:param>
                                    <expr:param name="value">
                                        <expr:path>''</expr:path>
                                    </expr:param>
                                    <expr:param name="user">
                                        <expr:path>$user</expr:path>
                                    </expr:param>
                                    <expr:param name="parameters">
                                        <expr:path>''</expr:path>
                                    </expr:param>
                                    <expr:param name="key">
                                        <expr:path>''</expr:path>
                                    </expr:param>
                                    <expr:param name="errorDetails">
                                        <expr:path>''</expr:path>
                                    </expr:param>
                                </expr:xqueryTransform>
                            </trf:expr>
                        </trf:assign>
                    </bpel:extensionAssignOperation>
                </bpel:assign>
                <bpel:invoke inputVariable="requestLoggingInformation" operation="SaveLogInFileSystem"
                             portType="ns3:LoggingRegionalRestBS_ptt" partnerLink="CallLoggingRegional">
                    <rescon:invokeInfo>
                        <rescon:service ref="SBRG_MassivePayment_Router/PP/CallLoggingRegionalPP"
                                        xsi:type="ns2:PipelineRef"/>
                    </rescon:invokeInfo>
                </bpel:invoke>
            </bpel:sequence>
        </bpel:scope>
        <bpel:reply partnerLink="CallBothEnginesGetBatchStatusSJ" operation="consultaLotesCliente" variable="response"/>
    </bpel:sequence>
</bpel:process>