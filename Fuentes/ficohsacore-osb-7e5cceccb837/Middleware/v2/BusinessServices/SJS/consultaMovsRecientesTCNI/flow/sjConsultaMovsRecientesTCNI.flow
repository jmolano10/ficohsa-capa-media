<bpel:process name="sjConsultaMovsRecientesTC" targetNamespace="http://www.example.com/flow/Middleware/v2/BusinessServices/SJS/consultaMovsRecientesTC/flow/sjConsultaMovsRecientesTC" bea:name="sjConsultaMovsRecientesTC" xmlns:tns="http://www.example.com/flow/Middleware/v2/BusinessServices/SJS/consultaMovsRecientesTC/flow/sjConsultaMovsRecientesTC" xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable" xmlns:rescon="http://www.bea.com/alsb/flow/resources/config" xmlns:bea="http://www.bea.com/bpel/ui/extensions" xmlns:ext="http://www.bea.com/bpel/extensions" xmlns:expr="http://www.bea.com/wli/sb/stages/config" xmlns:trf="http://www.bea.com/wli/sb/stages/transform/config" xmlns:bind="http://www.ficohsa.com.hn/middleware.services/sjConsultaMovsRecientesTCNI/" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:ns1="http://impl.service.srvaplcobistarjetacredito.ecobis.cobiscorp/" xmlns:enti="http://dto.srvaplcobisentidades.ecobis.cobiscorp" xmlns:sjns="http://www.ficohsa.com.hn/middleware.services/sjConsultaMovsRecientesTCNI" xmlns:tarj="http://service.srvaplcobistarjetacredito.ecobis.cobiscorp" xmlns:dto2="http://dto2.sdf.cts.cobis.cobiscorp.com" xmlns:ns0="http://www.bea.com/wli/sb/stages/logging/config">
    <bpel:partnerLinks>
        <bpel:partnerLink name="sjConsultaMovsRecientesTC" partnerLinkType="tns:sjConsultaMovsRecientesTC" myRole="sjConsultaMovsRecientesTC">
	       </bpel:partnerLink>
	   <bpel:partnerLink name="tarjetaCredito" partnerLinkType="tns:tarjetaCredito_plnkType" partnerRole="tarjetaCredito_PartnerRole">
	   </bpel:partnerLink></bpel:partnerLinks>

	   <bpel:variables>
        <bpel:variable name="request" messageType="bind:sjConsultaMovsRecientesTCNIRequest">
	       </bpel:variable>
	       <bpel:variable name="response" messageType="bind:sjConsultaMovsRecientesTCNIResponse">
	       </bpel:variable>
    
    
    
    <bpel:variable name="flag" type="xsd:string"/>
    <bpel:variable name="numeroSecuencia1" type="xsd:int"/>
    <bpel:variable name="numeroSecuencia2" type="xsd:int"/>
    <bpel:variable name="reqConsultaMovsRecientesTC" messageType="ns1:MsjOpConsultaMovimientosTarjetaCreditoSolicitud">
    </bpel:variable>
    <bpel:variable name="respConsultaMovsRecientesTC" messageType="ns1:MsjOpConsultaMovimientosTarjetaCreditoRespuesta">
    </bpel:variable>
    <bpel:variable name="replaceHeader" type="xsd:int"/></bpel:variables>

    <bpel:sequence>
        <bpel:receive partnerLink="sjConsultaMovsRecientesTC" operation="ConsultaMovimientosTCNI" variable="request" createInstance="yes">
	           <rescon:receiveInfo>
                <rescon:wsdl ref="Middleware/v2/BusinessServices/SJS/consultaMovsRecientesTCNI/wsdl/sjConsultaMovsRecientesTCNI" binding="bind:sjConsultaMovsRecientesTCNIPSSOAP"/>
            </rescon:receiveInfo>
        </bpel:receive>
        <bpel:scope bea:name="PrepararSalida">
        	<bpel:sequence>
        		<bpel:assign>
        			<bpel:extensionAssignOperation>
        				<trf:assign varName="response.outputParameters">
        					<trf:expr>
        						<expr:xqueryText>&lt;outputParameters>
	&lt;successIndicator>Success&lt;/successIndicator>
	&lt;MOVS/>
&lt;/outputParameters></expr:xqueryText></trf:expr></trf:assign></bpel:extensionAssignOperation></bpel:assign></bpel:sequence>
        </bpel:scope>
        
        <bpel:scope bea:name="InitVariables">
        	<bpel:sequence>
        		<bpel:assign>
        			
        		
        		<bpel:extensionAssignOperation>
		<trf:assign varName="flag">
			<trf:expr>
				<expr:xqueryText>fn:string('Y')</expr:xqueryText></trf:expr></trf:assign>
        		</bpel:extensionAssignOperation>
        		<bpel:extensionAssignOperation>
        			<trf:assign varName="numeroSecuencia1">
        				<trf:expr>
        					<expr:xqueryText>xs:int(0)</expr:xqueryText></trf:expr></trf:assign>
        		</bpel:extensionAssignOperation>
        		<bpel:extensionAssignOperation>
        			<trf:assign varName="numeroSecuencia2">
        				<trf:expr>
        					<expr:xqueryText>xs:int(0)</expr:xqueryText></trf:expr></trf:assign>
        		</bpel:extensionAssignOperation>
        		<bpel:extensionAssignOperation>
        			<trf:assign varName="replaceHeader">
        				<trf:expr>
        					<expr:xqueryText>xs:int(0)</expr:xqueryText></trf:expr></trf:assign>
        		</bpel:extensionAssignOperation></bpel:assign></bpel:sequence>
        </bpel:scope>
        <bpel:while>
        	<bpel:condition>$flag = 'Y'</bpel:condition>
        	<bpel:sequence>
        		<bpel:scope>
        			
        			
        			<bpel:variables>
        				<bpel:variable name="resultSet" type="xsd:anyType">
        				</bpel:variable></bpel:variables>
        			<bpel:faultHandlers>
        				
        				
        				<bpel:catch faultName="tns:noDataFound">
        					<bpel:sequence>
        						<bpel:empty/>
        					<bpel:assign bea:name="NoDataFound">
		<bpel:extensionAssignOperation>
			<trf:replace contents-only="false" varName="response.outputParameters">
				<trf:expr>
					<expr:xqueryText><![CDATA[<outputParameters>
	<SUCCESS_INDICATOR>NO RECORDS</SUCCESS_INDICATOR>
	<ERROR_MESSAGE>Error</ERROR_MESSAGE>
	<MOVS/>
</outputParameters>]]></expr:xqueryText></trf:expr></trf:replace></bpel:extensionAssignOperation>
		<bpel:extensionAssignOperation>
			<bpel:documentation/>
			<trf:assign varName="flag">
				<trf:expr>
					<expr:xqueryText>fn:string('N')</expr:xqueryText></trf:expr></trf:assign></bpel:extensionAssignOperation></bpel:assign></bpel:sequence>
        				</bpel:catch>
        				<bpel:catchAll>
        					<bpel:sequence>
        						<bpel:empty/>
        					<bpel:assign bea:name="ErrorPeticionCTS">
		
        					
	<bpel:extensionAssignOperation>
		<trf:replace contents-only="false" varName="response.outputParameters">
			<trf:expr>
				<expr:xqueryText><![CDATA[<outputParameters>
	<SUCCESS_INDICATOR>CTSError</SUCCESS_INDICATOR>
	<ERROR_MESSAGE>Error</ERROR_MESSAGE>
	<MOVS/>
</outputParameters>]]></expr:xqueryText></trf:expr></trf:replace>
	</bpel:extensionAssignOperation>
	<bpel:extensionAssignOperation>
		<bpel:documentation/>
		<trf:assign varName="flag">
			<trf:expr>
				<expr:xqueryText>fn:string('N')</expr:xqueryText></trf:expr></trf:assign>
        					</bpel:extensionAssignOperation></bpel:assign>
        					
        					</bpel:sequence>
        				</bpel:catchAll></bpel:faultHandlers>
        			<bpel:sequence>
        				<bpel:assign>
        					<bpel:extensionAssignOperation>
        						<trf:assign varName="reqConsultaMovsRecientesTC.parameters">
        							<trf:expr>
        								<expr:xqueryTransform>
        									<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaMovsRecientesTCNI/xq/consultaMovsRecientesTCNIIn"/>
        									
        									
        									
        									
        									
        									
        									
        									<expr:param name="int1">
        										<expr:path>$numeroSecuencia1</expr:path></expr:param>
        									<expr:param name="sjConsultaMovsRecientesTCNIRequest">
        										<expr:path>$request.inputParameters</expr:path></expr:param>
        									<expr:param name="int2">
        										<expr:path>$numeroSecuencia2</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign></bpel:extensionAssignOperation></bpel:assign>
        				
        				<bpel:invoke outputVariable="respConsultaMovsRecientesTC" partnerLink="tarjetaCredito" inputVariable="reqConsultaMovsRecientesTC" operation="OpConsultaMovimientosTarjetaCredito">
        					<rescon:invokeInfo>
        						<rescon:service isProxy="false" ref="Middleware/v2/BusinessServices/CTS/tarjetaCredito/biz/tarjetaCredito"/></rescon:invokeInfo></bpel:invoke>
        				
        				
        				<bpel:scope bea:name="ReasignVariables">
        					<bpel:sequence>
        						
        						
        						
        						<bpel:if>
        							<bpel:condition>(string($respConsultaMovsRecientesTC.parameters/enti:contextoRespuesta/enti:codTipoRespuesta/text()) != '0'
or
count($respConsultaMovsRecientesTC.parameters/enti:tarjetaCredito/enti:valNombreTitular) = 0
or
count($respConsultaMovsRecientesTC.parameters/enti:transaccionTarjetaCredito/enti:valFechaTransaccion) = 0)</bpel:condition>
        							<bpel:sequence>
        								<bpel:empty/>
        								
        								<bpel:if>
        									<bpel:condition>string($respConsultaMovsRecientesTC.parameters/dto2:success/text()) = 'false'</bpel:condition>
        									<bpel:sequence>
        										<bpel:empty/>
        									<bpel:throw faultName="tns:userFault" bea:name="ErrorPeticionCTS"/></bpel:sequence>
        									
        									<bpel:elseif>
        										<bpel:condition>(count($respConsultaMovsRecientesTC.parameters/enti:tarjetaCredito/enti:valNombreTitular) = 0
or
count($respConsultaMovsRecientesTC.parameters/enti:transaccionTarjetaCredito/enti:valFechaTransaccion) = 0)</bpel:condition>
        										<bpel:sequence>
        											<bpel:empty/>
        										<bpel:throw faultName="tns:noDataFound" bea:name="NoDataFound"/></bpel:sequence>
        									</bpel:elseif>
        									<bpel:else>
        										<bpel:sequence>
        											<bpel:empty/>
        										<bpel:throw faultName="tns:userFault" bea:name="ErrorPeticionCTS"/></bpel:sequence>
        									</bpel:else>
        								</bpel:if>
        								
        								
        								
        								
        								</bpel:sequence>
        							<bpel:else>
        								<bpel:sequence>
        									<bpel:empty/>
        									
        									<bpel:if>
        										<bpel:condition>$replaceHeader = 0</bpel:condition>
        										<bpel:sequence>
        											<bpel:empty/>
        										<bpel:assign>
		<bpel:extensionAssignOperation>
			<bpel:documentation/>
			<trf:replace contents-only="false" varName="response.outputParameters">
				<trf:expr>
					<expr:xqueryTransform>
						<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaMovsRecientesTCNI/xq/consultaMovsRecientesTCNIGeneralOut"/>
						<expr:param name="opConsultaMovimientosTarjetaCreditoRespuesta">
							<expr:path>$respConsultaMovsRecientesTC.parameters</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:replace>
		</bpel:extensionAssignOperation>
        										<bpel:extensionAssignOperation>
		<bpel:documentation/>
		<trf:assign varName="replaceHeader">
			<trf:expr>
				<expr:xqueryText>xs:int(1)</expr:xqueryText></trf:expr></trf:assign>
        										</bpel:extensionAssignOperation></bpel:assign></bpel:sequence>
        										<bpel:else>
        											<bpel:sequence>
        												<bpel:empty/>
        											</bpel:sequence>
        										</bpel:else>
        									</bpel:if>
        									
        									<bpel:assign>
        										
        										
        										
        									<bpel:extensionAssignOperation>
		<trf:assign varName="flag">
			<trf:expr>
				<expr:xqueryText>let $bandera1 := $respConsultaMovsRecientesTC.parameters/enti:tarjetaCredito/enti:valBanderaTransaccion
let $bandera2 := $respConsultaMovsRecientesTC.parameters/enti:tarjetaCredito/enti:valBanderaTransaccion2
return        		
	if ($bandera1 = 'Y' or $bandera2 = 'Y') then(
		"Y"
	)
	else("N")</expr:xqueryText></trf:expr></trf:assign>
        									</bpel:extensionAssignOperation>
        									<bpel:extensionAssignOperation>
        										<trf:assign varName="numeroSecuencia1">
        											<trf:expr>
        												<expr:xqueryText>let $bandera1 := $respConsultaMovsRecientesTC.parameters/enti:tarjetaCredito/enti:valBanderaTransaccion
return        		
	if ($bandera1 = 'Y') then(
		xs:int($respConsultaMovsRecientesTC.parameters/enti:tarjetaCredito/enti:valNumeroSecuencia) + 1
			)
	else(
		-1
			)</expr:xqueryText></trf:expr></trf:assign>
        									</bpel:extensionAssignOperation>
        									<bpel:extensionAssignOperation>
        										<trf:assign varName="numeroSecuencia2">
        											<trf:expr>
        												<expr:xqueryText>let $bandera2 := $respConsultaMovsRecientesTC.parameters/enti:tarjetaCredito/enti:valBanderaTransaccion2
return        		
	if ($bandera2 = 'Y') then(
		xs:int($respConsultaMovsRecientesTC.parameters/enti:tarjetaCredito/enti:valNumeroSecuencia2) + 1
			)
	else(
		-1
			)</expr:xqueryText></trf:expr></trf:assign>
        									</bpel:extensionAssignOperation>
        									
        									<bpel:extensionAssignOperation>
        										<bpel:documentation/>
        										<trf:assign varName="resultSet">
        											<trf:expr>
        												
        												<expr:xqueryTransform>
	<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaMovsRecientesTCNI/xq/consultaMovsRecientesTCNIOut"/>
	<expr:param name="opConsultaMovimientosTarjetaCreditoRespuesta">
		<expr:path>$respConsultaMovsRecientesTC.parameters</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign>
        									</bpel:extensionAssignOperation>
        									<bpel:extensionAssignOperation>
        										<bpel:documentation/>
        										<trf:insert varName="response.outputParameters">
        											<trf:location>
        												<expr:xpathText>./MOVS</expr:xpathText></trf:location>
        											<trf:where>last-child</trf:where>
        											<trf:expr>
        												<expr:xqueryText>$resultSet/MOV</expr:xqueryText></trf:expr></trf:insert>
        									</bpel:extensionAssignOperation></bpel:assign>
        									
        									
        									</bpel:sequence></bpel:else></bpel:if></bpel:sequence>
        				</bpel:scope>
        				</bpel:sequence>
        		</bpel:scope>
        		
        		
        		</bpel:sequence>
        </bpel:while>
        <bpel:reply partnerLink="sjConsultaMovsRecientesTC" operation="ConsultaMovimientosTCNI" variable="response"/>
    </bpel:sequence>
</bpel:process>