<bpel:process name="sjConsultaRecaudoMultiple" targetNamespace="http://www.example.com/flow/Middleware/v2/BusinessServices/SJS/consultaRecaudoMultiple/flow/sjConsultaRecaudoMultiple" bea:name="sjConsultaRecaudoMultiple" xmlns:tns="http://www.example.com/flow/Middleware/v2/BusinessServices/SJS/consultaRecaudoMultiple/flow/sjConsultaRecaudoMultiple" xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable" xmlns:rescon="http://www.bea.com/alsb/flow/resources/config" xmlns:bea="http://www.bea.com/bpel/ui/extensions" xmlns:ext="http://www.bea.com/bpel/extensions" xmlns:expr="http://www.bea.com/wli/sb/stages/config" xmlns:trf="http://www.bea.com/wli/sb/stages/transform/config" xmlns:bind="http://www.ficohsa.com.hn/middleware.services/consultaRecaudoMultiplePS/" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:ns1="http://www.bea.com/wli/sb/stages/logging/config" xmlns:ns0="http://www.ficohsa.com.hn/middleware.services/consultaRecaudoMultipleTypes" xmlns:ns2="http://www.ficohsa.com.hn/middleware.services/consultaDetalleContratoRecaudosPS/" xmlns:ns3="http://www.ficohsa.com.hn/middleware.services/consultaDetalleContratoRecaudosTypes" xmlns:ns4="http://www.ficohsa.com.hn/middleware.services/consultaRecaudoPS/" xmlns:ns5="http://xmlns.oracle.com/pcbpel/adapter/db/InterbancaSOAApplication/ObtenerParametrizacion/obtenerParametrizacion" xmlns:osb="http://xmlns.oracle.com/pcbpel/adapter/db/ORA_BANK/OSB_GET_CONFIG/" xmlns:ns6="http://www.ficohsa.com.hn/middleware.services/sjConsultaRecaudoMultipleTypes" xmlns:soap="http://www.w3.org/2003/05/soap-envelope">
    <rescon:importInfo>
    	<rescon:wsdl-import ref="Middleware/v2/BusinessServices/SJS/consultaRecaudoMultiple/wsdl/sjConsultaRecaudoMultiplePS">
    	</rescon:wsdl-import></rescon:importInfo>
    <bpel:partnerLinks>
        <bpel:partnerLink name="sjConsultaRecaudoMultiple" partnerLinkType="tns:sjConsultaRecaudoMultiple" myRole="sjConsultaRecaudoMultiple">
	       </bpel:partnerLink>
	   <bpel:partnerLink name="ConsultaDetalleContratoRecaudos" partnerLinkType="tns:ConsultaDetalleContratoRecaudos_plnkType" partnerRole="ConsultaDetalleContratoRecaudos_PartnerRole">
	   </bpel:partnerLink>
	   <bpel:partnerLink name="consultaRecaudo" partnerLinkType="tns:consultaRecaudo_plnkType" partnerRole="consultaRecaudo_PartnerRole">
	   </bpel:partnerLink>
	   <bpel:partnerLink name="ObtenerParametrizacion" partnerLinkType="tns:ObtenerParametrizacion_plnkType" partnerRole="ObtenerParametrizacion_PartnerRole">
	   </bpel:partnerLink></bpel:partnerLinks>

	   <bpel:variables>
        <bpel:variable name="request" messageType="bind:consultaRecaudoMultipleRequest">
	       </bpel:variable>
	       <bpel:variable name="response" messageType="bind:consultaRecaudoMultipleResponse">
	       </bpel:variable>
    <bpel:variable name="agrCount" type="xsd:integer"/>
    <bpel:variable name="REQObtenerParams" messageType="ns5:args_in_msg">
    </bpel:variable>
    <bpel:variable name="RSPObtenerParams" messageType="ns5:args_out_msg">
    </bpel:variable>
    <bpel:variable name="localCurrency" type="xsd:string"/>
    <bpel:variable name="localCcyParam" type="xsd:string"/></bpel:variables>

    <bpel:sequence>
        <bpel:receive partnerLink="sjConsultaRecaudoMultiple" operation="consultaRecaudoMultiple" createInstance="yes" variable="request">
	           <rescon:receiveInfo>
                <rescon:wsdl ref="Middleware/v2/BusinessServices/SJS/consultaRecaudoMultiple/wsdl/sjConsultaRecaudoMultiplePS" binding="bind:consultaRecaudoMultiplePSSOAP"/>
            </rescon:receiveInfo>
        </bpel:receive>
        <bpel:assign>
        	<bpel:extensionAssignOperation>
        		<trf:assign varName="agrCount">
        			<trf:expr>
        				<expr:xqueryText>fn:count($request.parameters/AGREEMENTS/AGREEMENT)</expr:xqueryText></trf:expr></trf:assign>
        	</bpel:extensionAssignOperation>
        
	<bpel:extensionAssignOperation>
		<trf:assign varName="response.result">
			<trf:expr>
				<expr:xqueryText>&lt;bind:consultaRecaudoMultipleResponse>
&lt;AGREEMENTS/>
&lt;/bind:consultaRecaudoMultipleResponse></expr:xqueryText></trf:expr></trf:assign>
        </bpel:extensionAssignOperation>
	
	<bpel:extensionAssignOperation>
		<trf:assign varName="localCcyParam">
			<trf:expr>
				<expr:xqueryText>fn:concat("T24T244.LOCALCURRENCY.",fn:string($request.RequestHeader/Region/SourceBank/text()))</expr:xqueryText></trf:expr></trf:assign>
	</bpel:extensionAssignOperation>
	<bpel:extensionAssignOperation>
		<trf:assign varName="REQObtenerParams.InputParameters">
			<trf:expr>
				<expr:xqueryTransform>
					<expr:resource ref="Middleware/Business_Resources/general/Parametrizacion/obtenerParametrizacionIn"/>
					<expr:param name="nombreParametros">
						<expr:path>$localCcyParam</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign>
	</bpel:extensionAssignOperation></bpel:assign>
        <bpel:invoke operation="obtenerParametrizacion" partnerLink="ObtenerParametrizacion" inputVariable="REQObtenerParams" outputVariable="RSPObtenerParams">
        	<rescon:invokeInfo>
        		<rescon:service isProxy="false" ref="Middleware/Business_Resources/general/Resources/ObtenerParametrizacion/ObtenerParametrizacion"/></rescon:invokeInfo></bpel:invoke>
        <bpel:assign>
        	<bpel:extensionAssignOperation>
        		<trf:assign varName="localCurrency">
        			<trf:expr>
        				<expr:xqueryText>fn:string($RSPObtenerParams.OutputParameters/osb:CONFIGURACIONES/osb:CONFIGURACIONES_ITEM[osb:NAME=$localCcyParam]/osb:VALUE/text())</expr:xqueryText></trf:expr></trf:assign>
        	</bpel:extensionAssignOperation>
        </bpel:assign>
        <bpel:forEach parallel="yes" counterName="agrIndex">
        	<bpel:startCounterValue>number(1)</bpel:startCounterValue>
        	<bpel:finalCounterValue>number($agrCount)</bpel:finalCounterValue>
        	<bpel:scope>
        		<bpel:variables>
        			<bpel:variable name="dbtCount" type="xsd:integer"/>
        			<bpel:variable name="agrId" type="xsd:string"/>
        			<bpel:variable name="agrNode" type="ns6:agreementsResponseType"/>
        			<bpel:variable name="REQConsDetContrato" messageType="ns2:consultaDetalleContratoRecaudosRequest">
        			</bpel:variable>
        			<bpel:variable name="RSPConsDetContrato" messageType="ns2:consultaDetalleContratoRecaudosResponse">
        			</bpel:variable>
        			<bpel:variable name="agrSuccessInd" type="xsd:string">
        			</bpel:variable></bpel:variables>
        		<bpel:sequence>
        			<bpel:assign>
        				
        				<bpel:extensionAssignOperation>
        					<trf:assign varName="dbtCount">
        						<trf:expr>
        							<expr:xqueryText>count($request.parameters/AGREEMENTS/AGREEMENT[xs:int($agrIndex)]/DEBTORS/DEBTOR)</expr:xqueryText></trf:expr></trf:assign>
        				</bpel:extensionAssignOperation>
        			
	<bpel:extensionAssignOperation>
		<trf:assign varName="agrId">
			<trf:expr>
				<expr:xqueryText>fn:string($request.parameters/AGREEMENTS/AGREEMENT[xs:int($agrIndex)]/ID/text())</expr:xqueryText></trf:expr></trf:assign>
        			</bpel:extensionAssignOperation>
	
	
	<bpel:extensionAssignOperation>
		<bpel:documentation/>
		<trf:assign varName="REQConsDetContrato.RequestHeader">
			<trf:expr>
				<expr:xqueryText>$request.RequestHeader</expr:xqueryText></trf:expr></trf:assign>
	</bpel:extensionAssignOperation>
	<bpel:extensionAssignOperation>
		<bpel:documentation/>
		<trf:assign varName="REQConsDetContrato.parameters">
			<trf:expr>
				<expr:xqueryTransform>
					<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaRecaudoMultiple/xq/sjConsDetContratoIn"/>
					<expr:param name="aGREEMENT1">
						<expr:path>$request.parameters/AGREEMENTS/AGREEMENT[xs:int($agrIndex)]</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign>
	</bpel:extensionAssignOperation></bpel:assign>
        			
        			<bpel:invoke operation="consultaDetalleContratoRecaudos" partnerLink="ConsultaDetalleContratoRecaudos" inputVariable="REQConsDetContrato" outputVariable="RSPConsDetContrato">
        				<rescon:invokeInfo>
        					<rescon:service isProxy="true" ref="Middleware/v2/ProxyServices/ConsultaDetalleContratoRecaudos"/></rescon:invokeInfo></bpel:invoke>
        			<bpel:assign>
        				<bpel:extensionAssignOperation>
        					<trf:assign varName="agrSuccessInd">
        						<trf:expr>
        							<expr:xqueryText>fn:string($RSPConsDetContrato.ResponseHeader/successIndicator/text())</expr:xqueryText></trf:expr></trf:assign>
        				</bpel:extensionAssignOperation>
        			</bpel:assign>
        			<bpel:assign>
        				<bpel:extensionAssignOperation>
        					<bpel:documentation/>
        					<trf:assign varName="agrNode">
        						<trf:expr>
        							<expr:xqueryTransform>
        								<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaRecaudoMultiple/xq/sjConsDetContratoOut"/>
        								<expr:param name="responseHeader1">
        									<expr:path>$RSPConsDetContrato.ResponseHeader</expr:path></expr:param>
        								<expr:param name="agreementId">
        									<expr:path>$agrId</expr:path></expr:param>
        								<expr:param name="consultaDetalleContratoRecaudosResponse1">
        									<expr:path>$RSPConsDetContrato.result</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign>
        				</bpel:extensionAssignOperation>
        			</bpel:assign>
        			<bpel:if bea:name="Contrato OK ?">
        				<bpel:documentation>Condición para determinar si el contrato es válido</bpel:documentation>
        				<bpel:condition>$agrSuccessInd = "Success"</bpel:condition>
        				<bpel:sequence>
        					<bpel:empty/>
        				
        				<bpel:forEach parallel="yes" counterName="dbtIndex">
        					<bpel:startCounterValue>number(1)</bpel:startCounterValue>
        					<bpel:finalCounterValue>number($dbtCount)</bpel:finalCounterValue>
        					<bpel:scope>
        						<bpel:variables>
        							<bpel:variable name="test" type="xsd:string"/>
        							<bpel:variable name="dbtNode" type="ns6:debtorsResponseType"/>
        							<bpel:variable name="REQConsRecaudo" messageType="ns4:consultaRecaudoRequest">
        							</bpel:variable>
        							<bpel:variable name="RSPConsRecaudo" messageType="ns4:consultaRecaudoResponse">
        							</bpel:variable>
        							<bpel:variable name="requestCcyType" type="xsd:string">
        							</bpel:variable>
        							</bpel:variables>
        						<bpel:faultHandlers>
        							
        							
        							
        							<bpel:catchAll ext:soapFaultVariable="soapFault">
        								<bpel:sequence>
        									<bpel:empty></bpel:empty>
        								<bpel:scope>
		<bpel:sequence>
			<bpel:assign>
				<bpel:extensionAssignOperation>
					<trf:assign varName="dbtNode">
						<trf:expr>
							<expr:xqueryTransform>
								<expr:resource
									ref="Middleware/v2/BusinessServices/SJS/consultaRecaudoMultiple/xq/sjConsRecaudoErrOut"></expr:resource>
								
								
								
								<expr:param name="dEBTOR1">
									<expr:path>$request.parameters/AGREEMENTS/AGREEMENT[xs:int($agrIndex)]/DEBTORS/DEBTOR[xs:int($dbtIndex)]</expr:path></expr:param>
								<expr:param name="errorMessage">
									<expr:path>&quot;ERROR INESPERADO&quot;</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign></bpel:extensionAssignOperation>
				<bpel:extensionAssignOperation>
					<trf:insert varName="agrNode">
						<trf:location>
							<expr:xpathText>./AGREEMENT/DEBTORS</expr:xpathText></trf:location>
						<trf:where>first-child</trf:where>
						<trf:expr>
							<expr:xqueryText>$dbtNode/DEBTOR</expr:xqueryText></trf:expr></trf:insert></bpel:extensionAssignOperation></bpel:assign></bpel:sequence></bpel:scope></bpel:sequence>
        							</bpel:catchAll></bpel:faultHandlers>
        						<bpel:sequence>
        							<bpel:assign>
        								<bpel:extensionAssignOperation>
        									<trf:assign varName="test">
        										<trf:expr>
        											<expr:xqueryText>fn:string($request.parameters/AGREEMENTS/AGREEMENT[xs:int($agrIndex)]/DEBTORS/DEBTOR[xs:int($dbtIndex)]/CODE/text())</expr:xqueryText></trf:expr></trf:assign></bpel:extensionAssignOperation>
        								<bpel:extensionAssignOperation>
        									<trf:assign varName="REQConsRecaudo.RequestHeader">
        										<trf:expr>
        											<expr:xqueryText>$request.RequestHeader</expr:xqueryText></trf:expr></trf:assign>
        								</bpel:extensionAssignOperation>
        								<bpel:extensionAssignOperation>
        									<trf:assign varName="REQConsRecaudo.parameters">
        										<trf:expr>
        											<expr:xqueryTransform>
        												<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaRecaudoMultiple/xq/sjConsRecaudoIn"/>
        												
        												
        												<expr:param name="dEBTOR1">
        													<expr:path>$request.parameters/AGREEMENTS/AGREEMENT[xs:int($agrIndex)]/DEBTORS/DEBTOR[xs:int($dbtIndex)]</expr:path></expr:param>
        												<expr:param name="agreementId">
        													<expr:path>$agrId</expr:path></expr:param>
        												<expr:param name="localCurrency">
        													<expr:path>$localCurrency</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign>
        								</bpel:extensionAssignOperation>
        								
        								</bpel:assign>
        							<bpel:invoke operation="consultaRecaudo" partnerLink="consultaRecaudo" inputVariable="REQConsRecaudo" outputVariable="RSPConsRecaudo">
        								<rescon:invokeInfo>
        									<rescon:service isProxy="false" ref="Middleware/v2/BusinessServices/OSB/consultaRecaudo_v2/biz/consultaRecaudo"/></rescon:invokeInfo></bpel:invoke>
        							<bpel:assign>
        								<bpel:extensionAssignOperation>
        									<trf:assign varName="dbtNode">
        										<trf:expr>
        											<expr:xqueryTransform>
        												<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaRecaudoMultiple/xq/sjConsRecaudoOut"/>
        												
        												
        												
        												
        												
        												
        												
        												
        												
        												
        												
        												
        												
        												
        												
        												
        												
        												
        												<expr:param name="dEBTOR1">
        													<expr:path>$request.parameters/AGREEMENTS/AGREEMENT[xs:int($agrIndex)]/DEBTORS/DEBTOR[xs:int($dbtIndex)]</expr:path></expr:param>
        												<expr:param name="responseHeader1">
        													<expr:path>$RSPConsRecaudo.ResponseHeader</expr:path></expr:param>
        												<expr:param name="consultaRecaudoResponse1">
        													<expr:path>$RSPConsRecaudo.result</expr:path></expr:param>
        												<expr:param name="localCurrency">
        													<expr:path>$localCurrency</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign>
        								</bpel:extensionAssignOperation>
        								
        								<bpel:extensionAssignOperation>
        									<trf:insert varName="agrNode">
        										<trf:location>
        											<expr:xpathText>./AGREEMENT/DEBTORS</expr:xpathText></trf:location>
        										<trf:where>last-child</trf:where>
        										<trf:expr>
        											<expr:xqueryText>$dbtNode/DEBTOR</expr:xqueryText></trf:expr></trf:insert></bpel:extensionAssignOperation></bpel:assign></bpel:sequence></bpel:scope></bpel:forEach>
        				</bpel:sequence>
        				<bpel:else>
        					<bpel:sequence>
        						<bpel:empty/>
        					</bpel:sequence>
        				</bpel:else>
        			</bpel:if>
        			
        			
        			<bpel:assign>
        				
        				<bpel:extensionAssignOperation>
        					<bpel:documentation/>
        					<trf:insert varName="response.result">
        						<trf:location>
        							<expr:xpathText>./AGREEMENTS</expr:xpathText></trf:location>
        						<trf:where>last-child</trf:where>
        						<trf:expr>
        							<expr:xqueryText>$agrNode/AGREEMENT</expr:xqueryText></trf:expr></trf:insert>
        				</bpel:extensionAssignOperation>
        			</bpel:assign></bpel:sequence>
        	</bpel:scope>
        </bpel:forEach>
        <bpel:assign>
        	<bpel:extensionAssignOperation>
        		<bpel:documentation/>
        		<trf:assign varName="response.ResponseHeader">
        			<trf:expr>
        				<expr:xqueryText>&lt;bind:ResponseHeader>
	&lt;successIndicator>
	{
		if (count($response.result/AGREEMENTS/AGREEMENT[SUCCESS_INDICATOR="Success" or SUCCESS_INDICATOR="SUCCESS"]) > 0) then (
			"SUCCESS"
		) else (
			"ERROR"
		)
	}
	&lt;/successIndicator>
&lt;/bind:ResponseHeader></expr:xqueryText></trf:expr></trf:assign>
        	</bpel:extensionAssignOperation>
        </bpel:assign>
        <bpel:reply partnerLink="sjConsultaRecaudoMultiple" operation="consultaRecaudoMultiple" variable="response"/>
    </bpel:sequence>
</bpel:process>