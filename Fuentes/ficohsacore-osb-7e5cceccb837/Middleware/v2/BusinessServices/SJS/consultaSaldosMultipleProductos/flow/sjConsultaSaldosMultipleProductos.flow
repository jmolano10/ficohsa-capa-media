<?xml version="1.0" encoding="UTF-8"?>
<bpel:process name="sjConsultaMultipleProductosHN"
              targetNamespace="http://www.example.com/flow/Middleware/v2/BusinessServices/SJS/consultaMultipleProductosHN/flow/sjConsultaMultipleProductosHN"
              xmlns:tns="http://www.example.com/flow/Middleware/v2/BusinessServices/SJS/consultaMultipleProductosHN/flow/sjConsultaMultipleProductosHN"
              xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
              xmlns:rescon="http://www.bea.com/alsb/flow/resources/config"
              xmlns:bea="http://www.bea.com/bpel/ui/extensions"
              xmlns:ext="http://www.bea.com/bpel/extensions"
              xmlns:expr="http://www.bea.com/wli/sb/stages/config"
              xmlns:trf="http://www.bea.com/wli/sb/stages/transform/config"
              xmlns:bind="http://www.ficohsa.com.hn/middleware.services/sjConsultaMultipleProductosHN" 
              bea:name="sjConsultaSaldosMultipleProductos" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:ns1="T24WebServicesImpl" xmlns:ns0="http://xmlns.oracle.com/pcbpel/adapter/db/InterbancaSOAApplication/ConsultaFICOPEN/consultaFICOPEN" xmlns:ns2="http://xmlns.oracle.com/pcbpel/adapter/db/InterbancaSOAApplication/ConsultaGeneralPrestamo/consultaGeneralPrestamo" xmlns:ns3="http://tempuri.org/" xmlns:ns4="http://www.ficohsa.com.hn/middleware.services/sjConsultaSaldosMultipleProductos">
    <bpel:partnerLinks>
        <bpel:partnerLink name="sjConsultaMultipleProductosHN" partnerLinkType="tns:sjConsultaMultipleProductosHN"
                          myRole="sjConsultaMultipleProductosHN">
	       </bpel:partnerLink>
	   
	   
	   
	   
	   
	   
	   
	   <bpel:partnerLink name="consultaMultipleProducto"
		partnerLinkType="tns:consultaMultipleProducto_plnkType"
		partnerRole="consultaMultipleProducto_PartnerRole">
	   </bpel:partnerLink></bpel:partnerLinks>

	   

    <bpel:variables>
    	
    	<bpel:variable name="response"
    		messageType="ns4:sjConsultaSaldosMultipleProductosResponse">
    	</bpel:variable>
    	<bpel:variable name="request"
    		messageType="ns4:sjConsultaSaldosMultipleProductosRequest">
    	</bpel:variable>
    	
    	
    	<bpel:variable name="successIndicatorT24" type="xsd:string"></bpel:variable>
    	<bpel:variable name="REQConsultaMultipleProducto"
    		messageType="ns1:ConsultaMultipleProducto">
    	</bpel:variable>
    	<bpel:variable name="RSPConsultaMultipleProducto"
    		messageType="ns1:ConsultaMultipleProductoResponse">
    	</bpel:variable></bpel:variables>
    <bpel:sequence>
        <bpel:receive partnerLink="sjConsultaMultipleProductosHN" operation="consultaProductos" createInstance="yes" variable="request">
	           <rescon:receiveInfo>
                <rescon:wsdl ref="Middleware/v2/BusinessServices/SJS/consultaSaldosMultipleProductos/wsdl/sjConsultaSaldosMultipleProductos" binding="ns4:sjConsultaSaldosMultipleProductosPSSOAP"/>
            </rescon:receiveInfo>
        </bpel:receive>
        
        
        
        
        
        <bpel:assign>
        	<bpel:extensionAssignOperation>
        		<bpel:documentation></bpel:documentation>
        		<trf:assign varName="response.outputParameters">
        			<trf:expr>
        				<expr:xqueryText>&lt;outputParameters&gt;
	&lt;ns4:ASSETS/&gt;
	&lt;ns4:LIABILITIES/&gt;
&lt;/outputParameters&gt;</expr:xqueryText></trf:expr></trf:assign>
        	</bpel:extensionAssignOperation>
        </bpel:assign>
        <bpel:scope>
        	<bpel:faultHandlers>
        		<bpel:catchAll>
        			<bpel:sequence>
        				<bpel:empty></bpel:empty>
        			<bpel:assign>
		
        			<bpel:extensionAssignOperation>
		<bpel:documentation></bpel:documentation>
		<trf:insert varName="response.outputParameters">
			<trf:location>
				<expr:xpathText>./ns4:ASSETS</expr:xpathText></trf:location>
			<trf:where>last-child</trf:where>
			<trf:expr>
				<expr:xqueryText>for $ID in $request.inputParameters/ns4:PRODUCTS/ns4:ID
return
&lt;ns4:ASSET&gt;
	&lt;ns4:ID&gt;{ data($ID) }&lt;/ns4:ID&gt;
	&lt;ns4:TYPE&gt;{string($request.inputParameters/TYPE/text())}&lt;/ns4:TYPE&gt;
	&lt;ns4:SOURCE_BANK&gt;HN01&lt;/ns4:SOURCE_BANK&gt;
	&lt;ns4:SUCCESS_INDICATOR&gt;ERROR&lt;/ns4:SUCCESS_INDICATOR&gt;
	&lt;ns4:ERROR_MESSAGE&gt;ERROR CONSULTANDO EL PRODUCTO&lt;/ns4:ERROR_MESSAGE&gt;
&lt;/ns4:ASSET&gt;</expr:xqueryText></trf:expr></trf:insert>
        			</bpel:extensionAssignOperation></bpel:assign></bpel:sequence>
        		</bpel:catchAll></bpel:faultHandlers>
        	<bpel:sequence>
        		<bpel:assign>
        			
        			<bpel:extensionAssignOperation>
        				<trf:assign
        					varName="REQConsultaMultipleProducto.parameters">
        					<trf:expr>
        						<expr:xqueryTransform>
        							<expr:resource
        								ref="Middleware/v2/BusinessServices/SJS/consultaSaldosMultipleProductos/xq/consultaMultipleProductoIn"></expr:resource>
        							<expr:param name="sjConsultaSaldosMultipleProductos">
        								<expr:path>$request.inputParameters</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign></bpel:extensionAssignOperation>
        			</bpel:assign>
        		<bpel:invoke operation="ConsultaMultipleProducto"
        			partnerLink="consultaMultipleProducto" inputVariable="REQConsultaMultipleProducto" outputVariable="RSPConsultaMultipleProducto">
        			<rescon:invokeInfo>
        				<rescon:service
        					ref="Middleware/v2/BusinessServices/ConsultaMultipleProducto/biz/consultaMultipleProducto"
        					isProxy="false"></rescon:service></rescon:invokeInfo></bpel:invoke>
        		<bpel:assign>
        			<bpel:extensionAssignOperation>
        				<trf:assign varName="successIndicatorT24">
        					<trf:expr>
        						<expr:xqueryText>upper-case(string($RSPConsultaMultipleProducto.parameters/Status/successIndicator/text()))</expr:xqueryText></trf:expr></trf:assign></bpel:extensionAssignOperation>
        			
        			<bpel:extensionAssignOperation>
        				<bpel:documentation></bpel:documentation>
        				<trf:insert
        					varName="response.outputParameters">
        					<trf:location>
        						<expr:xpathText>./ns4:ASSETS</expr:xpathText></trf:location>
        					<trf:where>last-child</trf:where>
        					<trf:expr>
        						<expr:xqueryText>if($successIndicatorT24 = 'SUCCESS')then(
	for $ID in $request.inputParameters/ns4:PRODUCTS/ns4:ID
	let $cuenta := $RSPConsultaMultipleProducto.parameters/WSFICOACCTDETMULTPRODType/gWSFICOACCTDETMULTPRODDetailType/mWSFICOACCTDETMULTPRODDetailType[ACCOUNTNUMBER=xs:string($ID/text()) or ALTACCTID=xs:string($ID/text())]
	return
	if(count($cuenta) &gt; 0)then(
		&lt;ns4:ASSET&gt;
			&lt;ns4:ID&gt;{ data($ID) }&lt;/ns4:ID&gt;
			&lt;ns4:PRODUCT_NAME&gt;{ string($cuenta/ACCOUNTTITLE/text()) }&lt;/ns4:PRODUCT_NAME&gt;
			&lt;ns4:CURRENCY&gt;{ string($cuenta/CURRENCY/text()) }&lt;/ns4:CURRENCY&gt;
			&lt;ns4:RESERVE_BALANCE&gt;{ string($cuenta/CLEARINGBAL/text()) }&lt;/ns4:RESERVE_BALANCE&gt;
			&lt;ns4:LOCKED_BALANCE&gt;{ string($cuenta/LOCKEDBALANCE/text()) }&lt;/ns4:LOCKED_BALANCE&gt;
			&lt;ns4:VISA_FLOATING_BALANCE&gt;{ string($cuenta/LOCKEDVISABAL/text()) }&lt;/ns4:VISA_FLOATING_BALANCE&gt;
			&lt;ns4:CASH_ADVANCE_LIMIT&gt;{ string($cuenta/AUTHLIMITCASHADV/text()) }&lt;/ns4:CASH_ADVANCE_LIMIT&gt;
            &lt;ns4:CASH_ADVANCE_AVAILABLE&gt;{ fn-bea:format-number(number($cuenta/AUTHLIMITCASHADV/text()) - number($cuenta/UTILCASHADVVAL/text()),&quot;###.00&quot;) }&lt;/ns4:CASH_ADVANCE_AVAILABLE&gt;
		    &lt;ns4:TOTAL_BALANCE&gt;{ string($cuenta/TOTALAVAILBAL/text()) }&lt;/ns4:TOTAL_BALANCE&gt;
			&lt;ns4:AVAILABLE_BALANCE&gt;{ string($cuenta/AVAILBALANCE/text()) }&lt;/ns4:AVAILABLE_BALANCE&gt;
		    &lt;ns4:TYPE&gt;{ string($request.inputParameters/ns4:TYPE/text()) }&lt;/ns4:TYPE&gt;
			&lt;ns4:SOURCE_BANK&gt;HN01&lt;/ns4:SOURCE_BANK&gt;
			&lt;ns4:SUCCESS_INDICATOR&gt;SUCCESS&lt;/ns4:SUCCESS_INDICATOR&gt;
		&lt;/ns4:ASSET&gt;
	)else(
		&lt;ns4:ASSET&gt;
			&lt;ns4:ID&gt;{ data($ID) }&lt;/ns4:ID&gt;
			&lt;ns4:TYPE&gt;{ string($request.inputParameters/ns4:TYPE/text()) }&lt;/ns4:TYPE&gt;
			&lt;ns4:SOURCE_BANK&gt;HN01&lt;/ns4:SOURCE_BANK&gt;
			&lt;ns4:SUCCESS_INDICATOR&gt;NO RECORDS&lt;/ns4:SUCCESS_INDICATOR&gt;
			&lt;ns4:ERROR_MESSAGE&gt;PRODUCTO NO ENCONTRADO&lt;/ns4:ERROR_MESSAGE&gt;
		&lt;/ns4:ASSET&gt;
	)
)else(
	for $ID in $request.inputParameters/ns4:PRODUCTS/ns4:ID
	return
	&lt;ns4:ASSET&gt;
		&lt;ns4:ID&gt;{ data($ID) }&lt;/ns4:ID&gt;
		&lt;ns4:TYPE&gt;{string($request.inputParameters/ns4:TYPE/text())}&lt;/ns4:TYPE&gt;
		&lt;ns4:SOURCE_BANK&gt;HN01&lt;/ns4:SOURCE_BANK&gt;
		&lt;ns4:SUCCESS_INDICATOR&gt;ERROR&lt;/ns4:SUCCESS_INDICATOR&gt;
		&lt;ns4:ERROR_MESSAGE&gt;{ string-join($RSPConsultaMultipleProducto.parameters/Status/messages/text(),&quot;. &quot;) }&lt;/ns4:ERROR_MESSAGE&gt;
	&lt;/ns4:ASSET&gt;
)</expr:xqueryText></trf:expr></trf:insert>
</bpel:extensionAssignOperation></bpel:assign></bpel:sequence>
        </bpel:scope>
        
        
        
        
        
        <bpel:reply partnerLink="sjConsultaMultipleProductosHN" operation="consultaProductos" variable="response"></bpel:reply>
    </bpel:sequence>
</bpel:process>