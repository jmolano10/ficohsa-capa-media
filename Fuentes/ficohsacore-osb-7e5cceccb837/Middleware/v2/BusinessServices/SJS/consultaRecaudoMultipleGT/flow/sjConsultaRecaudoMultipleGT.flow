<?xml version="1.0" encoding="UTF-8"?>
<bpel:process name="sjConsultaRecaudoMultipleGT"
              targetNamespace="http://www.example.com/flow/Middleware/v2/BusinessServices/SJS/consultaRecaudoMultipleGT/flow/sjConsultaRecaudoMultipleGT"
              xmlns:tns="http://www.example.com/flow/Middleware/v2/BusinessServices/SJS/consultaRecaudoMultipleGT/flow/sjConsultaRecaudoMultipleGT"
              xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
              xmlns:rescon="http://www.bea.com/alsb/flow/resources/config"
              xmlns:bea="http://www.bea.com/bpel/ui/extensions"
              xmlns:ext="http://www.bea.com/bpel/extensions"
              xmlns:expr="http://www.bea.com/wli/sb/stages/config"
              xmlns:trf="http://www.bea.com/wli/sb/stages/transform/config"
              xmlns:bind="http://www.ficohsa.com.hn/middleware.services/consultaRecaudoMultiplePSGT/" 
              bea:name="sjConsultaRecaudoMultipleGT" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:ns1="http://www.ficohsa.com.hn/middleware.services/consultaRecaudoPS/" xmlns:ns0="http://www.ficohsa.com.hn/middleware.services/sjConsultaRecaudoMultipleTypes" xmlns:ns2="http://xmlns.oracle.com/pcbpel/adapter/db/ObtenerInfoConvenios/ObtenieInfoConvenio/ObtenerInfomacionConvenio" xmlns:obt="http://xmlns.oracle.com/pcbpel/adapter/db/sp/ObtenerInfomacionConvenio">
    <bpel:partnerLinks>
        <bpel:partnerLink name="sjConsultaRecaudoMultipleGT" partnerLinkType="tns:sjConsultaRecaudoMultipleGT"
                          myRole="sjConsultaRecaudoMultipleGT">
	       </bpel:partnerLink>
	   <bpel:partnerLink name="ObtenerInfomacionConvenio_db"
		partnerLinkType="tns:ObtenerInfomacionConvenio_db_plnkType"
		partnerRole="ObtenerInfomacionConvenio_db_PartnerRole">
	   </bpel:partnerLink>
	   <bpel:partnerLink name="ConsultaRecaudo_1"
	   	partnerLinkType="tns:ConsultaRecaudo_1_plnkType"
	   	partnerRole="ConsultaRecaudo_1_PartnerRole">
	   </bpel:partnerLink></bpel:partnerLinks>

	   <bpel:variables>
        <bpel:variable name="request"
	                      messageType="bind:consultaRecaudoMultipleRequest">
	       </bpel:variable>
	       <bpel:variable name="response"
                       messageType="bind:consultaRecaudoMultipleResponse">
	       </bpel:variable>
    <bpel:variable name="agrCount" type="xsd:integer"></bpel:variable></bpel:variables>

    <bpel:sequence>
        <bpel:receive partnerLink="sjConsultaRecaudoMultipleGT" operation="consultaRecaudoMultiple" variable="request" createInstance="yes">
	           <rescon:receiveInfo>
                <rescon:wsdl ref="Middleware/v2/BusinessServices/SJS/consultaRecaudoMultipleGT/wsdl/sjConsultaRecaudoMultiplePSGT" binding="bind:consultaRecaudoMultiplePSGTSOAP"/>
            </rescon:receiveInfo>
        </bpel:receive>
        <bpel:assign>
        	<bpel:extensionAssignOperation>
        		<trf:assign varName="agrCount">
        			<trf:expr>
        				<expr:xqueryText>fn:count($request.parameters/AGREEMENTS/AGREEMENT)</expr:xqueryText></trf:expr></trf:assign>
        	</bpel:extensionAssignOperation>
        <bpel:extensionAssignOperation>
		<trf:assign varName="response.result">
			<trf:expr>
				<expr:xqueryText>&lt;bind:consultaRecaudoMultipleResponse&gt;
&lt;AGREEMENTS/&gt;
&lt;/bind:consultaRecaudoMultipleResponse&gt;</expr:xqueryText></trf:expr></trf:assign>
        </bpel:extensionAssignOperation></bpel:assign>
        <bpel:forEach parallel="yes" counterName="agrIndex">
        	<bpel:startCounterValue>number(1)</bpel:startCounterValue>
        	<bpel:finalCounterValue>number($agrCount)</bpel:finalCounterValue>
        	<bpel:scope>
        		<bpel:variables>
        			<bpel:variable name="dbtCount" type="xsd:integer"></bpel:variable>
        			<bpel:variable name="agrId" type="xsd:string"></bpel:variable>
        			
        			
        			<bpel:variable name="agrSuccessInd"
        				type="xsd:string">
        			</bpel:variable>
        			<bpel:variable name="agrNode"
        				type="ns0:agreementsResponseType">
        			</bpel:variable>
        			<bpel:variable name="REQConsDetContrato"
        				messageType="ns2:args_in_msg">
        			</bpel:variable>
        			<bpel:variable name="RSPConsDetContrato"
        				messageType="ns2:args_out_msg">
        			</bpel:variable></bpel:variables>
        		<bpel:faultHandlers>
        			<bpel:catchAll>
        				<bpel:sequence>
        					<bpel:empty></bpel:empty>
        				<bpel:assign>
		<bpel:extensionAssignOperation>
			<trf:assign varName="agrId">
				<trf:expr>
					<expr:xqueryText>&quot;Prueba&quot;</expr:xqueryText></trf:expr></trf:assign>
		</bpel:extensionAssignOperation>
        				</bpel:assign></bpel:sequence>
        			</bpel:catchAll></bpel:faultHandlers>
        		<bpel:sequence>
        			
        			<bpel:assign>
        				<bpel:extensionAssignOperation>
        					<trf:assign varName="dbtCount">
        						<trf:expr>
        							<expr:xqueryText>count($request.parameters/AGREEMENTS/AGREEMENT[xs:int($agrIndex)]/DEBTORS/DEBTOR)</expr:xqueryText></trf:expr></trf:assign>
        				</bpel:extensionAssignOperation>
        				<bpel:extensionAssignOperation>
        					<trf:assign varName="agrId">
        						<trf:expr>
        							<expr:xqueryText>fn:string($request.parameters/AGREEMENTS/AGREEMENT[xs:int($agrIndex)]/ID/text())</expr:xqueryText></trf:expr></trf:assign>
        				</bpel:extensionAssignOperation>
        				
        				<bpel:extensionAssignOperation>
        					<bpel:documentation></bpel:documentation>
        					<trf:assign
        						varName="REQConsDetContrato.InputParameters">
        						<trf:expr>
        							
        							<expr:xqueryTransform>
	<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaRecaudoMultipleGT/xq/sjConsDetContratoGTIn"></expr:resource>
	
	
	
	
	
	
	
	
	
	
	
	
	
	<expr:param name="codContratro">
		<expr:path>$agrId</expr:path></expr:param>
	<expr:param name="codPais">
		<expr:path>fn:string($request.RequestHeader/Region/SourceBank/text())</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign>
        				</bpel:extensionAssignOperation>
        				
        			</bpel:assign>
        			<bpel:invoke operation="ObtenerInfomacionConvenio" partnerLink="ObtenerInfomacionConvenio_db" inputVariable="REQConsDetContrato" outputVariable="RSPConsDetContrato">
        				<rescon:invokeInfo>
        					<rescon:service isProxy="false" ref="Middleware/v3/BusinessServices/MDW/obtenerInformacionConvenio/biz/ObtenerInfomacionConvenio_db"></rescon:service></rescon:invokeInfo></bpel:invoke>
        			<bpel:assign>
        				
        			<bpel:extensionAssignOperation>
		<trf:assign varName="agrSuccessInd">
			<trf:expr>
				<expr:xqueryText>fn:string($RSPConsDetContrato.OutputParameters/obt:PV_ERRORCODE/text())</expr:xqueryText></trf:expr></trf:assign>
        			</bpel:extensionAssignOperation>
        			<bpel:extensionAssignOperation>
        				<trf:assign varName="agrNode">
        					<trf:expr>
        						<expr:xqueryTransform>
        							<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaRecaudoMultipleGT/xq/sjConsDetContratoGTOut"></expr:resource>
        							
        							
        							
        							
        							
        							
        							
        							
        							
        							<expr:param name="outputParameters">
        								<expr:path>$RSPConsDetContrato.OutputParameters</expr:path></expr:param>
        							<expr:param name="aggreId">
        								<expr:path>$agrId</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign>
        			</bpel:extensionAssignOperation></bpel:assign>
        			<bpel:if>
        				<bpel:condition>$agrSuccessInd = &quot;SUCCESS&quot;</bpel:condition>
        				<bpel:sequence>
        					<bpel:empty></bpel:empty>
        				<bpel:forEach parallel="yes" counterName="dbtIndex">
		<bpel:startCounterValue>number(1)</bpel:startCounterValue>
		<bpel:finalCounterValue>number($dbtCount)</bpel:finalCounterValue>
		<bpel:scope>
			<bpel:variables>
				<bpel:variable name="test" type="xsd:string"></bpel:variable>
				<bpel:variable name="REQConsRecaudo"
					messageType="ns1:consultaRecaudoRequest">
				</bpel:variable>
				<bpel:variable name="RSPConsRecaudo"
					messageType="ns1:consultaRecaudoResponse">
				</bpel:variable>
				<bpel:variable name="dbtNode"
					type="ns0:debtorsResponseType">
				</bpel:variable></bpel:variables>
			<bpel:faultHandlers>
				<bpel:catchAll>
					<bpel:sequence>
						<bpel:empty></bpel:empty>
					<bpel:assign>
		<bpel:extensionAssignOperation>
			<trf:assign varName="dbtNode">
				<trf:expr>
					<expr:xqueryTransform>
						<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaRecaudoMultipleGT/xq/sjConsRecaudoErrGTOut"></expr:resource>
						
						
						<expr:param name="errorMessage">
							<expr:path>&quot;ERROR INESPERADO&quot;</expr:path></expr:param>
						<expr:param name="dEBTOR1">
							<expr:path>$request.parameters/AGREEMENTS/AGREEMENT[xs:int($agrIndex)]/DEBTORS/DEBTOR[xs:int($dbtIndex)]</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign>
		</bpel:extensionAssignOperation>
					<bpel:extensionAssignOperation>
		<bpel:documentation></bpel:documentation>
		<trf:insert varName="agrNode">
			<trf:location>
				<expr:xpathText>./AGREEMENT/DEBTORS</expr:xpathText></trf:location>
			<trf:where>first-child</trf:where>
			<trf:expr>
				<expr:xqueryText>$dbtNode/DEBTOR</expr:xqueryText></trf:expr></trf:insert>
					</bpel:extensionAssignOperation></bpel:assign>
					</bpel:sequence>
				</bpel:catchAll></bpel:faultHandlers>
			<bpel:sequence>
				<bpel:assign>
					<bpel:extensionAssignOperation>
						<trf:assign varName="test">
							<trf:expr>
								<expr:xqueryText>fn:string($request.parameters/AGREEMENTS/AGREEMENT[xs:int($agrIndex)]/DEBTORS/DEBTOR[xs:int($dbtIndex)]/CODE/text())</expr:xqueryText></trf:expr></trf:assign>
					</bpel:extensionAssignOperation>
				<bpel:extensionAssignOperation>
		<trf:assign varName="REQConsRecaudo.RequestHeader">
			<trf:expr>
				<expr:xqueryText>$request.RequestHeader</expr:xqueryText></trf:expr></trf:assign>
				</bpel:extensionAssignOperation>
				<bpel:extensionAssignOperation>
					<trf:assign varName="REQConsRecaudo.parameters">
						<trf:expr>
							<expr:xqueryTransform>
								<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaRecaudoMultipleGT/xq/sjConsRecaudoGTIn"></expr:resource>
								
								
								<expr:param name="agreementId">
									<expr:path>$agrId</expr:path></expr:param>
								<expr:param name="dEBTOR1">
									<expr:path>$request.parameters/AGREEMENTS/AGREEMENT[xs:int($agrIndex)]/DEBTORS/DEBTOR[xs:int($dbtIndex)]</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign>
				</bpel:extensionAssignOperation>
				</bpel:assign>
				<bpel:invoke operation="consultaRecaudo" partnerLink="ConsultaRecaudo_1" inputVariable="REQConsRecaudo" outputVariable="RSPConsRecaudo">
					<rescon:invokeInfo>
						<rescon:service isProxy="true" ref="Middleware/v2/ProxyServices/ConsultaRecaudo"></rescon:service></rescon:invokeInfo></bpel:invoke>
				
				<bpel:assign>
					<bpel:extensionAssignOperation>
						<trf:assign varName="dbtNode">
							<trf:expr>
								<expr:xqueryTransform>
									<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaRecaudoMultipleGT/xq/sjConsRecaudoGTOut"></expr:resource>
									
									
									
									
									
									
									<expr:param name="responseHeader">
										<expr:path>$RSPConsRecaudo.ResponseHeader</expr:path></expr:param>
									<expr:param name="consultaRecaudoResponse">
										<expr:path>$RSPConsRecaudo.result</expr:path></expr:param>
									<expr:param name="dEBTOR1">
										<expr:path>$request.parameters/AGREEMENTS/AGREEMENT[xs:int($agrIndex)]/DEBTORS/DEBTOR[xs:int($dbtIndex)]</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign>
					</bpel:extensionAssignOperation>
				<bpel:extensionAssignOperation>
		<trf:insert varName="agrNode">
			<trf:location>
				<expr:xpathText>./AGREEMENT/DEBTORS</expr:xpathText></trf:location>
			<trf:where>last-child</trf:where>
		<trf:expr>
			<expr:xqueryText>$dbtNode/DEBTOR</expr:xqueryText></trf:expr></trf:insert>
				</bpel:extensionAssignOperation></bpel:assign></bpel:sequence></bpel:scope></bpel:forEach>
        				</bpel:sequence>
        				<bpel:else>
        					<bpel:sequence>
        						<bpel:empty></bpel:empty>
        					</bpel:sequence>
        				</bpel:else>
        			</bpel:if>
        			<bpel:assign>
        				<bpel:extensionAssignOperation>
        					<trf:insert varName="response.result">
        						<trf:location>
        							<expr:xpathText>./AGREEMENTS</expr:xpathText></trf:location>
        						<trf:where>last-child</trf:where>
        					<trf:expr>
        						<expr:xqueryText>$agrNode/AGREEMENT</expr:xqueryText></trf:expr></trf:insert>
        				</bpel:extensionAssignOperation>
        			</bpel:assign></bpel:sequence>
        	</bpel:scope>
        </bpel:forEach>
        
        <bpel:assign>
        	<bpel:extensionAssignOperation>
        		<trf:assign varName="response.ResponseHeader">
        			<trf:expr>
        				<expr:xqueryText>&lt;bind:ResponseHeader&gt;
	&lt;successIndicator&gt;
	{
		if (count($response.result/AGREEMENTS/AGREEMENT[SUCCESS_INDICATOR=&quot;Success&quot; or SUCCESS_INDICATOR=&quot;SUCCESS&quot;]) &gt; 0) then (
			&quot;SUCCESS&quot;
		) else (
			&quot;ERROR&quot;
		)
	}
	&lt;/successIndicator&gt;
&lt;/bind:ResponseHeader&gt;</expr:xqueryText></trf:expr></trf:assign>
        	</bpel:extensionAssignOperation>
        </bpel:assign>
        <bpel:reply partnerLink="sjConsultaRecaudoMultipleGT" operation="consultaRecaudoMultiple" variable="response"></bpel:reply>
    </bpel:sequence>
</bpel:process>