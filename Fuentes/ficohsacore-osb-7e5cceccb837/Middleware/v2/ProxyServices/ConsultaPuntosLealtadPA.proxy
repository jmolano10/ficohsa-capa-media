<?xml version="1.0" encoding="UTF-8"?>
<xml-fragment xmlns:ser="http://www.bea.com/wli/sb/services" xmlns:tran="http://www.bea.com/wli/sb/transports" xmlns:env="http://www.bea.com/wli/config/env" xmlns:http="http://www.bea.com/wli/sb/transports/http" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:con="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/services/security/config" xmlns:con3="http://www.bea.com/wli/sb/pipeline/config">
  <ser:coreEntry isProxy="true" isEnabled="true" isTracingEnabled="false" isAutoPublish="false">
    <ser:binding type="SOAP" isSoap12="false" xsi:type="con2:SoapBindingType" xmlns:con2="http://www.bea.com/wli/sb/services/bindings/config">
      <con2:wsdl ref="Middleware/v2/Resources/ConsultaPuntosLealtad/wsdl/consultaPuntosLealtadPS"/>
      <con2:port>
        <con2:name>consultaPuntosLealtadPSSOAP</con2:name>
        <con2:namespace>http://www.ficohsa.com.hn/middleware.services/programaLealtad/</con2:namespace>
      </con2:port>
      <con2:selector type="SOAP body"/>
      <con2:WSI-compliant>false</con2:WSI-compliant>
    </ser:binding>
    <ser:monitoring isEnabled="false">
      <ser:aggregationInterval>10</ser:aggregationInterval>
      <ser:pipelineMonitoringLevel>Pipeline</ser:pipelineMonitoringLevel>
    </ser:monitoring>
    <ser:reporting>true</ser:reporting>
    <ser:logging isEnabled="true">
      <ser:logLevel>debug</ser:logLevel>
    </ser:logging>
    <ser:sla-alerting isEnabled="true">
      <ser:alertLevel>normal</ser:alertLevel>
    </ser:sla-alerting>
    <ser:pipeline-alerting isEnabled="true">
      <ser:alertLevel>normal</ser:alertLevel>
    </ser:pipeline-alerting>
    <ser:ws-policy>
      <ser:binding-mode>wsdl-policy-attachments</ser:binding-mode>
    </ser:ws-policy>
    <ser:throttling enabled="false">
      <ser:capacity>0</ser:capacity>
      <ser:maxQueueLength>0</ser:maxQueueLength>
      <ser:timeToLive>0</ser:timeToLive>
    </ser:throttling>
    <ser:messageTracing enabled="false">
      <ser:detailsLevel>Terse</ser:detailsLevel>
      <ser:maxSize>8192</ser:maxSize>
    </ser:messageTracing>
  </ser:coreEntry>
  <ser:endpointConfig>
    <tran:provider-id>local</tran:provider-id>
    <tran:inbound>true</tran:inbound>
    <tran:inbound-properties/>
    <tran:all-headers>true</tran:all-headers>
  </ser:endpointConfig>
  <ser:router errorHandler="_onErrorHandler-5861678652477054474-14066f34.16afb18db2e.-3293">
    <con:pipeline type="request" name="ConsultaPuntosLealtad_request" xmlns:con="http://www.bea.com/wli/sb/pipeline/config">
      <con:stage name="ValidacionXSD">
        <con:context>
          <con4:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/programaLealtadTypes" prefix="prog" xmlns:con4="http://www.bea.com/wli/sb/stages/config"/>
        </con:context>
        <con:actions>
          <con1:validate>
            <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-9085855897659605180-1cf2a77.1795d71885a.-7e38</con4:id>
            <con1:schema ref="Middleware/v2/Resources/ProgramaLealtad/xsd/programaLealtadTypes"/>
            <con1:schemaElement xmlns:prog="http://www.ficohsa.com.hn/middleware.services/programaLealtadTypes">prog:consultaPuntosLealtad</con1:schemaElement>
            <con1:varName>body</con1:varName>
            <con1:location>
              <con4:xpathText xmlns:con4="http://www.bea.com/wli/sb/stages/config">./prog:consultaPuntosLealtad</con4:xpathText>
            </con1:location>
          </con1:validate>
        </con:actions>
      </con:stage>
      <con:stage name="ConsultaPuntosLealtad">
        <con:context>
          <con4:userNsDecl namespace="http://xmlns.oracle.com/pcbpel/adapter/db/sp/consultaPuntosLealtad" prefix="con1" xmlns:con4="http://www.bea.com/wli/sb/stages/config"/>
          <con4:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/autType" prefix="aut" xmlns:con4="http://www.bea.com/wli/sb/stages/config"/>
          <con4:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/programaLealtadTypes" prefix="prog" xmlns:con4="http://www.bea.com/wli/sb/stages/config"/>
        </con:context>
        <con:actions>
          <con1:wsCallout>
            <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7f3e</con4:id>
            <con1:service xsi:type="ref:BusinessServiceRef" ref="Middleware/v2/BusinessServices/CLIENTDATA/consultaPuntosLealtad/biz/consultaPuntosLealtad_db" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
            <con1:operation>consultaPuntosLealtad</con1:operation>
            <con1:request>
              <con1:body>$REQconsultaPuntosLealtad</con1:body>
            </con1:request>
            <con1:response>
              <con1:body>RSPconsultaPuntosLealtad</con1:body>
            </con1:response>
            <con1:requestTransform>
              <con1:assign varName="REQconsultaPuntosLealtad">
                <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7f06</con4:id>
                <con1:expr>
                  <con4:xqueryTransform xmlns:con4="http://www.bea.com/wli/sb/stages/config">
                    <con4:resource ref="Middleware/v2/Resources/ConsultaPuntosLealtad/xq/consultaPuntosLealtadIn"/>
                    <con4:param name="requestHeader">
                      <con4:path>$header/aut:RequestHeader</con4:path>
                    </con4:param>
                    <con4:param name="consultaPuntosLealtad">
                      <con4:path>$body/prog:consultaPuntosLealtad</con4:path>
                    </con4:param>
                  </con4:xqueryTransform>
                </con1:expr>
              </con1:assign>
            </con1:requestTransform>
            <con1:responseTransform>
              <con1:assign varName="errorCode">
                <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7ece</con4:id>
                <con1:expr>
                  <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">string($RSPconsultaPuntosLealtad/con1:PV_CODIGO_ERROR/text())</con4:xqueryText>
                </con1:expr>
              </con1:assign>
              <con1:assign varName="validationMessage">
                <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7eb1</con4:id>
                <con1:expr>
                  <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">string($RSPconsultaPuntosLealtad/con1:PV_MENSAJE_ERROR/text())</con4:xqueryText>
                </con1:expr>
              </con1:assign>
              <con1:assign varName="legalId">
                <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7e94</con4:id>
                <con1:expr>
                  <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">string($RSPconsultaPuntosLealtad/con1:PT_PUNTOS_LEALTAD/con1:LEGAL_ID/text())</con4:xqueryText>
                </con1:expr>
              </con1:assign>
              <con1:assign varName="availablePoints">
                <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7e77</con4:id>
                <con1:expr>
                  <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">data($RSPconsultaPuntosLealtad/con1:PT_PUNTOS_LEALTAD/con1:BALANCE)</con4:xqueryText>
                </con1:expr>
              </con1:assign>
              <con1:assign varName="customerName">
                <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7e5a</con4:id>
                <con1:expr>
                  <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">string($RSPconsultaPuntosLealtad/con1:PT_PUNTOS_LEALTAD/con1:CUSTOMER_NAME/text())</con4:xqueryText>
                </con1:expr>
              </con1:assign>
              <con1:assign varName="cashEquivalent">
                <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7e07</con4:id>
                <con1:expr>
                  <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">data($RSPconsultaPuntosLealtad/con1:PT_PUNTOS_LEALTAD/con1:CASH_EQUIVALENT)</con4:xqueryText>
                </con1:expr>
              </con1:assign>
              <con1:assign varName="cashCurrency">
                <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7dea</con4:id>
                <con1:expr>
                  <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">for $CASH_CURRENCY in $RSPconsultaPuntosLealtad/con1:PT_PUNTOS_LEALTAD/con1:CASH_CURRENCY
return(
	if(string($CASH_CURRENCY/text()) != "") then (
		data($CASH_CURRENCY)
	) else ('')
)</con4:xqueryText>
                </con1:expr>
              </con1:assign>
            </con1:responseTransform>
          </con1:wsCallout>
        </con:actions>
      </con:stage>
      <con:stage name="ConsultaInformacionCliente">
        <con:context>
          <con4:userNsDecl namespace="http://xmlns.oracle.com/pcbpel/adapter/db/sp/consultaPuntosLealtad" prefix="con1" xmlns:con4="http://www.bea.com/wli/sb/stages/config"/>
          <con1:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/programaLealtadTypes" prefix="prog" xmlns:con1="http://www.bea.com/wli/sb/stages/config"/>
          <con1:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/autType" prefix="aut" xmlns:con1="http://www.bea.com/wli/sb/stages/config"/>
          <con1:varNsDecl namespace="http://xmlns.oracle.com/pcbpel/adapter/db/sp/conDatoCuenta" prefix="con" xmlns:con1="http://www.bea.com/wli/sb/stages/config"/>
        </con:context>
        <con:actions>
          <con1:ifThenElse>
            <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d7a</con4:id>
            <con1:case>
              <con1:condition>
                <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">not(exists($RSPconsultaPuntosLealtad/con1:PT_PUNTOS_LEALTAD/con1:BALANCE))</con4:xqueryText>
              </con1:condition>
              <con1:actions>
                <con1:assign varName="customerIdType">
                  <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d78</con4:id>
                  <con1:expr>
                    <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">fn:string($body/prog:consultaPuntosLealtad/CUSTOMER_ID_TYPE/text())</con2:xqueryText>
                  </con1:expr>
                </con1:assign>
                <con1:assign varName="customerIdValue">
                  <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d76</con4:id>
                  <con1:expr>
                    <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">fn:string($body/prog:consultaPuntosLealtad/CUSTOMER_ID_VALUE/text())</con2:xqueryText>
                  </con1:expr>
                </con1:assign>
                <con1:ifThenElse>
                  <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d61</con4:id>
                  <con1:case>
                    <con1:condition>
                      <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">$customerIdType = "CARD_NUMBER"</con2:xqueryText>
                    </con1:condition>
                    <con1:actions>
                      <con1:assign varName="codigoPais">
                        <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d60</con4:id>
                        <con1:expr>
                          <con2:xqueryTransform xmlns:con2="http://www.bea.com/wli/sb/stages/config">
                            <con2:resource ref="Middleware/v2/Resources/Generales/xq/convertirCodigoPais"/>
                            <con2:param name="sentidoConversion">
                              <con2:path>'OSB-ISO3'</con2:path>
                            </con2:param>
                            <con2:param name="codigoPais">
                              <con2:path>fn:string($header/aut:RequestHeader/Region/SourceBank/text())</con2:path>
                            </con2:param>
                          </con2:xqueryTransform>
                        </con1:expr>
                      </con1:assign>
                      <con1:wsCallout>
                        <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d5b</con4:id>
                        <con1:service xsi:type="ref:BusinessServiceRef" ref="Middleware/v2/BusinessServices/MasterDataPA/conDatoCuenta/biz/conDatoCuenta_db" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con1:operation>conDatoCuenta</con1:operation>
                        <con1:request>
                          <con1:body>$REQconDatoCuenta</con1:body>
                        </con1:request>
                        <con1:response>
                          <con1:body>RSPconDatoCuenta</con1:body>
                        </con1:response>
                        <con1:requestTransform>
                          <con1:assign varName="REQconDatoCuenta">
                            <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d5f</con4:id>
                            <con1:expr>
                              <con2:xqueryTransform xmlns:con2="http://www.bea.com/wli/sb/stages/config">
                                <con2:resource ref="Middleware/v2/Resources/MasterDataPA/xq/conDatoCuentaPAIn"/>
                                <con2:param name="accountNumber">
                                  <con2:path>$customerIdValue</con2:path>
                                </con2:param>
                                <con2:param name="countryCode">
                                  <con2:path>$codigoPais</con2:path>
                                </con2:param>
                                <con2:param name="org">
                                  <con2:path>''</con2:path>
                                </con2:param>
                              </con2:xqueryTransform>
                            </con1:expr>
                          </con1:assign>
                          <con1:validate>
                            <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d5e</con4:id>
                            <con1:schema ref="Middleware/v2/BusinessServices/MasterDataPA/conDatoCuenta/xsd/conDatoCuenta_sp"/>
                            <con1:schemaElement xmlns:con="http://xmlns.oracle.com/pcbpel/adapter/db/sp/conDatoCuenta">con:InputParameters</con1:schemaElement>
                            <con1:varName>REQconDatoCuenta</con1:varName>
                          </con1:validate>
                        </con1:requestTransform>
                        <con1:responseTransform>
                          <con1:assign varName="errorCode">
                            <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d5d</con4:id>
                            <con1:expr>
                              <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">fn:string($RSPconDatoCuenta/con:CodigoError/text())</con2:xqueryText>
                            </con1:expr>
                          </con1:assign>
                          <con1:assign varName="validationMessage">
                            <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d5c</con4:id>
                            <con1:expr>
                              <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">if($errorCode =  '-1')then(
	''
)else(
	fn:string($RSPconDatoCuenta/con:MensajeError/text())
	)</con2:xqueryText>
                            </con1:expr>
                          </con1:assign>
                        </con1:responseTransform>
                      </con1:wsCallout>
                      <con1:ifThenElse>
                        <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d5a</con4:id>
                        <con1:case>
                          <con1:condition>
                            <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">$validationMessage = ''</con2:xqueryText>
                          </con1:condition>
                          <con1:actions>
                            <con1:assign varName="registroDatoCuenta">
                              <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d59</con4:id>
                              <con1:expr>
                                <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">let $rowAlt := $RSPconDatoCuenta/con:RowSet[1]/con:Row[1][con:Column/@name='TipoOrg' and con:Column/text() = 'ALT']
let $rowBase := $RSPconDatoCuenta/con:RowSet[1]/con:Row[1][con:Column/@name='TipoOrg' and con:Column/text() = 'BASE']
return
	(
		if(fn:count($rowAlt) > 0) then
			( $rowAlt ) else
				( $rowBase )
	)</con2:xqueryText>
                              </con1:expr>
                            </con1:assign>
                            <con1:assign varName="customerId">
                              <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d58</con4:id>
                              <con1:expr>
                                <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">fn:string($RSPconDatoCuenta/con:RowSet[1]/con:Row[1]/con:Column[@name='CUST_NBR']/text())</con2:xqueryText>
                              </con1:expr>
                            </con1:assign>
                            <con1:assign varName="customerName">
                              <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d57</con4:id>
                              <con1:expr>
                                <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">fn:string($RSPconDatoCuenta/con:RowSet[1]/con:Row[1]/con:Column[@name='nombre_cliente']/text())</con2:xqueryText>
                              </con1:expr>
                            </con1:assign>
                            <con1:assign varName="legalId">
                              <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d56</con4:id>
                              <con1:expr>
                                <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">fn:string($RSPconDatoCuenta/con:RowSet[1]/con:Row[1]/con:Column[@name='legal_id']/text())</con2:xqueryText>
                              </con1:expr>
                            </con1:assign>
                            <con1:assign varName="logo">
                              <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d55</con4:id>
                              <con1:expr>
                                <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">fn:string($RSPconDatoCuenta/con:RowSet[1]/con:Row[1]/con:Column[@name='logo']/text())</con2:xqueryText>
                              </con1:expr>
                            </con1:assign>
                            <con1:assign varName="org">
                              <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d54</con4:id>
                              <con1:expr>
                                <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">string($registroDatoCuenta/con:Column[@name='ORG']/text())</con2:xqueryText>
                              </con1:expr>
                            </con1:assign>
                            <con1:assign varName="accountNumber">
                              <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d53</con4:id>
                              <con1:expr>
                                <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">string($registroDatoCuenta/con:Column[@name='LMS_ACC']/text())</con2:xqueryText>
                              </con1:expr>
                            </con1:assign>
                            <con1:assign varName="scheme">
                              <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d52</con4:id>
                              <con1:expr>
                                <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">string($registroDatoCuenta/con:Column[@name='LMS_Scheme']/text())</con2:xqueryText>
                              </con1:expr>
                            </con1:assign>
                          </con1:actions>
                        </con1:case>
                        <con1:default>
                          <con2:skip xmlns:con2="http://www.bea.com/wli/sb/stages/config">
                            <con2:id>_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d51</con2:id>
                          </con2:skip>
                        </con1:default>
                      </con1:ifThenElse>
                    </con1:actions>
                  </con1:case>
                  <con1:default>
                    <con1:assign varName="errorCode">
                      <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d50</con4:id>
                      <con1:expr>
                        <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">'ERROR'</con2:xqueryText>
                      </con1:expr>
                    </con1:assign>
                    <con1:assign varName="validationMessage">
                      <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d4f</con4:id>
                      <con1:expr>
                        <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">'CUSTOMER_ID_TYPE no soportado'</con2:xqueryText>
                      </con1:expr>
                    </con1:assign>
                    <con2:skip xmlns:con2="http://www.bea.com/wli/sb/stages/config">
                      <con2:id>_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d4e</con2:id>
                    </con2:skip>
                  </con1:default>
                </con1:ifThenElse>
              </con1:actions>
            </con1:case>
            <con1:default/>
          </con1:ifThenElse>
        </con:actions>
      </con:stage>
      <con:stage name="ObtenerParametrizacion">
        <con:context>
          <con4:userNsDecl namespace="http://xmlns.oracle.com/pcbpel/adapter/db/sp/consultaPuntosLealtad" prefix="con1" xmlns:con4="http://www.bea.com/wli/sb/stages/config"/>
          <con1:varNsDecl namespace="http://xmlns.oracle.com/pcbpel/adapter/db/ORA_BANK/OSB_GET_CONFIG/" prefix="osb" xmlns:con1="http://www.bea.com/wli/sb/stages/config"/>
        </con:context>
        <con:actions>
          <con1:ifThenElse>
            <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3f68</con2:id>
            <con1:case>
              <con1:condition>
                <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">not(exists($RSPconsultaPuntosLealtad/con1:PT_PUNTOS_LEALTAD/con1:BALANCE)) and $validationMessage = ""</con4:xqueryText>
              </con1:condition>
              <con1:actions>
                <con1:ifThenElse>
                  <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3f67</con2:id>
                  <con1:case>
                    <con1:condition>
                      <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">$logo != ""</con2:xqueryText>
                    </con1:condition>
                    <con1:actions>
                      <con1:wsCallout>
                        <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3f61</con2:id>
                        <con1:service xsi:type="ref:BusinessServiceRef" ref="Middleware/Business_Resources/general/Resources/ObtenerParametrizacion/ObtenerParametrizacion" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con1:operation>obtenerParametrizacion</con1:operation>
                        <con1:request>
                          <con1:body>$REQobtenerParametrizacion</con1:body>
                        </con1:request>
                        <con1:response>
                          <con1:body>RSPobtenerParametrizacion</con1:body>
                        </con1:response>
                        <con1:requestTransform>
                          <con1:assign varName="institutionNameParameter">
                            <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3f66</con2:id>
                            <con1:expr>
                              <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">'FICBCO0229.MRS.INSTITUTION.NAME'</con2:xqueryText>
                            </con1:expr>
                          </con1:assign>
                          <con1:assign varName="REQobtenerParametrizacion">
                            <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3f65</con2:id>
                            <con1:expr>
                              <con2:xqueryTransform xmlns:con2="http://www.bea.com/wli/sb/stages/config">
                                <con2:resource ref="Middleware/Business_Resources/general/Parametrizacion/obtenerParametrizacionIn"/>
                                <con2:param name="nombreParametros">
                                  <con2:path>$institutionNameParameter</con2:path>
                                </con2:param>
                              </con2:xqueryTransform>
                            </con1:expr>
                          </con1:assign>
                        </con1:requestTransform>
                        <con1:responseTransform>
                          <con1:assign varName="errorCode">
                            <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3f64</con2:id>
                            <con1:expr>
                              <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">fn:string($RSPobtenerParametrizacion/osb:ERROR_CODE/text())</con2:xqueryText>
                            </con1:expr>
                          </con1:assign>
                          <con1:assign varName="validationMessage">
                            <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3f63</con2:id>
                            <con1:expr>
                              <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">fn:string($RSPobtenerParametrizacion/osb:ERROR_MESSAGE/text())</con2:xqueryText>
                            </con1:expr>
                          </con1:assign>
                          <con1:assign varName="institutionName">
                            <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3f62</con2:id>
                            <con1:expr>
                              <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">if($validationMessage = "") then (
	fn:string($RSPobtenerParametrizacion/osb:CONFIGURACIONES/osb:CONFIGURACIONES_ITEM[ osb:NAME = $institutionNameParameter ]/osb:VALUE/text())
) else (
	""
)</con2:xqueryText>
                            </con1:expr>
                          </con1:assign>
                        </con1:responseTransform>
                      </con1:wsCallout>
                    </con1:actions>
                  </con1:case>
                  <con1:default>
                    <con1:assign varName="errorCode">
                      <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3f60</con2:id>
                      <con1:expr>
                        <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">'ERROR'</con2:xqueryText>
                      </con1:expr>
                    </con1:assign>
                    <con1:assign varName="validationMessage">
                      <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3f5f</con2:id>
                      <con1:expr>
                        <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">"No se encontr√≥ logo para la tarjeta."</con2:xqueryText>
                      </con1:expr>
                    </con1:assign>
                    <con2:skip xmlns:con2="http://www.bea.com/wli/sb/stages/config">
                      <con2:id>_ActionId-5861678652477054474-14066f34.16afb18db2e.-3f5e</con2:id>
                    </con2:skip>
                  </con1:default>
                </con1:ifThenElse>
              </con1:actions>
            </con1:case>
            <con1:default>
              <con2:skip xmlns:con2="http://www.bea.com/wli/sb/stages/config">
                <con2:id>_ActionId-5861678652477054474-14066f34.16afb18db2e.-3f5d</con2:id>
              </con2:skip>
            </con1:default>
          </con1:ifThenElse>
        </con:actions>
      </con:stage>
      <con:stage name="ConsultaProgramaLealtad">
        <con:context>
          <con4:userNsDecl namespace="http://xmlns.oracle.com/pcbpel/adapter/db/sp/consultaPuntosLealtad" prefix="con1" xmlns:con4="http://www.bea.com/wli/sb/stages/config"/>
          <con1:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/autType" prefix="aut" xmlns:con1="http://www.bea.com/wli/sb/stages/config"/>
          <con1:varNsDecl namespace="http://xmlns.oracle.com/pcbpel/adapter/db/sp/consultaProgramaLealtad" prefix="con" xmlns:con1="http://www.bea.com/wli/sb/stages/config"/>
        </con:context>
        <con:actions>
          <con1:ifThenElse>
            <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3f55</con2:id>
            <con1:case>
              <con1:condition>
                <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">not(exists($RSPconsultaPuntosLealtad/con1:PT_PUNTOS_LEALTAD/con1:BALANCE)) and $validationMessage = ""</con4:xqueryText>
              </con1:condition>
              <con1:actions>
                <con1:wsCallout>
                  <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3f50</con2:id>
                  <con1:service xsi:type="ref:BusinessServiceRef" ref="Middleware/v2/BusinessServices/INTFC/consultaProgramaLealtad/biz/consultaProgramaLealtad_db" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                  <con1:operation>consultaProgramaLealtad</con1:operation>
                  <con1:request>
                    <con1:body>$REQconsultaProgramaLealtad</con1:body>
                  </con1:request>
                  <con1:response>
                    <con1:body>RSPconsultaProgramaLealtad</con1:body>
                  </con1:response>
                  <con1:requestTransform>
                    <con1:assign varName="REQconsultaProgramaLealtad">
                      <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3f54</con2:id>
                      <con1:expr>
                        <con2:xqueryTransform xmlns:con2="http://www.bea.com/wli/sb/stages/config">
                          <con2:resource ref="Middleware/v2/Resources/ProgramaLealtad/xq/consultaProgramaLealtadIn"/>
                          <con2:param name="logo">
                            <con2:path>$logo</con2:path>
                          </con2:param>
                          <con2:param name="codigoPais">
                            <con2:path>fn:string($header/aut:RequestHeader/Region/SourceBank/text())</con2:path>
                          </con2:param>
                        </con2:xqueryTransform>
                      </con1:expr>
                    </con1:assign>
                  </con1:requestTransform>
                  <con1:responseTransform>
                    <con1:assign varName="errorCode">
                      <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3f53</con2:id>
                      <con1:expr>
                        <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">string($RSPconsultaProgramaLealtad/con:PV_CODIGOMENSAJE/text())</con2:xqueryText>
                      </con1:expr>
                    </con1:assign>
                    <con1:assign varName="validationMessage">
                      <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3f52</con2:id>
                      <con1:expr>
                        <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">string($RSPconsultaProgramaLealtad/con:PV_DESCRIPCIONMENSAJE/text())</con2:xqueryText>
                      </con1:expr>
                    </con1:assign>
                    <con1:assign varName="programaLealtad">
                      <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3f51</con2:id>
                      <con1:expr>
                        <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">if($validationMessage = "") then (
	string($RSPconsultaProgramaLealtad/con:PV_CODIGOLEALTAD/text())
) else ( '' )</con2:xqueryText>
                      </con1:expr>
                    </con1:assign>
                  </con1:responseTransform>
                </con1:wsCallout>
              </con1:actions>
            </con1:case>
            <con1:default>
              <con2:skip xmlns:con2="http://www.bea.com/wli/sb/stages/config">
                <con2:id>_ActionId-5861678652477054474-14066f34.16afb18db2e.-3f4f</con2:id>
              </con2:skip>
            </con1:default>
          </con1:ifThenElse>
        </con:actions>
      </con:stage>
      <con:stage name="ConsultaPuntos" errorHandler="_onErrorHandler-9093894123929216395-d318143.16d075d4c4d.-78af">
        <con:context>
          <con4:userNsDecl namespace="http://xmlns.oracle.com/pcbpel/adapter/db/sp/consultaPuntosLealtad" prefix="con1" xmlns:con4="http://www.bea.com/wli/sb/stages/config"/>
          <con1:varNsDecl namespace="http://customer.ws.mcrewards.mastercard.com/" prefix="cus" xmlns:con1="http://www.bea.com/wli/sb/stages/config"/>
          <con2:varNsDecl namespace="http://www.procesa.com/fdcs" prefix="fdcs" xmlns:con2="http://www.bea.com/wli/sb/stages/config"/>
        </con:context>
        <con:actions>
          <con1:ifThenElse>
            <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3f17</con2:id>
            <con1:case>
              <con1:condition>
                <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">not(exists($RSPconsultaPuntosLealtad/con1:PT_PUNTOS_LEALTAD/con1:BALANCE)) and $validationMessage = ""</con4:xqueryText>
              </con1:condition>
              <con1:actions>
                <con1:ifThenElse>
                  <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3edf</con2:id>
                  <con1:case>
                    <con1:condition>
                      <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">$programaLealtad = "1"</con2:xqueryText>
                    </con1:condition>
                    <con1:actions>
                      <con1:wsCallout>
                        <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3ea7</con2:id>
                        <con1:service xsi:type="ref:BusinessServiceRef" ref="Middleware/v2/BusinessServices/Mastercard/CustomerService/biz/CustomerService" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con1:operation>getPointDetails</con1:operation>
                        <con1:request>
                          <con1:body>$REQgetPointDetails</con1:body>
                          <con1:header>$REQHeadergetPointDetails</con1:header>
                        </con1:request>
                        <con1:response>
                          <con1:body>RSPgetPointDetails</con1:body>
                          <con1:header>RSPHeadergetPointDetails</con1:header>
                        </con1:response>
                        <con1:requestTransform>
                          <con1:assign varName="REQHeadergetPointDetails">
                            <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3e35</con2:id>
                            <con1:expr>
                              <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">&lt;soap-env:Header/></con2:xqueryText>
                            </con1:expr>
                          </con1:assign>
                          <con1:replace varName="REQHeadergetPointDetails" contents-only="true">
                            <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-36a2</con2:id>
                            <con1:expr>
                              <con2:xqueryTransform xmlns:con2="http://www.bea.com/wli/sb/stages/config">
                                <con2:resource ref="Middleware/v2/Resources/ProgramaLealtad/xq/MRSIdentity"/>
                                <con2:param name="institutionName">
                                  <con2:path>$institutionName</con2:path>
                                </con2:param>
                                <con2:param name="appID">
                                  <con2:path>$legalId</con2:path>
                                </con2:param>
                              </con2:xqueryTransform>
                            </con1:expr>
                          </con1:replace>
                          <con1:assign varName="REQgetPointDetails">
                            <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3dfb</con2:id>
                            <con1:expr>
                              <con2:xqueryTransform xmlns:con2="http://www.bea.com/wli/sb/stages/config">
                                <con2:resource ref="Middleware/v2/Resources/ConsultaPuntosLealtad/xq/getPointDetailsInPA"/>
                              </con2:xqueryTransform>
                            </con1:expr>
                          </con1:assign>
                        </con1:requestTransform>
                        <con1:responseTransform>
                          <con1:assign varName="availablePoints">
                            <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3dc3</con2:id>
                            <con1:expr>
                              <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">data($RSPgetPointDetails/cus:AvailablePoints)</con2:xqueryText>
                            </con1:expr>
                          </con1:assign>
                        </con1:responseTransform>
                      </con1:wsCallout>
                    </con1:actions>
                  </con1:case>
                  <con1:case>
                    <con1:condition>
                      <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">$programaLealtad = "2"</con2:xqueryText>
                    </con1:condition>
                    <con1:actions>
                      <con1:wsCallout>
                        <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-37ba</con2:id>
                        <con1:service xsi:type="ref:BusinessServiceRef" ref="Middleware/v2/BusinessServices/VisionPlus/visionPlus/biz/visionPlus" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con1:operation>PointsAdjustmentInquiry</con1:operation>
                        <con1:request>
                          <con1:body>$REQPointsAdjustmentInquiry</con1:body>
                        </con1:request>
                        <con1:response>
                          <con1:body>RSPPointsAdjustmentInquiry</con1:body>
                        </con1:response>
                        <con1:requestTransform>
                          <con1:assign varName="REQPointsAdjustmentInquiry">
                            <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3748</con2:id>
                            <con1:expr>
                              <con2:xqueryTransform xmlns:con2="http://www.bea.com/wli/sb/stages/config">
                                <con2:resource ref="Middleware/v2/Resources/VisionPlus/xq/pointsAdjustmentInquiryIn"/>
                                <con2:param name="accountNumber">
                                  <con2:path>$accountNumber</con2:path>
                                </con2:param>
                                <con2:param name="scheme">
                                  <con2:path>$scheme</con2:path>
                                </con2:param>
                                <con2:param name="org">
                                  <con2:path>$org</con2:path>
                                </con2:param>
                              </con2:xqueryTransform>
                            </con1:expr>
                          </con1:assign>
                          <con1:validate>
                            <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-374a</con2:id>
                            <con1:schema ref="Middleware/v2/BusinessServices/VisionPlus/visionPlus/xsd/XMLSchema_769155616"/>
                            <con1:schemaElement xmlns:fdcs="http://www.procesa.com/fdcs">fdcs:PointsAdjustmentInquiryRequest</con1:schemaElement>
                            <con1:varName>REQPointsAdjustmentInquiry</con1:varName>
                          </con1:validate>
                        </con1:requestTransform>
                        <con1:responseTransform>
                          <con1:assign varName="errorCode">
                            <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3668</con2:id>
                            <con1:expr>
                              <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">fn-bea:trim(string($RSPPointsAdjustmentInquiry/fdcs:ReturnCodes/RC/Code/text()))</con2:xqueryText>
                            </con1:expr>
                          </con1:assign>
                          <con1:assign varName="validationMessage">
                            <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-366a</con2:id>
                            <con1:expr>
                              <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">let $svcReturn := string($RSPPointsAdjustmentInquiry/SVC-RETURN/text())
return
if($svcReturn != "P") then (
	 fn-bea:trim(string($RSPPointsAdjustmentInquiry/fdcs:ReturnCodes/RC/Desc/text()))
)else(
	''
)</con2:xqueryText>
                            </con1:expr>
                          </con1:assign>
                          <con1:assign varName="availablePoints">
                            <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3615</con2:id>
                            <con1:expr>
                              <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">let $available := fn-bea:trim(string($RSPPointsAdjustmentInquiry/GPXAIO-OPEN-TO-RED-ON-SCR/text()))
return
if($available != "")then(
	xs:decimal($available) div 1000
)else(
	0
)</con2:xqueryText>
                            </con1:expr>
                          </con1:assign>
                        </con1:responseTransform>
                      </con1:wsCallout>
                    </con1:actions>
                  </con1:case>
                  <con1:default>
                    <con1:assign varName="errorCode">
                      <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3cad</con2:id>
                      <con1:expr>
                        <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">'ERROR'</con2:xqueryText>
                      </con1:expr>
                    </con1:assign>
                    <con1:assign varName="validationMessage">
                      <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3caf</con2:id>
                      <con1:expr>
                        <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">'Programa de lealtad no soportado'</con2:xqueryText>
                      </con1:expr>
                    </con1:assign>
                  </con1:default>
                </con1:ifThenElse>
              </con1:actions>
            </con1:case>
            <con1:default/>
          </con1:ifThenElse>
        </con:actions>
      </con:stage>
      <con:stage name="EquivalenciaEfectivo">
        <con:context>
          <con4:userNsDecl namespace="http://xmlns.oracle.com/pcbpel/adapter/db/sp/consultaPuntosLealtad" prefix="con1" xmlns:con4="http://www.bea.com/wli/sb/stages/config"/>
          <con2:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/programaLealtadTypes" prefix="prog" xmlns:con2="http://www.bea.com/wli/sb/stages/config"/>
          <con2:varNsDecl namespace="http://xmlns.oracle.com/pcbpel/adapter/db/sp/canjearPuntosEfectivo" prefix="can" xmlns:con2="http://www.bea.com/wli/sb/stages/config"/>
        </con:context>
        <con:actions>
          <con1:ifThenElse>
            <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d46</con4:id>
            <con1:case>
              <con1:condition>
                <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">fn:string($body/prog:consultaPuntosLealtad/RETURN_CASH_EQUIVALENT/text()) = "YES"
and xs:decimal($availablePoints) > xs:decimal(0) and $validationMessage = "" and not(exists($RSPconsultaPuntosLealtad/con1:PT_PUNTOS_LEALTAD/con1:BALANCE))</con4:xqueryText>
              </con1:condition>
              <con1:actions>
                <con1:wsCallout>
                  <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d42</con4:id>
                  <con1:service xsi:type="ref:BusinessServiceRef" ref="Middleware/v2/BusinessServices/PXYNIC/canjearPuntosEfectivo/biz/canjearPuntosEfectivo_db" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                  <con1:operation>canjearPuntosEfectivo</con1:operation>
                  <con1:request>
                    <con1:body>$REQcanjearPuntosEfectivo</con1:body>
                  </con1:request>
                  <con1:response>
                    <con1:body>RSPcanjearPuntosEfectivo</con1:body>
                  </con1:response>
                  <con1:requestTransform>
                    <con1:assign varName="REQcanjearPuntosEfectivo">
                      <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d45</con4:id>
                      <con1:expr>
                        <con2:xqueryTransform xmlns:con2="http://www.bea.com/wli/sb/stages/config">
                          <con2:resource ref="Middleware/v2/Resources/ProgramaLealtad/xq/conversionPuntosNIIn"/>
                          <con2:param name="logo">
                            <con2:path>$logo</con2:path>
                          </con2:param>
                          <con2:param name="tipoConversion">
                            <con2:path>"1"</con2:path>
                          </con2:param>
                          <con2:param name="cashRedemptionType1">
                            <con2:path>$body/prog:consultaPuntosLealtad/CASH_REDEMPTION</con2:path>
                          </con2:param>
                          <con2:param name="montoConversion">
                            <con2:path>$availablePoints</con2:path>
                          </con2:param>
                        </con2:xqueryTransform>
                      </con1:expr>
                    </con1:assign>
                  </con1:requestTransform>
                  <con1:responseTransform>
                    <con1:assign varName="errorCode">
                      <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d44</con4:id>
                      <con1:expr>
                        <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">fn:string($RSPcanjearPuntosEfectivo/can:PV_CODIGOMENSAJE/text())</con2:xqueryText>
                      </con1:expr>
                    </con1:assign>
                    <con1:assign varName="validationMessage">
                      <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d43</con4:id>
                      <con1:expr>
                        <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">if (fn:upper-case($RSPcanjearPuntosEfectivo/can:PV_CODIGOMENSAJE/text()) = "SUCCESS") then (
	""
) else (
	fn:string($RSPcanjearPuntosEfectivo/can:PV_DESCRIPCIONMENSAJE/text())
)</con2:xqueryText>
                      </con1:expr>
                    </con1:assign>
                    <con1:assign varName="cashEquivalent">
                      <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7bbe</con4:id>
                      <con1:expr>
                        <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">data($RSPcanjearPuntosEfectivo/can:PN_VALORSALIDA)</con4:xqueryText>
                      </con1:expr>
                    </con1:assign>
                    <con1:assign varName="cashCurrency">
                      <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7ba1</con4:id>
                      <con1:expr>
                        <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">'USD'</con4:xqueryText>
                      </con1:expr>
                    </con1:assign>
                  </con1:responseTransform>
                </con1:wsCallout>
              </con1:actions>
            </con1:case>
            <con1:default>
              <con1:assign varName="RSPcanjearPuntosEfectivo">
                <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d41</con4:id>
                <con1:expr>
                  <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config"><![CDATA[<can:OutputParameters>
	<can:PN_VALORSALIDA/>
	<can:PN_FACTORCANJE/>
	<can:PV_CODIGOMENSAJE/>
	<can:PV_DESCRIPCIONMENSAJE/>
</can:OutputParameters>]]></con2:xqueryText>
                </con1:expr>
              </con1:assign>
              <con2:skip xmlns:con2="http://www.bea.com/wli/sb/stages/config">
                <con2:id>_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7d40</con2:id>
              </con2:skip>
            </con1:default>
          </con1:ifThenElse>
        </con:actions>
      </con:stage>
      <con:stage name="RegistraPuntosLealtad">
        <con:context>
          <con4:userNsDecl namespace="http://xmlns.oracle.com/pcbpel/adapter/db/sp/consultaPuntosLealtad" prefix="con1" xmlns:con4="http://www.bea.com/wli/sb/stages/config"/>
          <con4:userNsDecl namespace="http://xmlns.oracle.com/pcbpel/adapter/db/sp/registraPuntosLealtad" prefix="reg" xmlns:con4="http://www.bea.com/wli/sb/stages/config"/>
          <con4:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/autType" prefix="aut" xmlns:con4="http://www.bea.com/wli/sb/stages/config"/>
          <con4:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/programaLealtadTypes" prefix="prog" xmlns:con4="http://www.bea.com/wli/sb/stages/config"/>
        </con:context>
        <con:actions>
          <con1:ifThenElse>
            <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7c66</con4:id>
            <con1:case>
              <con1:condition>
                <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">upper-case($RSPconsultaPuntosLealtad/con1:PV_CODIGO_ERROR/text()) != "SUCCESS" and $validationMessage = ""</con4:xqueryText>
              </con1:condition>
              <con1:actions>
                <con1:wsCallout>
                  <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7c2e</con4:id>
                  <con1:service xsi:type="ref:BusinessServiceRef" ref="Middleware/v2/BusinessServices/CLIENTDATA/registraPuntosLealtad/biz/registraPuntosLealtad_db" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                  <con1:operation>registraPuntosLealtad</con1:operation>
                  <con1:request>
                    <con1:body>$REQregistraPuntosLealtad</con1:body>
                  </con1:request>
                  <con1:response>
                    <con1:body>RSPregistraPuntosLealtad</con1:body>
                  </con1:response>
                  <con1:requestTransform>
                    <con1:assign varName="REQregistraPuntosLealtad">
                      <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7bf6</con4:id>
                      <con1:expr>
                        <con4:xqueryTransform xmlns:con4="http://www.bea.com/wli/sb/stages/config">
                          <con4:resource ref="Middleware/v2/Resources/ConsultaPuntosLealtad/xq/registraPuntosLealtadIn"/>
                          <con4:param name="cashEquivalent">
                            <con4:path>$cashEquivalent</con4:path>
                          </con4:param>
                          <con4:param name="customerName">
                            <con4:path>$customerName</con4:path>
                          </con4:param>
                          <con4:param name="balance">
                            <con4:path>$availablePoints</con4:path>
                          </con4:param>
                          <con4:param name="requestHeader">
                            <con4:path>$header/aut:RequestHeader</con4:path>
                          </con4:param>
                          <con4:param name="consultaPuntosLealtad">
                            <con4:path>$body/prog:consultaPuntosLealtad</con4:path>
                          </con4:param>
                          <con4:param name="cashCurrency">
                            <con4:path>$cashCurrency</con4:path>
                          </con4:param>
                          <con4:param name="legalId">
                            <con4:path>$legalId</con4:path>
                          </con4:param>
                        </con4:xqueryTransform>
                      </con1:expr>
                    </con1:assign>
                  </con1:requestTransform>
                  <con1:responseTransform>
                    <con1:assign varName="errorCode">
                      <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7b69</con4:id>
                      <con1:expr>
                        <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">string($RSPregistraPuntosLealtad/reg:PV_CODIGO_ERROR/text())</con4:xqueryText>
                      </con1:expr>
                    </con1:assign>
                    <con1:assign varName="validationMessage">
                      <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-5922367760884589371--6d1488c0.1830ba9f51d.-7b4c</con4:id>
                      <con1:expr>
                        <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">string($RSPregistraPuntosLealtad/reg:PV_MENSAJE_ERROR/text())</con4:xqueryText>
                      </con1:expr>
                    </con1:assign>
                  </con1:responseTransform>
                </con1:wsCallout>
              </con1:actions>
            </con1:case>
            <con1:default/>
          </con1:ifThenElse>
        </con:actions>
      </con:stage>
    </con:pipeline>
    <con:pipeline type="response" name="ConsultaPuntosLealtad_response" xmlns:con="http://www.bea.com/wli/sb/pipeline/config">
      <con:stage name="FlujoSalida">
        <con:context>
          <con2:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/autType" prefix="aut" xmlns:con2="http://www.bea.com/wli/sb/stages/config"/>
          <con2:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/programaLealtadTypes" prefix="prog" xmlns:con2="http://www.bea.com/wli/sb/stages/config"/>
        </con:context>
        <con:actions>
          <con1:replace contents-only="true" varName="header">
            <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3320</con2:id>
            <con1:expr>
              <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config"><![CDATA[<aut:ResponseHeader>
{
	if($validationMessage = '') then (
		<successIndicator>Success</successIndicator>
	)else(
		<successIndicator>{ $errorCode }</successIndicator>,
		<messages>{ $validationMessage }</messages>
	)
}
</aut:ResponseHeader>]]></con2:xqueryText>
            </con1:expr>
          </con1:replace>
          <con1:ifThenElse>
            <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-3322</con2:id>
            <con1:case>
              <con1:condition>
                <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">string($header/aut:ResponseHeader/successIndicator/text()) = "Success"</con2:xqueryText>
              </con1:condition>
              <con1:actions>
                <con1:replace varName="body" contents-only="true">
                  <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-32e8</con2:id>
                  <con1:expr>
                    <con4:xqueryTransform xmlns:con4="http://www.bea.com/wli/sb/stages/config">
                      <con4:resource ref="Middleware/v2/Resources/ConsultaPuntosLealtad/xq/consultaPuntosLealtadPAOut"/>
                      <con4:param name="legalId">
                        <con4:path>$legalId</con4:path>
                      </con4:param>
                      <con4:param name="availablePoints">
                        <con4:path>$availablePoints</con4:path>
                      </con4:param>
                      <con4:param name="customerName">
                        <con4:path>$customerName</con4:path>
                      </con4:param>
                      <con4:param name="cashCurrency">
                        <con4:path>$cashCurrency</con4:path>
                      </con4:param>
                      <con4:param name="cashEquivalent">
                        <con4:path>$cashEquivalent</con4:path>
                      </con4:param>
                      <con4:param name="isCashEquivalent">
                        <con4:path>fn:string($body/prog:consultaPuntosLealtad/RETURN_CASH_EQUIVALENT/text())</con4:path>
                      </con4:param>
                    </con4:xqueryTransform>
                  </con1:expr>
                </con1:replace>
              </con1:actions>
            </con1:case>
            <con1:default>
              <con1:replace varName="body" contents-only="true">
                <con2:id xmlns:con2="http://www.bea.com/wli/sb/stages/config">_ActionId-5861678652477054474-14066f34.16afb18db2e.-32af</con2:id>
                <con1:expr>
                  <con2:xqueryText xmlns:con2="http://www.bea.com/wli/sb/stages/config">&lt;prog:consultaPuntosLealtadResponse/></con2:xqueryText>
                </con1:expr>
              </con1:replace>
            </con1:default>
          </con1:ifThenElse>
        </con:actions>
      </con:stage>
    </con:pipeline>
    <con2:pipeline type="error" name="_onErrorHandler-5861678652477054474-14066f34.16afb18db2e.-3293" xmlns:con2="http://www.bea.com/wli/sb/pipeline/config">
      <con2:stage name="ManejoError">
        <con2:context>
          <con:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/autType" prefix="aut"/>
          <con:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/programaLealtadTypes" prefix="prog"/>
        </con2:context>
        <con2:actions>
          <con1:replace contents-only="true" varName="header">
            <con:id>_ActionId-5861678652477054474-14066f34.16afb18db2e.-31eb</con:id>
            <con1:expr>
              <con:xqueryText><![CDATA[<aut:ResponseHeader>
	<messageId>-1</messageId>
	<successIndicator>ERROR</successIndicator>
	<messages>{string($fault/ctx:reason/text())}</messages>
</aut:ResponseHeader>]]></con:xqueryText>
            </con1:expr>
          </con1:replace>
          <con1:replace contents-only="true" varName="body">
            <con:id>_ActionId-5861678652477054474-14066f34.16afb18db2e.-31ed</con:id>
            <con1:expr>
              <con:xqueryText>&lt;prog:consultaPuntosLealtadResponse/></con:xqueryText>
            </con1:expr>
          </con1:replace>
          <con:reply>
            <con:id>_ActionId-5861678652477054474-14066f34.16afb18db2e.-31b1</con:id>
          </con:reply>
        </con2:actions>
      </con2:stage>
    </con2:pipeline>
    <con3:pipeline type="error" name="_onErrorHandler-9093894123929216395-d318143.16d075d4c4d.-78af">
      <con3:stage name="ManejoError_ConsultaPuntos">
        <con3:context>
          <con:userNsDecl namespace="http://www.bea.com/wli/sb/stages/transform/config" prefix="con1"/>
          <con:userNsDecl namespace="http://common.ws.mcrewards.mastercard.com/" prefix="con2"/>
        </con3:context>
        <con3:actions>
          <con1:assign varName="errorCode">
            <con:id>_ActionId-9093894123929216395-d318143.16d075d4c4d.-7841</con:id>
            <con1:expr>
              <con:xqueryText>if(exists($fault/ctx:details/con1:ReceivedFaultDetail/con1:detail/con2:ErrorResp/con2:code))then(
	string($fault/ctx:details/con1:ReceivedFaultDetail/con1:detail/con2:ErrorResp/con2:code/text())
)else(
	string($fault/ctx:errorCode/text())
)</con:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="validationMessage">
            <con:id>_ActionId-9093894123929216395-d318143.16d075d4c4d.-7824</con:id>
            <con1:expr>
              <con:xqueryText>if(exists($fault/ctx:details/con1:ReceivedFaultDetail/con1:faultstring))then(
	string($fault/ctx:details/con1:ReceivedFaultDetail/con1:faultstring/text())
)else(
	string($fault/ctx:reason/text())
)</con:xqueryText>
            </con1:expr>
          </con1:assign>
          <con:resume>
            <con:id>_ActionId-9093894123929216395-d318143.16d075d4c4d.-7807</con:id>
          </con:resume>
        </con3:actions>
      </con3:stage>
    </con3:pipeline>
    <con:flow xmlns:con="http://www.bea.com/wli/sb/pipeline/config">
      <con:pipeline-node name="ConsultaPuntosLealtad">
        <con:request>ConsultaPuntosLealtad_request</con:request>
        <con:response>ConsultaPuntosLealtad_response</con:response>
      </con:pipeline-node>
    </con:flow>
  </ser:router>
</xml-fragment>