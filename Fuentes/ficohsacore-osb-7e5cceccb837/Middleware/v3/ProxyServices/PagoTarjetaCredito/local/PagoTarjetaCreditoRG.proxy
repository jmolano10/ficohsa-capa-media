<?xml version="1.0" encoding="UTF-8"?>
<xml-fragment xmlns:ser="http://www.bea.com/wli/sb/services" xmlns:tran="http://www.bea.com/wli/sb/transports" xmlns:env="http://www.bea.com/wli/config/env" xmlns:http="http://www.bea.com/wli/sb/transports/http" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:con="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/pipeline/config" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config">
  <ser:coreEntry isProxy="true" isEnabled="true" isTracingEnabled="false">
    <ser:binding type="SOAP" isSoap12="false" xsi:type="con3:SoapBindingType" xmlns:con3="http://www.bea.com/wli/sb/services/bindings/config">
      <con3:wsdl ref="Middleware/v3/Resources/PagoTarjetaCredito/wsdl/pagoTarjetaCreditoPS"/>
      <con3:port>
        <con3:name>pagoTarjetaCreditoPSSOAP</con3:name>
        <con3:namespace>http://www.ficohsa.com.hn/middleware.services/pagoTarjetaCreditoPS/</con3:namespace>
      </con3:port>
      <con3:selector type="SOAP body"/>
      <con3:WSI-compliant>false</con3:WSI-compliant>
    </ser:binding>
    <ser:monitoring isEnabled="false">
      <ser:aggregationInterval>10</ser:aggregationInterval>
      <ser:pipelineMonitoringLevel>Pipeline</ser:pipelineMonitoringLevel>
    </ser:monitoring>
    <ser:reporting>true</ser:reporting>
    <ser:logging isEnabled="true">
      <ser:logLevel>debug</ser:logLevel>
    </ser:logging>
    <ser:sla-alerting isEnabled="true">
      <ser:alertLevel>normal</ser:alertLevel>
    </ser:sla-alerting>
    <ser:pipeline-alerting isEnabled="true">
      <ser:alertLevel>normal</ser:alertLevel>
    </ser:pipeline-alerting>
    <ser:ws-policy>
      <ser:binding-mode>wsdl-policy-attachments</ser:binding-mode>
    </ser:ws-policy>
  </ser:coreEntry>
  <ser:endpointConfig>
    <tran:provider-id>local</tran:provider-id>
    <tran:inbound>true</tran:inbound>
    <tran:inbound-properties/>
    <tran:all-headers>true</tran:all-headers>
  </ser:endpointConfig>
  <ser:router errorHandler="_onErrorHandler-2484758830309337625-6223049b.1668988c624.-64fb">
    <con2:pipeline type="error" name="_onErrorHandler-2484758830309337625-6223049b.1668988c624.-64fb">
      <con2:stage name="ManejoError">
        <con2:context xmlns:con4="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con3="http://www.bea.com/wli/sb/services/security/config">
          <con:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/consultaFICOPENTypes" prefix="con"/>
          <con:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/autType" prefix="aut"/>
          <con:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/pagoTarjetaCreditoTypes" prefix="pag"/>
        </con2:context>
        <con2:actions xmlns:con4="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con3="http://www.bea.com/wli/sb/services/security/config">
          <con1:assign varName="errorCode">
            <con:id>_ActionId-2484758830309337625-6223049b.1668988c624.-64f3</con:id>
            <con1:expr>
              <con:xqueryText>fn:string($fault/ctx:errorCode/text())</con:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="errorMessage">
            <con:id>_ActionId-2484758830309337625-6223049b.1668988c624.-64f2</con:id>
            <con1:expr>
              <con:xqueryText>fn:string($fault/ctx:reason/text())</con:xqueryText>
            </con1:expr>
          </con1:assign>
          <con5:wsCallout xmlns:con3="http://www.bea.com/wli/sb/pipeline/config" xmlns:con2="http://www.bea.com/wli/sb/services/security/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/publish/config">
            <con:id>_ActionId-2484758830309337625-6223049b.1668988c624.-64ef</con:id>
            <con5:service xsi:type="ref:ProxyRef" ref="Middleware/v2/ProxyServices/MapeoErrores" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
            <con5:operation>mapeoErrores</con5:operation>
            <con5:request>
              <con5:body>$REQMapeoErrores</con5:body>
            </con5:request>
            <con5:response>
              <con5:body>RSPMapeoErrores</con5:body>
            </con5:response>
            <con5:requestTransform>
              <con5:assign varName="REQMapeoErrores">
                <con:id>_ActionId-2484758830309337625-6223049b.1668988c624.-64f1</con:id>
                <con5:expr>
                  <con6:xqueryTransform xmlns:con6="http://www.bea.com/wli/sb/stages/config">
                    <con6:resource ref="Middleware/v2/Resources/MapeoErrores/xq/mapeoErroresUsageIn"/>
                    <con6:param name="CODIGO_ERROR">
                      <con6:path>$errorCode</con6:path>
                    </con6:param>
                    <con6:param name="MENSAJE_ERROR">
                      <con6:path>fn:concat("FICBCO0063","$#$",$errorMessage)</con6:path>
                    </con6:param>
                  </con6:xqueryTransform>
                </con5:expr>
              </con5:assign>
            </con5:requestTransform>
            <con5:responseTransform>
              <con5:replace varName="header" contents-only="true">
                <con:id>_ActionId-2484758830309337625-6223049b.1668988c624.-64f0</con:id>
                <con5:expr>
                  <con6:xqueryTransform xmlns:con6="http://www.bea.com/wli/sb/stages/config">
                    <con6:resource ref="Middleware/v2/Resources/MapeoErrores/xq/mapeoErroresUsageOut"/>
                    <con6:param name="mapeoErroresResponse1">
                      <con6:path>$RSPMapeoErrores</con6:path>
                    </con6:param>
                    <con6:param name="successIndicator">
                      <con6:path>$errorCode</con6:path>
                    </con6:param>
                  </con6:xqueryTransform>
                </con5:expr>
              </con5:replace>
            </con5:responseTransform>
          </con5:wsCallout>
          <con5:replace varName="body" contents-only="true" xmlns:con4="http://www.bea.com/wli/sb/stages/publish/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con:id>_ActionId-2484758830309337625-6223049b.1668988c624.-64ee</con:id>
            <con5:expr>
              <con:xqueryText>$RESTransferenciaBody</con:xqueryText>
            </con5:expr>
          </con5:replace>
          <con:reply>
            <con:id>_ActionId-2484758830309337625-6223049b.1668988c624.-64ed</con:id>
          </con:reply>
        </con2:actions>
      </con2:stage>
    </con2:pipeline>
    <con2:pipeline type="request" name="PagoTarjeta_request">
      <con2:stage name="Variables">
        <con2:context>
          <con:userNsDecl namespace="http://xmlns.oracle.com/pcbpel/adapter/db/ORA_BANK/OSB_GET_CONFIG/" prefix="osb"/>
          <con:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/autType" prefix="aut"/>
          <con:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/pagoTarjetaCreditoTypes" prefix="pag"/>
        </con2:context>
        <con2:actions>
          <con1:assign varName="SERVICE_CODE">
            <con:id>_ActionId-6554312317264086991--20db31f7.16b807aa39d.-7883</con:id>
            <con1:expr>
              <con:xqueryText>"FICBCO0305"</con:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="AtomicityStage">
            <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-7751</con:id>
            <con1:expr>
              <con:xqueryText>''</con:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="BALANCE_CURRENCY">
            <con:id>_ActionId-7004617284646856125-35108667.16fd38a4d18.-7f1f</con:id>
            <con1:expr>
              <con:xqueryText>data($body/pag:pagoTarjetaCredito/BALANCE_CURRENCY)</con:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="SUCCESS_INDICATOR">
            <con:id>_ActionId-6554312317264086991--20db31f7.16b807aa39d.-7882</con:id>
            <con1:expr>
              <con:xqueryText>'NOT_SUCCESS'</con:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="ERROR_DESCRIPTION">
            <con:id>_ActionId-6554312317264086991--20db31f7.16b807aa39d.-7881</con:id>
            <con1:expr>
              <con:xqueryText>''</con:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="MAPEAR_ERROR">
            <con:id>_ActionId-6554312317264086991--20db31f7.16b807aa39d.-7880</con:id>
            <con1:expr>
              <con:xqueryText>'SI'</con:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="ParamName_OverlimitValidationStatus">
            <con:id>_ActionId-13985544742512329--3ae69208.16e6c09ba85.-7fbb</con:id>
            <con1:expr>
              <con:xqueryText>concat
(
	$SERVICE_CODE,
	".",
	string($header/aut:RequestHeader/Region/SourceBank/text()), 
	string($header/aut:RequestHeader/Region/DestinationBank/text()), 
	'.OVL.STATUS'
)</con:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="ParamName_InTransactionType">
            <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-76f3</con:id>
            <con1:expr>
              <con:xqueryText>concat
(
	$SERVICE_CODE,
	".",
	string($header/aut:RequestHeader/Region/SourceBank/text()),
	'.TXN.TYPE.IN'
)</con:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="ParamName_CardPaymentDebitAccount">
            <con:id>_ActionId-3994666180538908780--4f4eb6d6.16f8c4fbacc.-7faa</con:id>
            <con1:expr>
              <con:xqueryText>concat
(
	$SERVICE_CODE,
	".",
	string($header/aut:RequestHeader/Region/SourceBank/text()), 
	string($header/aut:RequestHeader/Region/DestinationBank/text()), 
	'.DEBIT.ACCT.USD'
)</con:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="ParamName_DestinationDebitAccount">
            <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-76fd</con:id>
            <con1:expr>
              <con:xqueryText>concat
(
	$SERVICE_CODE,
	".",
	string($header/aut:RequestHeader/Region/SourceBank/text()), 
	string($header/aut:RequestHeader/Region/DestinationBank/text()), 
	'.CREDIT.ACCT.USD'
)</con:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="ParamName_SourceTransferAccount">
            <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-76fa</con:id>
            <con1:expr>
              <con:xqueryText>concat
(
	$SERVICE_CODE, 
	".",
	string($header/aut:RequestHeader/Region/SourceBank/text()), 
	'.ACCT.USD'
)</con:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="ParamName_DestinationTransferAccount">
            <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-7bc5</con:id>
            <con1:expr>
              <con:xqueryText>concat
(
	$SERVICE_CODE, 
	".",
	string($header/aut:RequestHeader/Region/DestinationBank/text()),
	'.ACCT.USD'
)</con:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:assign varName="ParamName_CountryCode">
            <con:id>_ActionId-3994666180538908780--4f4eb6d6.16f8c4fbacc.-7f8c</con:id>
            <con1:expr>
              <con:xqueryText>concat
(
	$SERVICE_CODE,
	".",
	string($header/aut:RequestHeader/Region/DestinationBank/text()), 
	'.COUNTRYCODE'
)</con:xqueryText>
            </con1:expr>
          </con1:assign>
          <con2:wsCallout xmlns:con1="http://www.bea.com/wli/sb/stages/config" xmlns:con4="http://www.bea.com/wli/sb/stages/routing/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/services/security/config" xmlns:con="http://www.bea.com/wli/sb/pipeline/config">
            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-13985544742512329--3ae69208.16e6c09ba85.-7fd8</con5:id>
            <con2:service xsi:type="ref:BusinessServiceRef" ref="Middleware/Business_Resources/general/Resources/ObtenerParametrizacion/ObtenerParametrizacion" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
            <con2:operation>obtenerParametrizacion</con2:operation>
            <con2:request>
              <con2:body>$RequestBody_ObtenerParams</con2:body>
            </con2:request>
            <con2:response>
              <con2:body>ResponseBody_ObtenerParams</con2:body>
            </con2:response>
            <con2:requestTransform>
              <con2:assign varName="RequestBody_ObtenerParams">
                <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-13985544742512329--3ae69208.16e6c09ba85.-7fdb</con5:id>
                <con2:expr>
                  <con5:xqueryTransform xmlns:con5="http://www.bea.com/wli/sb/stages/config">
                    <con5:resource ref="Middleware/Business_Resources/general/Parametrizacion/obtenerParametrizacionIn"/>
                    <con5:param name="nombreParametros">
                      <con5:path>concat(
$ParamName_OverlimitValidationStatus,"||", 
$ParamName_DestinationDebitAccount, "||", 
$ParamName_SourceTransferAccount, "||",
$ParamName_DestinationTransferAccount, "||",
$ParamName_CountryCode, "||",
$ParamName_CardPaymentDebitAccount, "||",
$ParamName_InTransactionType)</con5:path>
                    </con5:param>
                  </con5:xqueryTransform>
                </con2:expr>
              </con2:assign>
            </con2:requestTransform>
            <con2:responseTransform>
              <con2:assign varName="OverlimitValidationStatus">
                <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-13985544742512329--3ae69208.16e6c09ba85.-7fda</con5:id>
                <con2:expr>
                  <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$ResponseBody_ObtenerParams/osb:CONFIGURACIONES/osb:CONFIGURACIONES_ITEM
[
	osb:NAME=$ParamName_OverlimitValidationStatus
]/osb:VALUE/text()</con5:xqueryText>
                </con2:expr>
              </con2:assign>
              <con2:assign varName="InTransactionType">
                <con5:comment xmlns:con5="http://www.bea.com/wli/sb/stages/config">Hacia donde movemos el dinero en Panamá</con5:comment>
                <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-8848856852205208947-5a567015.16f1fe21943.-76e9</con5:id>
                <con2:expr>
                  <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$ResponseBody_ObtenerParams/osb:CONFIGURACIONES/osb:CONFIGURACIONES_ITEM
[
	osb:NAME=$ParamName_InTransactionType
]/osb:VALUE/text()</con5:xqueryText>
                </con2:expr>
              </con2:assign>
              <con2:assign varName="CardPaymentDebitAccount">
                <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-3994666180538908780--4f4eb6d6.16f8c4fbacc.-7fc7</con5:id>
                <con2:expr>
                  <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$ResponseBody_ObtenerParams/osb:CONFIGURACIONES/osb:CONFIGURACIONES_ITEM
[
	osb:NAME=$ParamName_CardPaymentDebitAccount
]/osb:VALUE/text()</con5:xqueryText>
                </con2:expr>
              </con2:assign>
              <con2:assign varName="DestinationDebitAccount">
                <con5:comment xmlns:con5="http://www.bea.com/wli/sb/stages/config">Hacia donde movemos el dinero en Panamá</con5:comment>
                <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-8848856852205208947-5a567015.16f1fe21943.-76e7</con5:id>
                <con2:expr>
                  <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$ResponseBody_ObtenerParams/osb:CONFIGURACIONES/osb:CONFIGURACIONES_ITEM
[
	osb:NAME=$ParamName_DestinationDebitAccount
]/osb:VALUE/text()</con5:xqueryText>
                </con2:expr>
              </con2:assign>
              <con2:assign varName="SourceTransferAccount">
                <con5:comment xmlns:con5="http://www.bea.com/wli/sb/stages/config">De donde sacamos el dinero en Panamá</con5:comment>
                <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-8848856852205208947-5a567015.16f1fe21943.-7ba8</con5:id>
                <con2:expr>
                  <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$ResponseBody_ObtenerParams/osb:CONFIGURACIONES/osb:CONFIGURACIONES_ITEM
[
	osb:NAME=$ParamName_SourceTransferAccount
]/osb:VALUE/text()</con5:xqueryText>
                </con2:expr>
              </con2:assign>
              <con2:assign varName="DestinationTransferAccount">
                <con5:comment xmlns:con5="http://www.bea.com/wli/sb/stages/config">Hacia donde movemos el dinero en Panamá</con5:comment>
                <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-8848856852205208947-5a567015.16f1fe21943.-7b8b</con5:id>
                <con2:expr>
                  <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$ResponseBody_ObtenerParams/osb:CONFIGURACIONES/osb:CONFIGURACIONES_ITEM
[
	osb:NAME=$ParamName_DestinationTransferAccount
]/osb:VALUE/text()</con5:xqueryText>
                </con2:expr>
              </con2:assign>
              <con2:assign varName="CountryCode">
                <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-3994666180538908780--4f4eb6d6.16f8c4fbacc.-7f6f</con5:id>
                <con2:expr>
                  <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$ResponseBody_ObtenerParams/osb:CONFIGURACIONES/osb:CONFIGURACIONES_ITEM
[
	osb:NAME=$ParamName_CountryCode
]/osb:VALUE/text()</con5:xqueryText>
                </con2:expr>
              </con2:assign>
            </con2:responseTransform>
          </con2:wsCallout>
        </con2:actions>
      </con2:stage>
      <con2:stage name="BitacoraRequest">
        <con2:context xmlns:con4="http://www.bea.com/wli/sb/services/security/config" xmlns:con3="http://www.bea.com/wli/sb/stages/publish/config">
          <con4:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/autType" prefix="aut" xmlns:con4="http://www.bea.com/wli/sb/stages/config"/>
        </con2:context>
        <con2:actions xmlns:con4="http://www.bea.com/wli/sb/services/security/config" xmlns:con3="http://www.bea.com/wli/sb/stages/publish/config">
          <con5:assign varName="uuidBitacoraRequest" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con:id>_ActionId-6554312317264086991--20db31f7.16b807aa39d.-78ab</con:id>
            <con5:expr>
              <con4:xqueryTransform xmlns:con4="http://www.bea.com/wli/sb/stages/config">
                <con4:resource ref="Middleware/Business_Resources/general/UUID/obtenerUUID"/>
              </con4:xqueryTransform>
            </con5:expr>
          </con5:assign>
          <con5:assign varName="originalBody" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con:id>_ActionId-6554312317264086991--20db31f7.16b807aa39d.-78aa</con:id>
            <con5:expr>
              <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">$body</con4:xqueryText>
            </con5:expr>
          </con5:assign>
          <con5:assign varName="originalHeader" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con:id>_ActionId-6554312317264086991--20db31f7.16b807aa39d.-78a9</con:id>
            <con5:expr>
              <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">$header</con4:xqueryText>
            </con5:expr>
          </con5:assign>
          <con3:route>
            <con:id>_ActionId-6554312317264086991--20db31f7.16b807aa39d.-78a8</con:id>
            <con3:service ref="Middleware/v2/BusinessServices/OSB/RegistrarBitacoraOSB_v2/biz/RegistrarBitacoraOSB_v2" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
            <con3:operation>registrarBitacoraOSB</con3:operation>
            <con3:outboundTransform>
              <con5:replace varName="body" contents-only="true" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
                <con:id>_ActionId-6554312317264086991--20db31f7.16b807aa39d.-78a7</con:id>
                <con5:location>
                  <con4:xpathText xmlns:con4="http://www.bea.com/wli/sb/stages/config">.</con4:xpathText>
                </con5:location>
                <con5:expr>
                  <con4:xqueryTransform xmlns:con4="http://www.bea.com/wli/sb/stages/config">
                    <con4:resource ref="Middleware/v2/Resources/Generales/xq/registrarBitacoraOSBIn"/>
                    <con4:param name="UuidReq">
                      <con4:path>""</con4:path>
                    </con4:param>
                    <con4:param name="IdOsb">
                      <con4:path>fn:string($inbound/ctx:transport/ctx:request/tp:headers/http:Host/text())</con4:path>
                    </con4:param>
                    <con4:param name="BancoDestino">
                      <con4:path>fn:string($header/aut:RequestHeader/Region/SourceBank/text())</con4:path>
                    </con4:param>
                    <con4:param name="Uuid">
                      <con4:path>$uuidBitacoraRequest</con4:path>
                    </con4:param>
                    <con4:param name="Contenido">
                      <con4:path>$body</con4:path>
                    </con4:param>
                    <con4:param name="BancoOrigen">
                      <con4:path>fn:string($header/aut:RequestHeader/Region/SourceBank/text())</con4:path>
                    </con4:param>
                    <con4:param name="Usuario">
                      <con4:path>fn:string($header/aut:RequestHeader/Authentication/UserName/text())</con4:path>
                    </con4:param>
                    <con4:param name="Resultado">
                      <con4:path>""</con4:path>
                    </con4:param>
                    <con4:param name="IdServicio">
                      <con4:path>$SERVICE_CODE</con4:path>
                    </con4:param>
                    <con4:param name="IdTxn">
                      <con4:path>""</con4:path>
                    </con4:param>
                    <con4:param name="IdOperacion">
                      <con4:path>fn:string($operation)</con4:path>
                    </con4:param>
                    <con4:param name="TipoMensaje">
                      <con4:path>"REQ"</con4:path>
                    </con4:param>
                    <con4:param name="FechaTxn">
                      <con4:path>current-date()</con4:path>
                    </con4:param>
                    <con4:param name="MensajeError">
                      <con4:path>""</con4:path>
                    </con4:param>
                  </con4:xqueryTransform>
                </con5:expr>
              </con5:replace>
            </con3:outboundTransform>
          </con3:route>
        </con2:actions>
      </con2:stage>
      <con2:stage name="ConsultaDetallesCuenta">
        <con2:comment>Este paso se hace para obtener:
* La moneda de la cuenta.
* La categoría de la cuenta.
* Código del dueño de la cuenta.
* Nombre del dueño de la cuenta.</con2:comment>
        <con2:context>
          <con:userNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/consultasType" prefix="con"/>
          <con:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/pagoTarjetaCreditoTypes" prefix="pag"/>
          <con:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/autType" prefix="aut"/>
        </con2:context>
        <con2:actions>
          <con1:ifThenElse>
            <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-7754</con:id>
            <con1:case>
              <con1:condition>
                <con:xqueryText>(: if ERROR or StageCompleted :)
fn:contains(data($body/pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE/KV_PAIR[KEY="ACCOUNT_CURRENCY"]/VALUE), '#CDC#')</con:xqueryText>
              </con1:condition>
              <con1:actions/>
            </con1:case>
            <con1:default>
              <con1:assign varName="TemporalHeader">
                <con:comment>El objetivo de esta variable es enviar un header válido hacia el servicio ConsultaDetalleCuenta sin tener que tocar el header original. Es, en resumen, una copia del header con las modificaciones necesarias para que el servicio llamado funcione.</con:comment>
                <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-7753</con:id>
                <con1:expr>
                  <con:xqueryText>$header</con:xqueryText>
                </con1:expr>
              </con1:assign>
              <con1:replace varName="TemporalHeader">
                <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-7752</con:id>
                <con1:location>
                  <con:xpathText>./aut:RequestHeader/Region/DestinationBank</con:xpathText>
                </con1:location>
                <con1:expr>
                  <con:xqueryText>&lt;DestinationBank/></con:xqueryText>
                </con1:expr>
              </con1:replace>
              <con1:wsCallout>
                <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-773a</con:id>
                <con1:service xsi:type="ref:ProxyRef" ref="Middleware/v2/ProxyServices/ConsultaDetallesCuenta" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                <con1:operation>consultaDetallesCuenta</con1:operation>
                <con1:request>
                  <con1:body>$REQBody</con1:body>
                  <con1:header>$REQHeader</con1:header>
                </con1:request>
                <con1:response>
                  <con1:body>RESBody</con1:body>
                  <con1:header>RESHeader</con1:header>
                </con1:response>
                <con1:requestTransform>
                  <con1:assign varName="REQHeader">
                    <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-7751</con:id>
                    <con1:expr>
                      <con:xqueryText>$TemporalHeader</con:xqueryText>
                    </con1:expr>
                  </con1:assign>
                  <con1:assign varName="REQBody">
                    <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-7750</con:id>
                    <con1:expr>
                      <con:xqueryTransform>
                        <con:resource ref="Middleware/v3/Resources/Debitos/xq/ConsultaDetallesCuentaIn"/>
                        <con:param name="ACCOUNT_NUMBER">
                          <con:path>string($body/pag:pagoTarjetaCredito/DEBIT_ACCOUNT/text())</con:path>
                        </con:param>
                      </con:xqueryTransform>
                    </con1:expr>
                  </con1:assign>
                </con1:requestTransform>
                <con1:responseTransform>
                  <con4:assign varName="SUCCESS_INDICATOR" xmlns:con4="http://www.bea.com/wli/sb/stages/transform/config">
                    <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-774f</con:id>
                    <con4:expr>
                      <con:xqueryText>fn:upper-case($RESHeader/aut:ResponseHeader/successIndicator/text())</con:xqueryText>
                    </con4:expr>
                  </con4:assign>
                  <con1:ifThenElse>
                    <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-774e</con:id>
                    <con1:case>
                      <con1:condition>
                        <con:xqueryText>(: if ERROR :)
fn:upper-case($SUCCESS_INDICATOR) != "SUCCESS" 
or 
fn:upper-case($SUCCESS_INDICATOR) = "NO RECORDS"</con:xqueryText>
                      </con1:condition>
                      <con1:actions>
                        <con1:assign varName="SUCCESS_INDICATOR">
                          <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-774d</con:id>
                          <con1:expr>
                            <con:xqueryText>'ERROR'</con:xqueryText>
                          </con1:expr>
                        </con1:assign>
                        <con1:assign varName="ERROR_CODE">
                          <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-774c</con:id>
                          <con1:expr>
                            <con:xqueryText>$RESHeader/aut:ResponseHeader/messageId/text()</con:xqueryText>
                          </con1:expr>
                        </con1:assign>
                        <con4:assign varName="ERROR_DESCRIPTION" xmlns:con4="http://www.bea.com/wli/sb/stages/transform/config">
                          <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-774b</con:id>
                          <con4:expr>
                            <con:xqueryText>$RESHeader/aut:ResponseHeader/messages/text()</con:xqueryText>
                          </con4:expr>
                        </con4:assign>
                        <con1:assign varName="MAPEAR_ERROR">
                          <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-774a</con:id>
                          <con1:expr>
                            <con:xqueryText>'NO'</con:xqueryText>
                          </con1:expr>
                        </con1:assign>
                      </con1:actions>
                    </con1:case>
                    <con1:case>
                      <con1:condition>
                        <con:xqueryText>(: if Cuenta_Inactiva :)
$RESBody/con:consultaDetallesCuentaResponseType/con:consultaDetallesCuentaResponseRecordType/INACTIVE_MARKER/text() = '1'
or
$RESBody/con:consultaDetallesCuentaResponseType/con:consultaDetallesCuentaResponseRecordType/INACTIVE_MARKER/text() = 'Y'</con:xqueryText>
                      </con1:condition>
                      <con1:actions>
                        <con1:assign varName="SUCCESS_INDICATOR">
                          <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-7667</con:id>
                          <con1:expr>
                            <con:xqueryText>'ERROR'</con:xqueryText>
                          </con1:expr>
                        </con1:assign>
                        <con1:assign varName="ERROR_CODE">
                          <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-7663</con:id>
                          <con1:expr>
                            <con:xqueryText>70</con:xqueryText>
                          </con1:expr>
                        </con1:assign>
                        <con1:assign varName="ERROR_DESCRIPTION">
                          <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-7649</con:id>
                          <con1:expr>
                            <con:xqueryText>'Cuenta Bloqueada o Inactiva'</con:xqueryText>
                          </con1:expr>
                        </con1:assign>
                        <con1:assign varName="MAPEAR_ERROR">
                          <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-7661</con:id>
                          <con1:expr>
                            <con:xqueryText>'NO'</con:xqueryText>
                          </con1:expr>
                        </con1:assign>
                      </con1:actions>
                    </con1:case>
                    <con1:default>
                      <con4:assign varName="ACCOUNT_CURRENCY" xmlns:con4="http://www.bea.com/wli/sb/stages/transform/config">
                        <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-765f</con:id>
                        <con4:expr>
                          <con:xqueryText>$RESBody/con:consultaDetallesCuentaResponseType/con:consultaDetallesCuentaResponseRecordType/CURRENCY/text()</con:xqueryText>
                        </con4:expr>
                      </con4:assign>
                      <con3:assign varName="ACCOUNT_CATEGORY" xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config">
                        <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-765d</con:id>
                        <con3:expr>
                          <con:xqueryText>$RESBody/con:consultaDetallesCuentaResponseType/con:consultaDetallesCuentaResponseRecordType/CATEGORY/text()</con:xqueryText>
                        </con3:expr>
                      </con3:assign>
                      <con1:assign varName="CUSTOMER_NUMBER">
                        <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-765b</con:id>
                        <con1:expr>
                          <con:xqueryText>$RESBody/con:consultaDetallesCuentaResponseType/con:consultaDetallesCuentaResponseRecordType/CUSTOMER_ID/text()</con:xqueryText>
                        </con1:expr>
                      </con1:assign>
                      <con1:assign varName="CUSTOMER_NAME">
                        <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-7659</con:id>
                        <con1:expr>
                          <con:xqueryText>$RESBody/con:consultaDetallesCuentaResponseType/con:consultaDetallesCuentaResponseRecordType/ACCOUNT_NAME/text()</con:xqueryText>
                        </con1:expr>
                      </con1:assign>
                      <con1:ifThenElse>
                        <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-7652</con:id>
                        <con1:case>
                          <con1:condition>
                            <con:xqueryText>fn:count($body/pag:pagoTarjetaCredito/REGIONAL_DETAILS) &lt; 1</con:xqueryText>
                          </con1:condition>
                          <con1:actions>
                            <con1:insert varName="body">
                              <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-7651</con:id>
                              <con1:location>
                                <con:xpathText>./pag:pagoTarjetaCredito</con:xpathText>
                              </con1:location>
                              <con1:where>last-child</con1:where>
                              <con1:expr>
                                <con:xqueryText><![CDATA[<REGIONAL_DETAILS>
	<SOURCE>
		<KV_PAIR>
			<KEY>ACCOUNT_CURRENCY</KEY>
			<VALUE>{$ACCOUNT_CURRENCY}</VALUE>
		</KV_PAIR>
		<KV_PAIR>
			<KEY>ACCOUNT_CATEGORY</KEY>
			<VALUE>{$ACCOUNT_CATEGORY}</VALUE>
		</KV_PAIR>
		<KV_PAIR>
			<KEY>CUSTOMER_NUMBER</KEY>
			<VALUE>{$CUSTOMER_NUMBER}</VALUE>
		</KV_PAIR>
		<KV_PAIR>
			<KEY>CUSTOMER_NAME</KEY>
			<VALUE>{$CUSTOMER_NAME}</VALUE>
		</KV_PAIR>
		<KV_PAIR>
			<KEY>ATOMICITY_STAGE</KEY>
			<VALUE></VALUE>
		</KV_PAIR>	
	</SOURCE>
</REGIONAL_DETAILS>]]></con:xqueryText>
                              </con1:expr>
                            </con1:insert>
                          </con1:actions>
                        </con1:case>
                        <con1:default>
                          <con1:insert varName="body">
                            <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-7650</con:id>
                            <con1:location>
                              <con:xpathText>./pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE</con:xpathText>
                            </con1:location>
                            <con1:where>first-child</con1:where>
                            <con1:expr>
                              <con:xqueryText><![CDATA[<KV_PAIR>
	<KEY>ACCOUNT_CURRENCY</KEY>
	<VALUE>{$ACCOUNT_CURRENCY}</VALUE>
</KV_PAIR>]]></con:xqueryText>
                            </con1:expr>
                          </con1:insert>
                          <con1:insert varName="body">
                            <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-764f</con:id>
                            <con1:location>
                              <con:xpathText>./pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE</con:xpathText>
                            </con1:location>
                            <con1:where>first-child</con1:where>
                            <con1:expr>
                              <con:xqueryText><![CDATA[<KV_PAIR>
	<KEY>ACCOUNT_CATEGORY</KEY>
	<VALUE>{$ACCOUNT_CATEGORY}</VALUE>
</KV_PAIR>]]></con:xqueryText>
                            </con1:expr>
                          </con1:insert>
                          <con1:insert varName="body">
                            <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-764e</con:id>
                            <con1:location>
                              <con:xpathText>./pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE</con:xpathText>
                            </con1:location>
                            <con1:where>first-child</con1:where>
                            <con1:expr>
                              <con:xqueryText><![CDATA[<KV_PAIR>
	<KEY>CUSTOMER_NUMBER</KEY>
	<VALUE>{$CUSTOMER_NUMBER}</VALUE>
</KV_PAIR>]]></con:xqueryText>
                            </con1:expr>
                          </con1:insert>
                          <con1:insert varName="body">
                            <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-764d</con:id>
                            <con1:location>
                              <con:xpathText>./pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE</con:xpathText>
                            </con1:location>
                            <con1:where>first-child</con1:where>
                            <con1:expr>
                              <con:xqueryText><![CDATA[<KV_PAIR>
	<KEY>CUSTOMER_NAME</KEY>
	<VALUE>{$CUSTOMER_NAME}</VALUE>
</KV_PAIR>]]></con:xqueryText>
                            </con1:expr>
                          </con1:insert>
                          <con1:insert varName="body">
                            <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-7524</con:id>
                            <con1:location>
                              <con:xpathText>./pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE</con:xpathText>
                            </con1:location>
                            <con1:where>first-child</con1:where>
                            <con1:expr>
                              <con:xqueryText><![CDATA[<KV_PAIR>
	<KEY>ATOMICITY_STAGE</KEY>
	<VALUE></VALUE>
</KV_PAIR>]]></con:xqueryText>
                            </con1:expr>
                          </con1:insert>
                        </con1:default>
                      </con1:ifThenElse>
                      <con1:assign varName="AtomicityStage">
                        <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-764b</con:id>
                        <con1:expr>
                          <con:xqueryText>concat(data($body/pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE/KV_PAIR[KEY="ACCOUNT_CURRENCY"]/VALUE), '#CDC#')</con:xqueryText>
                        </con1:expr>
                      </con1:assign>
                      <con1:replace varName="body" contents-only="true">
                        <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-7507</con:id>
                        <con1:location>
                          <con:xpathText>./pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE/KV_PAIR[KEY="ATOMICITY_STAGE"]/VALUE</con:xpathText>
                        </con1:location>
                        <con1:expr>
                          <con:xqueryText>$AtomicityStage</con:xqueryText>
                        </con1:expr>
                      </con1:replace>
                    </con1:default>
                  </con1:ifThenElse>
                </con1:responseTransform>
              </con1:wsCallout>
            </con1:default>
          </con1:ifThenElse>
        </con2:actions>
      </con2:stage>
      <con2:stage name="CalculoMontoPago">
        <con2:comment>En este paso se divide el monto del request por la tasa de cambio, se guarda en una variable y se inserta en la seccion REGIONAL_DETAILS del request.
Este paso poco ortodoxo se tiene que hacer porque Infocorp envía todos los montos en la moneda de la cuenta, en vez de mandar la información sin modificaciones.

Adicional, este paso se vuelve obligatorio cuando se va a pagar moneda local de pais destino con moneda local de pais origen. Esto debido a que el request no está preparado para una operación regional de este tipo (Moneda local de un país a moneda local de otro)  como consecuencia, la operación se convierte en "cuantos dolares va a aplicarse al saldo" 
LPS (Div entre tasa venta)-> USD ->(Mult por tasa de compra) QTZ

De este punto en adelante, se utiliza el MONTO_ORIGINAL para realizar cualquier operación.</con2:comment>
        <con2:context>
          <con:userNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/consultaTasaCambioTypes" prefix="con"/>
          <con:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/autType" prefix="aut"/>
          <con:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/pagoTarjetaCreditoTypes" prefix="pag"/>
        </con2:context>
        <con2:actions>
          <con1:ifThenElse>
            <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-7e1a</con:id>
            <con1:case>
              <con1:condition>
                <con:xqueryText>(: if ERROR or StageCompleted :)
'SUCCESS' != fn:upper-case($SUCCESS_INDICATOR)
or
fn:contains(data($body/pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE/KV_PAIR[KEY="ACCOUNT_CURRENCY"]/VALUE), '#CMP#')</con:xqueryText>
              </con1:condition>
              <con1:actions/>
            </con1:case>
            <con1:case>
              <con1:condition>
                <con:xqueryText>(: if SourceCurr not USD :)
$ACCOUNT_CURRENCY != 'USD'</con:xqueryText>
              </con1:condition>
              <con1:actions>
                <con1:wsCallout>
                  <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-76a4</con:id>
                  <con1:service xsi:type="ref:ProxyRef" ref="Middleware/v2/ProxyServices/ConsultaTasaCambio" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                  <con1:operation>consultaTasaCambio</con1:operation>
                  <con1:request>
                    <con1:body>$REQConsultaTasa</con1:body>
                    <con1:header>$REQHeaderTasaCambio</con1:header>
                  </con1:request>
                  <con1:response>
                    <con1:body>RESConsultaTasa</con1:body>
                    <con1:header>RESHeaderTasaCambio</con1:header>
                  </con1:response>
                  <con1:requestTransform>
                    <con1:assign varName="REQHeaderTasaCambio">
                      <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-76b0</con:id>
                      <con1:expr>
                        <con:xqueryText>$TemporalHeader</con:xqueryText>
                      </con1:expr>
                    </con1:assign>
                    <con1:assign varName="REQConsultaTasa">
                      <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-76af</con:id>
                      <con1:expr>
                        <con:xqueryTransform>
                          <con:resource ref="Middleware/v2/Resources/TransferenciasACH/xq/ConsultaTasaCambioIn"/>
                          <con:param name="TARGET">
                            <con:path>'USD'</con:path>
                          </con:param>
                          <con:param name="SOURCE">
                            <con:path>$ACCOUNT_CURRENCY</con:path>
                          </con:param>
                        </con:xqueryTransform>
                      </con1:expr>
                    </con1:assign>
                  </con1:requestTransform>
                  <con1:responseTransform>
                    <con1:assign varName="SUCCESS_INDICATOR">
                      <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-76ae</con:id>
                      <con1:expr>
                        <con:xqueryText>fn:upper-case($RESHeaderTasaCambio/aut:ResponseHeader/successIndicator/text())</con:xqueryText>
                      </con1:expr>
                    </con1:assign>
                    <con3:ifThenElse xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config">
                      <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-76ad</con:id>
                      <con3:case>
                        <con3:condition>
                          <con:xqueryText>(: if ERROR :)
fn:upper-case($SUCCESS_INDICATOR) != 'SUCCESS'</con:xqueryText>
                        </con3:condition>
                        <con3:actions>
                          <con3:assign varName="ERROR_CODE">
                            <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-76ac</con:id>
                            <con3:expr>
                              <con:xqueryText>$RESHeaderTasaCambio/aut:ResponseHeader/messageId/text()</con:xqueryText>
                            </con3:expr>
                          </con3:assign>
                          <con3:assign varName="ERROR_DESCRIPTION">
                            <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-76ab</con:id>
                            <con3:expr>
                              <con:xqueryText>fn:upper-case($RESConsultaTasa/con:ERROR_MESSAGE/text())</con:xqueryText>
                            </con3:expr>
                          </con3:assign>
                          <con3:assign varName="MAPEAR_ERROR">
                            <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-76aa</con:id>
                            <con3:expr>
                              <con:xqueryText>'NO'</con:xqueryText>
                            </con3:expr>
                          </con3:assign>
                        </con3:actions>
                      </con3:case>
                      <con3:default>
                        <con3:assign varName="BaseAmount">
                          <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-76a9</con:id>
                          <con3:expr>
                            <con:xqueryText>fn:number($body/pag:pagoTarjetaCredito/PAYMENT_AMOUNT)</con:xqueryText>
                          </con3:expr>
                        </con3:assign>
                        <con3:assign varName="SellExchangeRate">
                          <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-76a8</con:id>
                          <con3:expr>
                            <con:xqueryText>fn:number($RESConsultaTasa/con:consultaTasaCambioResponseType/con:consultaTasaCambioResponseRecordType/SELL_RATE/text())</con:xqueryText>
                          </con3:expr>
                        </con3:assign>
                        <con3:assign varName="TransactionAmount">
                          <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-76a7</con:id>
                          <con3:expr>
                            <con:xqueryText>round-half-to-even(xs:double($body/pag:pagoTarjetaCredito/PAYMENT_AMOUNT) div xs:double($RESConsultaTasa/con:consultaTasaCambioResponseType/con:consultaTasaCambioResponseRecordType/SELL_RATE/text()), 2)</con:xqueryText>
                          </con3:expr>
                        </con3:assign>
                        <con1:insert varName="body" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config">
                          <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-76a6</con:id>
                          <con1:location>
                            <con:xpathText>./pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE</con:xpathText>
                          </con1:location>
                          <con1:where>first-child</con1:where>
                          <con1:expr>
                            <con:xqueryText><![CDATA[<KV_PAIR>
	<KEY>USD_AMOUNT</KEY>
	<VALUE>{$TransactionAmount}</VALUE>
</KV_PAIR>]]></con:xqueryText>
                          </con1:expr>
                        </con1:insert>
                        <con3:insert varName="body">
                          <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-76a5</con:id>
                          <con3:location>
                            <con:xpathText>./pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE</con:xpathText>
                          </con3:location>
                          <con3:where>first-child</con3:where>
                          <con3:expr>
                            <con:xqueryText><![CDATA[<KV_PAIR>
	<KEY>SELL_EXCHANGE_RATE</KEY>
	<VALUE>{$SellExchangeRate}</VALUE>
</KV_PAIR>]]></con:xqueryText>
                          </con3:expr>
                        </con3:insert>
                        <con1:assign varName="AtomicityStage" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config">
                          <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-760e</con:id>
                          <con1:expr>
                            <con:xqueryText>concat(data($body/pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE/KV_PAIR[KEY="ACCOUNT_CURRENCY"]/VALUE), ',#CMP#')</con:xqueryText>
                          </con1:expr>
                        </con1:assign>
                        <con1:replace varName="body" contents-only="true" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config">
                          <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-74ad</con:id>
                          <con1:location>
                            <con:xpathText>./pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE/KV_PAIR[KEY="ATOMICITY_STAGE"]/VALUE</con:xpathText>
                          </con1:location>
                          <con1:expr>
                            <con:xqueryText>$AtomicityStage</con:xqueryText>
                          </con1:expr>
                        </con1:replace>
                      </con3:default>
                    </con3:ifThenElse>
                  </con1:responseTransform>
                </con1:wsCallout>
              </con1:actions>
            </con1:case>
            <con1:default>
              <con1:insert varName="body">
                <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-7e0c</con:id>
                <con1:location>
                  <con:xpathText>./pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE</con:xpathText>
                </con1:location>
                <con1:where>first-child</con1:where>
                <con1:expr>
                  <con:xqueryText><![CDATA[<KV_PAIR>
	<KEY>USD_AMOUNT</KEY>
	<VALUE>{string($body/pag:pagoTarjetaCredito/PAYMENT_AMOUNT/text())}</VALUE>
</KV_PAIR>]]></con:xqueryText>
                </con1:expr>
              </con1:insert>
              <con3:insert varName="body" xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config">
                <con:id>_ActionId-3994666180538908780--4f4eb6d6.16f8c4fbacc.-7f40</con:id>
                <con3:location>
                  <con:xpathText>./pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE</con:xpathText>
                </con3:location>
                <con3:where>first-child</con3:where>
                <con3:expr>
                  <con:xqueryText><![CDATA[<KV_PAIR>
	<KEY>SELL_EXCHANGE_RATE</KEY>
	<VALUE>1</VALUE>
</KV_PAIR>]]></con:xqueryText>
                </con3:expr>
              </con3:insert>
              <con1:assign varName="AtomicityStage">
                <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-7647</con:id>
                <con1:expr>
                  <con:xqueryText>concat(data($body/pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE/KV_PAIR[KEY="ACCOUNT_CURRENCY"]/VALUE), ',CMP')</con:xqueryText>
                </con1:expr>
              </con1:assign>
              <con1:replace varName="body" contents-only="true">
                <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-74ca</con:id>
                <con1:location>
                  <con:xpathText>./pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE/KV_PAIR[KEY="ATOMICITY_STAGE"]/VALUE</con:xpathText>
                </con1:location>
                <con1:expr>
                  <con:xqueryText>$AtomicityStage</con:xqueryText>
                </con1:expr>
              </con1:replace>
            </con1:default>
          </con1:ifThenElse>
        </con2:actions>
      </con2:stage>
      <con2:stage name="ValidacionOverlimitPS">
        <con2:comment>Validación de Overlimit según parámetro. Si el país para el que está ejecutandose el flujo no necesita validación de overlimit, se salta esta etapa
La validacion de Overlimit se hace al inicio porque si el pago no pasa dicha validación, no se continua haciendo ningúna consulta adicional.</con2:comment>
        <con2:context xmlns:con4="http://www.bea.com/wli/sb/stages/routing/config">
          <con:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/autType" prefix="aut"/>
          <con:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/pagoTarjetaCreditoTypes" prefix="pag"/>
        </con2:context>
        <con2:actions xmlns:con4="http://www.bea.com/wli/sb/stages/routing/config">
          <con1:ifThenElse>
            <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-791a</con:id>
            <con1:case>
              <con1:condition>
                <con:xqueryText>(: if ERROR or StageCompleted :)
fn:upper-case($SUCCESS_INDICATOR) != 'SUCCESS'
or
fn:contains(data($body/pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE/KV_PAIR[KEY="ACCOUNT_CURRENCY"]/VALUE), '#VOL#')</con:xqueryText>
              </con1:condition>
              <con1:actions/>
            </con1:case>
            <con1:case>
              <con1:condition>
                <con:xqueryText>(: if VALIDAR_OVERLIMIT :)
$OverlimitValidationStatus = 'S'</con:xqueryText>
              </con1:condition>
              <con1:actions>
                <con1:assign varName="RequestHeader">
                  <con:id>_ActionId-2512360512555746532-40eb4d6e.1739cb5fa20.-7fac</con:id>
                  <con1:expr>
                    <con:xqueryText>$header</con:xqueryText>
                  </con1:expr>
                </con1:assign>
                <con1:replace varName="RequestHeader" contents-only="false">
                  <con:id>_ActionId-2512360512555746532-40eb4d6e.1739cb5fa20.-7f8f</con:id>
                  <con1:location>
                    <con:xpathText>./aut:RequestHeader/Region</con:xpathText>
                  </con1:location>
                  <con1:expr>
                    <con:xqueryText><![CDATA[<Region>
	<SourceBank>{data($header/aut:RequestHeader/Region/DestinationBank)}</SourceBank>
	<DestinationBank>{data($header/aut:RequestHeader/Region/DestinationBank)}</DestinationBank>
</Region>]]></con:xqueryText>
                  </con1:expr>
                </con1:replace>
                <con1:wsCallout>
                  <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-7913</con:id>
                  <con1:service xsi:type="ref:ProxyRef" ref="Middleware/v3/ProxyServices/ValidacionOverlimit" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                  <con1:operation>ValidacionOverlimit</con1:operation>
                  <con1:request>
                    <con1:body>$ReqValidacionOverlimit</con1:body>
                    <con1:header>$RequestHeader</con1:header>
                  </con1:request>
                  <con1:response>
                    <con1:body>ResValidacionOverlimit</con1:body>
                    <con1:header>ResponseHeader</con1:header>
                  </con1:response>
                  <con1:requestTransform>
                    <con1:assign varName="ReqValidacionOverlimit">
                      <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-7918</con:id>
                      <con1:expr>
                        <con:xqueryTransform>
                          <con:resource ref="Middleware/v3/Resources/ValidacionOverlimit/xq/ValidacionOverlimitIn"/>
                          <con:param name="CountryCode">
                            <con:path>string($header/aut:RequestHeader/Region/DestinationBank)</con:path>
                          </con:param>
                          <con:param name="PaymentCurrency">
                            <con:path>string($body/pag:pagoTarjetaCredito/BALANCE_CURRENCY/text())</con:path>
                          </con:param>
                          <con:param name="CardBank">
                            <con:path>string($header/aut:RequestHeader/Region/DestinationBank/text())</con:path>
                          </con:param>
                          <con:param name="PaymentAmount">
                            <con:path>number($body/pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE/KV_PAIR[KEY="USD_AMOUNT"]/VALUE/text())</con:path>
                          </con:param>
                          <con:param name="CardNumber">
                            <con:path>string($body/pag:pagoTarjetaCredito/CREDIT_CARD_NUMBER/text())</con:path>
                          </con:param>
                        </con:xqueryTransform>
                      </con1:expr>
                    </con1:assign>
                  </con1:requestTransform>
                  <con1:responseTransform>
                    <con2:assign varName="SUCCESS_INDICATOR" xmlns:con1="http://www.bea.com/wli/sb/stages/config" xmlns:con="http://www.bea.com/wli/sb/pipeline/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/services/security/config">
                      <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-8848856852205208947-5a567015.16f1fe21943.-7917</con5:id>
                      <con2:expr>
                        <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$ResponseHeader/aut:ResponseHeader/successIndicator/text()</con5:xqueryText>
                      </con2:expr>
                    </con2:assign>
                    <con2:assign varName="ERROR_DESCRIPTION" xmlns:con1="http://www.bea.com/wli/sb/stages/config" xmlns:con="http://www.bea.com/wli/sb/pipeline/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/services/security/config">
                      <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-8848856852205208947-5a567015.16f1fe21943.-7916</con5:id>
                      <con2:expr>
                        <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$ResponseHeader/aut:ResponseHeader/messages/text()</con5:xqueryText>
                      </con2:expr>
                    </con2:assign>
                    <con1:assign varName="org">
                      <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-7915</con:id>
                      <con1:expr>
                        <con:xqueryText>$ResValidacionOverlimit/ORG/text()</con:xqueryText>
                      </con1:expr>
                    </con1:assign>
                    <con1:assign varName="clientId">
                      <con:id>_ActionId-2637201477923639010-99fba2b.1799ea65474.-5e77</con:id>
                      <con1:expr>
                        <con:xqueryText>$ResValidacionOverlimit/CLIENT_ID/text()</con:xqueryText>
                      </con1:expr>
                    </con1:assign>
                    <con1:assign varName="currentBalance">
                      <con:id>_ActionId-2637201477923639010-99fba2b.1799ea65474.-5e5a</con:id>
                      <con1:expr>
                        <con:xqueryText>$ResValidacionOverlimit/CURRENT_BALANCE/text()</con:xqueryText>
                      </con1:expr>
                    </con1:assign>
                    <con3:insert varName="body" xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config">
                      <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-7914</con:id>
                      <con3:location>
                        <con:xpathText>./pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE</con:xpathText>
                      </con3:location>
                      <con3:where>first-child</con3:where>
                      <con3:expr>
                        <con:xqueryText><![CDATA[<KV_PAIR>
	<KEY>ORG</KEY>
	<VALUE>{$org}</VALUE>
</KV_PAIR>]]></con:xqueryText>
                      </con3:expr>
                    </con3:insert>
                    <con1:insert varName="body">
                      <con:id>_ActionId-2637201477923639010-99fba2b.1799ea65474.-5e3d</con:id>
                      <con1:location>
                        <con:xpathText>./pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE</con:xpathText>
                      </con1:location>
                      <con1:where>first-child</con1:where>
                      <con1:expr>
                        <con:xqueryText><![CDATA[<KV_PAIR>
	<KEY>CLIENT_ID</KEY>
	<VALUE>{ $clientId }</VALUE>
</KV_PAIR>]]></con:xqueryText>
                      </con1:expr>
                    </con1:insert>
                    <con1:insert varName="body">
                      <con:id>_ActionId-2637201477923639010-99fba2b.1799ea65474.-5e20</con:id>
                      <con1:location>
                        <con:xpathText>./pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE</con:xpathText>
                      </con1:location>
                      <con1:where>first-child</con1:where>
                      <con1:expr>
                        <con:xqueryText><![CDATA[<KV_PAIR>
	<KEY>CURRENT_BALANCE</KEY>
	<VALUE>{ $currentBalance }</VALUE>
</KV_PAIR>]]></con:xqueryText>
                      </con1:expr>
                    </con1:insert>
                  </con1:responseTransform>
                </con1:wsCallout>
                <con1:assign varName="AtomicityStage">
                  <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-75cd</con:id>
                  <con1:expr>
                    <con:xqueryText>concat(data($body/pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE/KV_PAIR[KEY="ACCOUNT_CURRENCY"]/VALUE), ',#VOL#')</con:xqueryText>
                  </con1:expr>
                </con1:assign>
                <con1:replace varName="body" contents-only="true">
                  <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-7472</con:id>
                  <con1:location>
                    <con:xpathText>./pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE/KV_PAIR[KEY="ATOMICITY_STAGE"]/VALUE</con:xpathText>
                  </con1:location>
                  <con1:expr>
                    <con:xqueryText>$AtomicityStage</con:xqueryText>
                  </con1:expr>
                </con1:replace>
              </con1:actions>
            </con1:case>
            <con1:default/>
          </con1:ifThenElse>
        </con2:actions>
      </con2:stage>
      <con2:stage name="DebitoRegional">
        <con2:context>
          <con:userNsDecl namespace="http://xmlns.oracle.com/pcbpel/adapter/db/ORA_BANK/OSB_GET_CONFIG/" prefix="osb"/>
          <con:userNsDecl namespace="http://xmlns.oracle.com/pcbpel/adapter/db/sp/ConsultaDetallesCuenta" prefix="con"/>
          <con:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/autType" prefix="aut"/>
          <con:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/pagoTarjetaCreditoTypes" prefix="pag"/>
        </con2:context>
        <con2:actions>
          <con1:ifThenElse>
            <con:id>_ActionId-8591433004399123688-1be0e88f.1673321bc70.-797c</con:id>
            <con1:case>
              <con1:condition>
                <con:xqueryText>(: if ERROR or StageCompleted :)
fn:upper-case($SUCCESS_INDICATOR) != 'SUCCESS'
or
fn:contains(data($body/pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE/KV_PAIR[KEY="ACCOUNT_CURRENCY"]/VALUE), '#DEB#')</con:xqueryText>
              </con1:condition>
              <con1:actions/>
            </con1:case>
            <con1:default>
              <con1:assign varName="SourceAccountCurrency">
                <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-795d</con:id>
                <con1:expr>
                  <con:xqueryText>string($body/pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE/KV_PAIR[KEY="ACCOUNT_CURRENCY"]/VALUE/text())</con:xqueryText>
                </con1:expr>
              </con1:assign>
              <con1:assign varName="InterfaceRefNum">
                <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-795f</con:id>
                <con1:expr>
                  <con:xqueryText>if (string($body/pag:pagoTarjetaCredito/INTERFACE_REFERENCE_NO/text()) = '') then
	'0'
else
	()</con:xqueryText>
                </con1:expr>
              </con1:assign>
              <con1:assign varName="Amount">
                <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-7961</con:id>
                <con1:expr>
                  <con:xqueryText>string($body/pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE/KV_PAIR[KEY="USD_AMOUNT"]/VALUE/text())</con:xqueryText>
                </con1:expr>
              </con1:assign>
              <con1:assign varName="CreditCardNumber">
                <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-7963</con:id>
                <con1:expr>
                  <con:xqueryText>string($body/pag:pagoTarjetaCredito/CREDIT_CARD_NUMBER/text())</con:xqueryText>
                </con1:expr>
              </con1:assign>
              <con1:assign varName="UserName">
                <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-7965</con:id>
                <con1:expr>
                  <con:xqueryText>string($header/aut:RequestHeader/Authentication/UserName/text())</con:xqueryText>
                </con1:expr>
              </con1:assign>
              <con1:assign varName="Password">
                <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-7967</con:id>
                <con1:expr>
                  <con:xqueryText>string($header/aut:RequestHeader/Authentication/Password/text())</con:xqueryText>
                </con1:expr>
              </con1:assign>
              <con1:wsCallout>
                <con:id>_ActionId-8591433004399123688-1be0e88f.1673321bc70.-7970</con:id>
                <con1:service xsi:type="ref:ProxyRef" ref="Middleware/v3/ProxyServices/Debitos/local/DebitosRouter" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                <con1:operation>Debitos</con1:operation>
                <con1:request>
                  <con1:body>$REQTransferenciaBody</con1:body>
                  <con1:header>$REQTransferenciaHeader</con1:header>
                </con1:request>
                <con1:response>
                  <con1:body>RESTransferenciaBody</con1:body>
                  <con1:header>RESTransferenciaHeader</con1:header>
                </con1:response>
                <con1:requestTransform>
                  <con1:assign varName="REQTransferenciaHeader">
                    <con:id>_ActionId-8591433004399123688-1be0e88f.1673321bc70.-7975</con:id>
                    <con1:expr>
                      <con:xqueryText>$header</con:xqueryText>
                    </con1:expr>
                  </con1:assign>
                  <con1:assign varName="REQTransferenciaBody">
                    <con:id>_ActionId-8591433004399123688-1be0e88f.1673321bc70.-7974</con:id>
                    <con1:expr>
                      <con:xqueryTransform>
                        <con:resource ref="Middleware/v3/Resources/Debitos/xq/DebitosTypesXform"/>
                        <con:param name="SourceAccountCurrency">
                          <con:path>$SourceAccountCurrency</con:path>
                        </con:param>
                        <con:param name="SourceAccount">
                          <con:path>string($body/pag:pagoTarjetaCredito/DEBIT_ACCOUNT/text())</con:path>
                        </con:param>
                        <con:param name="Password">
                          <con:path>$Password</con:path>
                        </con:param>
                        <con:param name="DestinationAccount">
                          <con:path>if (fn:string-length($DestinationDebitAccount) = 0) then ''
else
$DestinationDebitAccount</con:path>
                        </con:param>
                        <con:param name="RegionalDetails">
                          <con:path>$body/pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE</con:path>
                        </con:param>
                        <con:param name="InterfaceReferenceNumber">
                          <con:path>$InterfaceRefNum</con:path>
                        </con:param>
                        <con:param name="Amount">
                          <con:path>$Amount</con:path>
                        </con:param>
                        <con:param name="UserName">
                          <con:path>$UserName</con:path>
                        </con:param>
                        <con:param name="PaidProductId">
                          <con:path>$CreditCardNumber</con:path>
                        </con:param>
                      </con:xqueryTransform>
                    </con1:expr>
                  </con1:assign>
                </con1:requestTransform>
                <con1:responseTransform>
                  <con2:assign varName="SUCCESS_INDICATOR" xmlns:con1="http://www.bea.com/wli/sb/stages/config" xmlns:con="http://www.bea.com/wli/sb/pipeline/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config">
                    <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-8591433004399123688-1be0e88f.1673321bc70.-7973</con4:id>
                    <con2:expr>
                      <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">fn:upper-case(xs:string($RESTransferenciaHeader/aut:ResponseHeader/successIndicator/text()))</con4:xqueryText>
                    </con2:expr>
                  </con2:assign>
                  <con1:ifThenElse>
                    <con:id>_ActionId-6869206689994337394-1a17d280.16876a11565.-7db5</con:id>
                    <con1:case>
                      <con1:condition>
                        <con:xqueryText>(: if ERROR :)
fn:upper-case($SUCCESS_INDICATOR) != 'SUCCESS'</con:xqueryText>
                      </con1:condition>
                      <con1:actions>
                        <con1:assign varName="ERROR_DESCRIPTION">
                          <con:id>_ActionId-6919066363307264053--7083b82d.16e1e8e32fc.-7f7b</con:id>
                          <con1:expr>
                            <con:xqueryText>xs:string($RESTransferenciaHeader/aut:ResponseHeader/messages/text())</con:xqueryText>
                          </con1:expr>
                        </con1:assign>
                        <con1:assign varName="ERROR_CODE">
                          <con:id>_ActionId-6919066363307264053--7083b82d.16e1e8e32fc.-7f79</con:id>
                          <con1:expr>
                            <con:xqueryText>xs:string($RESTransferenciaHeader/aut:ResponseHeader/messageId/text())</con:xqueryText>
                          </con1:expr>
                        </con1:assign>
                        <con1:assign varName="MAPEAR_ERROR">
                          <con:id>_ActionId-6919066363307264053--7083b82d.16e1e8e32fc.-7f77</con:id>
                          <con1:expr>
                            <con:xqueryText>'NO'</con:xqueryText>
                          </con1:expr>
                        </con1:assign>
                      </con1:actions>
                    </con1:case>
                    <con1:default>
                      <con1:assign varName="AtomicityStage">
                        <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-7527</con:id>
                        <con1:expr>
                          <con:xqueryText>concat(data($body/pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE/KV_PAIR[KEY="ACCOUNT_CURRENCY"]/VALUE), ',#DEB#')</con:xqueryText>
                        </con1:expr>
                      </con1:assign>
                      <con1:replace varName="body" contents-only="true">
                        <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-7490</con:id>
                        <con1:location>
                          <con:xpathText>./pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE/KV_PAIR[KEY="ATOMICITY_STAGE"]/VALUE</con:xpathText>
                        </con1:location>
                        <con1:expr>
                          <con:xqueryText>$AtomicityStage</con:xqueryText>
                        </con1:expr>
                      </con1:replace>
                    </con1:default>
                  </con1:ifThenElse>
                </con1:responseTransform>
              </con1:wsCallout>
            </con1:default>
          </con1:ifThenElse>
        </con2:actions>
      </con2:stage>
      <con2:stage name="PagoTarjetaCredito">
        <con2:context>
          <con:userNsDecl namespace="http://xmlns.oracle.com/pcbpel/adapter/db/sp/ControlAtomicidad" prefix="con"/>
          <con:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/autType" prefix="aut"/>
          <con:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/pagoTarjetaCreditoTypes" prefix="pag"/>
        </con2:context>
        <con2:actions>
          <con1:replace varName="body">
            <con:id>_ActionId-3994666180538908780--4f4eb6d6.16f8c4fbacc.-7fe4</con:id>
            <con1:location>
              <con:xpathText>./pag:pagoTarjetaCredito/DEBIT_ACCOUNT</con:xpathText>
            </con1:location>
            <con1:expr>
              <con:xqueryText>&lt;DEBIT_ACCOUNT>{$CardPaymentDebitAccount}&lt;/DEBIT_ACCOUNT></con:xqueryText>
            </con1:expr>
          </con1:replace>
          <con1:ifThenElse>
            <con:id>_ActionId-4104752579862755709-753b62ee.166cb630dab.-7175</con:id>
            <con1:case>
              <con1:condition>
                <con:xqueryText>(: if ERROR or StageCompleted :)
fn:upper-case($SUCCESS_INDICATOR) != 'SUCCESS'
or
fn:contains(data($body/pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE/KV_PAIR[KEY="ACCOUNT_CURRENCY"]/VALUE), '#PTC#')</con:xqueryText>
              </con1:condition>
              <con1:actions/>
            </con1:case>
            <con1:default>
              <con1:wsCallout>
                <con:id>_ActionId-4104752579862755709-753b62ee.166cb630dab.-716f</con:id>
                <con1:service xsi:type="ref:ProxyRef" ref="Middleware/v3/ProxyServices/PagoTarjetaCredito/local/PagoTarjetaCreditoRouter" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                <con1:operation>pagoTarjetaCredito</con1:operation>
                <con1:request>
                  <con1:body>$REQBody</con1:body>
                  <con1:header>$REQHeader</con1:header>
                </con1:request>
                <con1:response>
                  <con1:body>RESPagoTarjetaCreditoBody</con1:body>
                  <con1:header>RESPagoTarjetaCreditoHeader</con1:header>
                </con1:response>
                <con1:requestTransform>
                  <con1:assign varName="REQHeader">
                    <con:id>_ActionId-8848856852205208947-5a567015.16f1fe21943.-7e09</con:id>
                    <con1:expr>
                      <con:xqueryText>$header</con:xqueryText>
                    </con1:expr>
                  </con1:assign>
                  <con1:assign varName="REQBody">
                    <con:id>_ActionId-4104752579862755709-753b62ee.166cb630dab.-7171</con:id>
                    <con1:expr>
                      <con:xqueryText>$body/pag:pagoTarjetaCredito</con:xqueryText>
                    </con1:expr>
                  </con1:assign>
                </con1:requestTransform>
                <con1:responseTransform>
                  <con2:assign varName="SUCCESS_INDICATOR" xmlns:con1="http://www.bea.com/wli/sb/stages/config" xmlns:con="http://www.bea.com/wli/sb/pipeline/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config">
                    <con4:id xmlns:con4="http://www.bea.com/wli/sb/stages/config">_ActionId-4104752579862755709-753b62ee.166cb630dab.-7164</con4:id>
                    <con2:expr>
                      <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">fn:upper-case($RESPagoTarjetaCreditoHeader/aut:ResponseHeader/successIndicator)</con4:xqueryText>
                    </con2:expr>
                  </con2:assign>
                  <con1:ifThenElse>
                    <con:id>_ActionId-7563419179578591254-2d288378.167c26aee35.-7b9d</con:id>
                    <con1:case>
                      <con1:condition>
                        <con:xqueryText>(: if ERROR :)
fn:upper-case($SUCCESS_INDICATOR) != 'SUCCESS'</con:xqueryText>
                      </con1:condition>
                      <con1:actions>
                        <con1:assign varName="ERROR_DESCRIPTION">
                          <con:id>_ActionId-6554312317264086991--20db31f7.16b807aa39d.-76f0</con:id>
                          <con1:expr>
                            <con:xqueryText>$RESPagoTarjetaCreditoHeader/aut:ResponseHeader/messages/text()</con:xqueryText>
                          </con1:expr>
                        </con1:assign>
                        <con1:assign varName="MAPEAR_ERROR">
                          <con:id>_ActionId-6554312317264086991--20db31f7.16b807aa39d.-76ee</con:id>
                          <con1:expr>
                            <con:xqueryText>'NO'</con:xqueryText>
                          </con1:expr>
                        </con1:assign>
                        <con1:wsCallout>
                          <con:id>_ActionId-7563419179578591254-2d288378.167c26aee35.-7b99</con:id>
                          <con1:service xsi:type="ref:BusinessServiceRef" ref="Middleware/v3/BusinessServices/ControlAtomicidad/biz/ControlAtomicidad_db" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                          <con1:operation>ControlAtomicidad</con1:operation>
                          <con1:request>
                            <con1:body>$REQAtomicidad</con1:body>
                          </con1:request>
                          <con1:response>
                            <con1:body>RESAtomicidad</con1:body>
                          </con1:response>
                          <con1:requestTransform>
                            <con1:assign varName="REQAtomicidad">
                              <con:id>_ActionId-7563419179578591254-2d288378.167c26aee35.-7b9a</con:id>
                              <con1:expr>
                                <con:xqueryTransform>
                                  <con:resource ref="Middleware/v3/Resources/ControlAtomicidad/ControlAtomicidadIn"/>
                                  <con:param name="V_URI_ID">
                                    <con:path>'https://mwomnidesa:8004/Middleware/v3/ProxyServices/PagoTarjetaCredito/local/PagoTarjetaCreditoRouter?wsdl'</con:path>
                                  </con:param>
                                  <con:param name="V_UUID_BITACORA">
                                    <con:path>$uuidBitacoraRequest</con:path>
                                  </con:param>
                                  <con:param name="OriginalHeader">
                                    <con:path>$header/aut:RequestHeader</con:path>
                                  </con:param>
                                  <con:param name="OriginalBody">
                                    <con:path>$body/pag:pagoTarjetaCredito</con:path>
                                  </con:param>
                                  <con:param name="V_ALTER_ID">
                                    <con:path>1</con:path>
                                  </con:param>
                                </con:xqueryTransform>
                              </con1:expr>
                            </con1:assign>
                          </con1:requestTransform>
                          <con1:responseTransform>
                            <con1:assign varName="AtomicityStage">
                              <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-733a</con:id>
                              <con1:expr>
                                <con:xqueryText>concat(data($body/pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE/KV_PAIR[KEY="ACCOUNT_CURRENCY"]/VALUE), ',#PTC#')</con:xqueryText>
                              </con1:expr>
                            </con1:assign>
                            <con1:replace varName="body" contents-only="true">
                              <con:id>_ActionId-4518045293055997833--7f99d586.16fe959805b.-7339</con:id>
                              <con1:location>
                                <con:xpathText>./pag:pagoTarjetaCredito/REGIONAL_DETAILS/SOURCE/KV_PAIR[KEY="ATOMICITY_STAGE"]/VALUE</con:xpathText>
                              </con1:location>
                              <con1:expr>
                                <con:xqueryText>$AtomicityStage</con:xqueryText>
                              </con1:expr>
                            </con1:replace>
                          </con1:responseTransform>
                        </con1:wsCallout>
                      </con1:actions>
                    </con1:case>
                    <con1:default/>
                  </con1:ifThenElse>
                </con1:responseTransform>
              </con1:wsCallout>
            </con1:default>
          </con1:ifThenElse>
        </con2:actions>
      </con2:stage>
    </con2:pipeline>
    <con2:pipeline type="response" name="PagoTarjeta_response">
      <con2:stage name="FlujoSalida">
        <con2:context xmlns:con3="http://www.bea.com/wli/sb/services/security/config">
          <con:userNsDecl namespace="http://xmlns.oracle.com/pcbpel/adapter/db/sp/pagoTarjetaCredito" prefix="ns0"/>
          <con:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/pagoTarjetaCreditoTypes" prefix="pag"/>
          <con:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/autType" prefix="aut"/>
        </con2:context>
        <con2:actions xmlns:con3="http://www.bea.com/wli/sb/services/security/config">
          <con1:assign varName="TimeStamp" xmlns:con3="http://www.bea.com/wli/sb/stages/routing/config">
            <con:id>_ActionId-6869206689994337394-1a17d280.16876a11565.-7b83</con:id>
            <con1:expr>
              <con:xqueryText>current-time()</con:xqueryText>
            </con1:expr>
          </con1:assign>
          <con1:ifThenElse>
            <con:id>_ActionId-4104752579862755709-753b62ee.166cb630dab.-77aa</con:id>
            <con1:case>
              <con1:condition>
                <con:xqueryText>'SUCCESS' = fn:upper-case($SUCCESS_INDICATOR)</con:xqueryText>
              </con1:condition>
              <con1:actions>
                <con1:replace contents-only="false" varName="header">
                  <con:id>_ActionId-4104752579862755709-753b62ee.166cb630dab.-77a9</con:id>
                  <con1:expr>
                    <con:xqueryText>$RESPagoTarjetaCreditoHeader</con:xqueryText>
                  </con1:expr>
                </con1:replace>
                <con1:replace contents-only="true" varName="body">
                  <con:id>_ActionId-4104752579862755709-753b62ee.166cb630dab.-77a8</con:id>
                  <con1:expr>
                    <con:xqueryText>$RESPagoTarjetaCreditoBody</con:xqueryText>
                  </con1:expr>
                </con1:replace>
              </con1:actions>
            </con1:case>
            <con1:default>
              <con1:ifThenElse>
                <con:id>_ActionId-964386371150892299-6c26fdca.16b703fb769.-7f1a</con:id>
                <con1:case>
                  <con1:condition>
                    <con:xqueryText>$MAPEAR_ERROR != 'NO'</con:xqueryText>
                  </con1:condition>
                  <con1:actions>
                    <con3:wsCallout xmlns:con1="http://www.bea.com/wli/sb/pipeline/config" xmlns:con="http://www.bea.com/wli/sb/services/security/config" xmlns:con4="http://www.bea.com/wli/sb/stages/publish/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/stages/transform/config">
                      <con2:id>_ActionId-964386371150892299-6c26fdca.16b703fb769.-7f14</con2:id>
                      <con3:service xsi:type="ref:ProxyRef" ref="Middleware/v2/ProxyServices/MapeoErrores" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                      <con3:operation>mapeoErrores</con3:operation>
                      <con3:request>
                        <con3:body>$reqMapeoErrores</con3:body>
                      </con3:request>
                      <con3:response>
                        <con3:body>respMapeoErrores</con3:body>
                      </con3:response>
                      <con3:requestTransform>
                        <con3:assign varName="reqMapeoErrores">
                          <con2:id>_ActionId-964386371150892299-6c26fdca.16b703fb769.-7f16</con2:id>
                          <con3:expr>
                            <con2:xqueryTransform>
                              <con2:resource ref="Middleware/v2/Resources/MapeoErrores/xq/mapeoErroresUsageIn"/>
                              <con2:param name="MENSAJE_ERROR">
                                <con2:path>fn:concat($SERVICE_CODE,"$#$",fn:string-join($ERROR_DESCRIPTION, '||'))</con2:path>
                              </con2:param>
                              <con2:param name="CODIGO_ERROR">
                                <con2:path>$ERROR_CODE</con2:path>
                              </con2:param>
                            </con2:xqueryTransform>
                          </con3:expr>
                        </con3:assign>
                      </con3:requestTransform>
                      <con3:responseTransform>
                        <con3:replace contents-only="true" varName="header">
                          <con2:id>_ActionId-964386371150892299-6c26fdca.16b703fb769.-7f15</con2:id>
                          <con3:expr>
                            <con2:xqueryTransform>
                              <con2:resource ref="Middleware/v2/Resources/MapeoErrores/xq/mapeoErroresUsageOut"/>
                              <con2:param name="mapeoErroresResponse1">
                                <con2:path>$respMapeoErrores</con2:path>
                              </con2:param>
                              <con2:param name="successIndicator">
                                <con2:path>$SUCCES_INDICATOR</con2:path>
                              </con2:param>
                            </con2:xqueryTransform>
                          </con3:expr>
                        </con3:replace>
                      </con3:responseTransform>
                    </con3:wsCallout>
                  </con1:actions>
                </con1:case>
                <con1:default>
                  <con1:replace varName="header" contents-only="true">
                    <con:id>_ActionId-964386371150892299-6c26fdca.16b703fb769.-7f12</con:id>
                    <con1:expr>
                      <con:xqueryText><![CDATA[<aut:ResponseHeader>
    <messageId>{ $ERROR_CODE }</messageId>
	<successIndicator>{$SUCCESS_INDICATOR}</successIndicator>
	<messages>{ $ERROR_DESCRIPTION }</messages>
</aut:ResponseHeader>]]></con:xqueryText>
                    </con1:expr>
                  </con1:replace>
                </con1:default>
              </con1:ifThenElse>
              <con1:replace varName="body" contents-only="true">
                <con:id>_ActionId-964386371150892299-6c26fdca.16b703fb769.-7eda</con:id>
                <con1:expr>
                  <con:xqueryText>&lt;pag:pagoTarjetaCreditoResponse/></con:xqueryText>
                </con1:expr>
              </con1:replace>
            </con1:default>
          </con1:ifThenElse>
        </con2:actions>
      </con2:stage>
      <con2:stage name="BitacoraResponse">
        <con2:context xmlns:con4="http://www.bea.com/wli/sb/services/security/config" xmlns:con3="http://www.bea.com/wli/sb/stages/publish/config">
          <con4:varNsDecl namespace="http://www.ficohsa.com.hn/middleware.services/autType" prefix="aut" xmlns:con4="http://www.bea.com/wli/sb/stages/config"/>
        </con2:context>
        <con2:actions xmlns:con4="http://www.bea.com/wli/sb/services/security/config" xmlns:con3="http://www.bea.com/wli/sb/stages/publish/config">
          <con5:assign varName="uuidBitacoraRequest" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con:id>_ActionId-8591433004399123688-1be0e88f.1673321bc70.-7d50</con:id>
            <con5:expr>
              <con4:xqueryTransform xmlns:con4="http://www.bea.com/wli/sb/stages/config">
                <con4:resource ref="Middleware/Business_Resources/general/UUID/obtenerUUID"/>
              </con4:xqueryTransform>
            </con5:expr>
          </con5:assign>
          <con5:assign varName="header" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con:id>_ActionId-8591433004399123688-1be0e88f.1673321bc70.-7d4a</con:id>
            <con5:expr>
              <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">$header</con4:xqueryText>
            </con5:expr>
          </con5:assign>
          <con5:assign varName="body" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
            <con:id>_ActionId-8591433004399123688-1be0e88f.1673321bc70.-7d4f</con:id>
            <con5:expr>
              <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">$body</con4:xqueryText>
            </con5:expr>
          </con5:assign>
          <con3:route>
            <con:id>_ActionId-8591433004399123688-1be0e88f.1673321bc70.-7d4d</con:id>
            <con3:service ref="Middleware/v2/BusinessServices/OSB/RegistrarBitacoraOSB_v2/biz/RegistrarBitacoraOSB_v2" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
            <con3:operation>registrarBitacoraOSB</con3:operation>
            <con3:outboundTransform>
              <con5:replace varName="body" contents-only="true" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
                <con:id>_ActionId-8591433004399123688-1be0e88f.1673321bc70.-7d4c</con:id>
                <con5:location>
                  <con4:xpathText xmlns:con4="http://www.bea.com/wli/sb/stages/config">.</con4:xpathText>
                </con5:location>
                <con5:expr>
                  <con4:xqueryTransform xmlns:con4="http://www.bea.com/wli/sb/stages/config">
                    <con4:resource ref="Middleware/v2/Resources/Generales/xq/registrarBitacoraOSBIn"/>
                    <con4:param name="UuidReq">
                      <con4:path>""</con4:path>
                    </con4:param>
                    <con4:param name="IdOsb">
                      <con4:path>fn:string($inbound/ctx:transport/ctx:request/tp:headers/http:Host/text())</con4:path>
                    </con4:param>
                    <con4:param name="BancoDestino">
                      <con4:path>fn:string($header/aut:RequestHeader/Region/SourceBank/text())</con4:path>
                    </con4:param>
                    <con4:param name="Uuid">
                      <con4:path>$uuidBitacoraRequest</con4:path>
                    </con4:param>
                    <con4:param name="Contenido">
                      <con4:path>$body</con4:path>
                    </con4:param>
                    <con4:param name="BancoOrigen">
                      <con4:path>fn:string($header/aut:RequestHeader/Region/DestinationBank/text())</con4:path>
                    </con4:param>
                    <con4:param name="Usuario">
                      <con4:path>fn:string($header/aut:RequestHeader/Authentication/UserName/text())</con4:path>
                    </con4:param>
                    <con4:param name="Resultado">
                      <con4:path>""</con4:path>
                    </con4:param>
                    <con4:param name="IdServicio">
                      <con4:path>"FICBCO0063"</con4:path>
                    </con4:param>
                    <con4:param name="IdTxn">
                      <con4:path>""</con4:path>
                    </con4:param>
                    <con4:param name="IdOperacion">
                      <con4:path>fn:string($operation)</con4:path>
                    </con4:param>
                    <con4:param name="TipoMensaje">
                      <con4:path>"REQ"</con4:path>
                    </con4:param>
                    <con4:param name="FechaTxn">
                      <con4:path>current-date()</con4:path>
                    </con4:param>
                    <con4:param name="MensajeError">
                      <con4:path>""</con4:path>
                    </con4:param>
                  </con4:xqueryTransform>
                </con5:expr>
              </con5:replace>
            </con3:outboundTransform>
          </con3:route>
        </con2:actions>
      </con2:stage>
    </con2:pipeline>
    <con:flow xmlns:con="http://www.bea.com/wli/sb/pipeline/config">
      <con:pipeline-node name="PagoTarjeta">
        <con:request>PagoTarjeta_request</con:request>
        <con:response>PagoTarjeta_response</con:response>
      </con:pipeline-node>
    </con:flow>
  </ser:router>
</xml-fragment>