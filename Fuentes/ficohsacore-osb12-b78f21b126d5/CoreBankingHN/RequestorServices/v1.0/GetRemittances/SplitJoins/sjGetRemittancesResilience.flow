<bpel:process name="sjGetRemittancesResilience" targetNamespace="http://xmlns.oracle.com/DynamoMigrate/CoreBankingHN/" bea:name="sjGetRemittancesResilience" rescon:snippetVersion="1.0" xmlns:tns="http://xmlns.oracle.com/DynamoMigrate/CoreBankingHN/" xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable" xmlns:rescon="http://www.bea.com/alsb/flow/resources/config" xmlns:bea="http://www.bea.com/bpel/ui/extensions" xmlns:ext="http://www.bea.com/bpel/extensions" xmlns:expr="http://www.bea.com/wli/sb/stages/config" xmlns:trf="http://www.bea.com/wli/sb/stages/transform/config" xmlns:bind="http://xmlns.oracle.com/DynamoMigrate/CoreBankingHN/sjGetRemittancesResilience" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:dvm="http://www.oracle.com/osb/xpath-functions/dvm" xmlns:ns0="http://www.bea.com/wli/sb/reference" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ns1="T24WebServicesImpl">
    <bpel:partnerLinks>
        <bpel:partnerLink name="sjGetRemittancesResilience" partnerLinkType="tns:sjGetRemittancesResilience" myRole="sjGetRemittancesResilience">
	       </bpel:partnerLink>
        <bpel:partnerLink name="Remittances_BS" partnerLinkType="tns:Remittances_BS" partnerRole="Remittances_BS"/>
    </bpel:partnerLinks>

	   <bpel:variables>
        <bpel:variable name="request" messageType="bind:sjGetRemittancesResilience">
	       </bpel:variable>
	       <bpel:variable name="response" messageType="bind:sjGetRemittancesResilienceResponse">
	       </bpel:variable>
        <bpel:variable name="endCycle" type="xsd:string"/>
        <bpel:variable name="retryCount" type="xsd:string"/>
        <bpel:variable name="resilienceError" type="xsd:string"/>
        <bpel:variable name="REQConsultaderemesa" messageType="ns1:Consultaderemesa"/>
        <bpel:variable name="RSPConsultaderemesa" messageType="ns1:ConsultaderemesaResponse"/>
    </bpel:variables>

    <bpel:sequence>
        <bpel:receive partnerLink="sjGetRemittancesResilience" operation="Consultaderemesa" variable="request" createInstance="yes">
	           <rescon:receiveInfo>
                <rescon:wsdl ref="CoreBankingHN/RequestorServices/v1.0/GetRemittances/WSDL/sjGetRemittancesResilience" binding="bind:T24WebServicesImplPortBinding"/>
            </rescon:receiveInfo>
        </bpel:receive>
        <bpel:scope bea:name="Variables">
            <bpel:sequence>
                <bpel:assign>
                    <bpel:extensionAssignOperation>
                        <trf:assign varName="endCycle">
                            <trf:expr>
                                <expr:xqueryText>0</expr:xqueryText>
                            </trf:expr>
                        </trf:assign>
                    </bpel:extensionAssignOperation>
                    <bpel:extensionAssignOperation>
                        <trf:assign varName="retryCount">
                            <trf:expr>
                                <expr:xqueryText>dvm:lookup('CoreBankingHN/RequestorServices/v1.0/GetRemittances/DVM/RemittancesParameters', 'Parameter', "RESILIENCIA.RETRYCOUNT", 'Value', '0')</expr:xqueryText>
                            </trf:expr>
                        </trf:assign>
                    </bpel:extensionAssignOperation>
                    <bpel:extensionAssignOperation>
                        <trf:assign varName="resilienceError">
                            <trf:expr>
                                <expr:xqueryText>'com.temenos.tws.connectivity.ConnectivityException'</expr:xqueryText>
                            </trf:expr>
                        </trf:assign>
                    </bpel:extensionAssignOperation>
                </bpel:assign>
            </bpel:sequence>
        </bpel:scope>
        <bpel:repeatUntil>
            <bpel:sequence>
                <bpel:assign>
                    <bpel:extensionAssignOperation>
                        <trf:assign varName="retryCount">
                            <trf:expr>
                                <expr:xqueryText>number($retryCount) - 1</expr:xqueryText>
                            </trf:expr>
                        </trf:assign>
                    </bpel:extensionAssignOperation>
                    <bpel:extensionAssignOperation>
                        <trf:assign varName="REQConsultaderemesa.parameters">
                            <trf:expr>
                                <expr:xqueryText>$request.parameters</expr:xqueryText>
                            </trf:expr>
                        </trf:assign>
                    </bpel:extensionAssignOperation>
                </bpel:assign>
                <bpel:invoke partnerLink="Remittances_BS" operation="Consultaderemesa" inputVariable="REQConsultaderemesa" outputVariable="RSPConsultaderemesa">
                    <rescon:invokeInfo>
                        <rescon:service ref="CoreBankingHN/ProviderServices/BusinessServices/Remittances/Remittances_BS" xsi:type="ns0:BusinessServiceRef"/>
                    </rescon:invokeInfo>
                </bpel:invoke>
                <bpel:assign>
                    <bpel:extensionAssignOperation>
                        <trf:assign varName="endCycle">
                            <trf:expr>
                                <expr:xqueryText>not(fn:exists($RSPConsultaderemesa.parameters/Status/messages[messages = 'com.temenos.tws.connectivity.ConnectivityException']))</expr:xqueryText>
                            </trf:expr>
                        </trf:assign>
                    </bpel:extensionAssignOperation>
                </bpel:assign>
            </bpel:sequence>
            <bpel:condition>string($RSPConsultaderemesa.parameters/Status/successIndicator/text()) = "Success" or number($retryCount) &lt; 0 or $endCycle</bpel:condition>
        </bpel:repeatUntil>
        <bpel:assign>
            <bpel:extensionAssignOperation>
                <trf:assign varName="response.parameters">
                    <trf:expr>
                        <expr:xqueryText>$RSPConsultaderemesa.parameters</expr:xqueryText>
                    </trf:expr>
                </trf:assign>
            </bpel:extensionAssignOperation>
        </bpel:assign>
        <bpel:reply partnerLink="sjGetRemittancesResilience" operation="Consultaderemesa" variable="response"/>
    </bpel:sequence>
</bpel:process>