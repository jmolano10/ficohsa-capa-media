<?xml version="1.0" encoding="UTF-8"?>
<bpel:process name="sjEvaluateAbanksAccount"
              targetNamespace="http://xmlns.oracle.com/DynamoMigrate/CoreBankingHN/"
              xmlns:tns="http://xmlns.oracle.com/DynamoMigrate/CoreBankingHN/"
              xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
              xmlns:rescon="http://www.bea.com/alsb/flow/resources/config"
              xmlns:bea="http://www.bea.com/bpel/ui/extensions"
              xmlns:ext="http://www.bea.com/bpel/extensions"
              xmlns:expr="http://www.bea.com/wli/sb/stages/config"
              xmlns:trf="http://www.bea.com/wli/sb/stages/transform/config"
              xmlns:bind="http://xmlns.oracle.com/sjEvaluateAbanksAccount" 
              bea:name="sjEvaluateAbanksAccount"
              rescon:snippetVersion="1.0"
              xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:ns0="http://www.bea.com/wli/sb/reference"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xmlns:ns1="http://xmlns.oracle.com/pcbpel/adapter/db/DynamoMigrate/CoreBankingHN/GetValidSubApplication"
              xmlns:get="http://xmlns.oracle.com/pcbpel/adapter/db/sp/GetValidSubApplication"
              xmlns:ns2="http://xmlns.oracle.com/pcbpel/adapter/db/MigrationDynamo/CommonResources/SetLogInfoService_BS"
              xmlns:com="http://www.ficohsa.com.hn/middleware.services/commonTypes"
              xmlns:sjev="http://www.ficohsa.com.hn/middleware.services/sjEvaluateAbanksAccountTypes">
    <bpel:partnerLinks>
        <bpel:partnerLink name="sjEvaluateAbanksAccount" partnerLinkType="tns:sjEvaluateAbanksAccount"
                          myRole="sjEvaluateAbanksAccount">
	       </bpel:partnerLink>
        <bpel:partnerLink name="GetValidSubApplication_BS" partnerLinkType="tns:GetValidSubApplication_BS"
                          partnerRole="GetValidSubApplication_BS"/>
        <bpel:partnerLink name="SetLogInfoService_BS" partnerLinkType="tns:SetLogInfoService_BS"
                          partnerRole="SetLogInfoService_BS"/>
    </bpel:partnerLinks>

	   <bpel:variables>
        <bpel:variable name="request"
	                      messageType="bind:sjEvaluateAbanksAccountRequest">
	       </bpel:variable>
	       <bpel:variable name="response"
                       messageType="bind:sjEvaluateAbanksAccountResponse">
	       </bpel:variable>
    </bpel:variables>

    <bpel:sequence>
        <bpel:receive partnerLink="sjEvaluateAbanksAccount" operation="sjEvaluateAbanksAccount" variable="request" createInstance="yes">
	           <rescon:receiveInfo>
                <rescon:wsdl ref="CoreBankingHN/RequestorServices/v1.0/AccountValidation/WSDL/sjEvaluateAbanksAccount" binding="bind:sjEvaluateAbanksAccount_ptt-binding"/>
            </rescon:receiveInfo>
        </bpel:receive>
        <bpel:assign>
            <bpel:extensionAssignOperation>
                <trf:assign varName="response.outputParameters">
                    <trf:expr>
                        <expr:xqueryText>&lt;node/&gt;</expr:xqueryText>
                    </trf:expr>
                </trf:assign>
            </bpel:extensionAssignOperation>
        </bpel:assign>
        <bpel:forEach parallel="yes" counterName="counter">
            <bpel:startCounterValue>number(1)</bpel:startCounterValue>
            <bpel:finalCounterValue>number(3)</bpel:finalCounterValue>
            <bpel:scope>
                <bpel:variables>
                    <bpel:variable name="BoolResponse" type="xsd:string"/>
                    <bpel:variable name="FormatAccount" type="xsd:string"/>
                    <bpel:variable name="AccountNumber" type="xsd:string"/>
                    <bpel:variable name="SubApplication" type="xsd:string"/>
                    <bpel:variable name="REQGetValidSubApplication" messageType="ns1:args_in_msg"/>
                    <bpel:variable name="RSPGetValidSubApplication" messageType="ns1:args_out_msg"/>
                    <bpel:variable name="bodyRegLog" messageType="ns2:args_in_msg"/>
                    <bpel:variable name="bodyRspLog" messageType="ns2:args_out_msg"/>
                </bpel:variables>
                <bpel:sequence>
                    <bpel:assign>
                        <bpel:extensionAssignOperation>
                            <trf:assign varName="AccountNumber">
                                <trf:expr>
                                    <expr:xqueryTransform>
                                        <expr:resource ref="CoreBankingHN/RequestorServices/v1.0/AccountValidation/XQ/EvaluateAbanksAccountIn"/>
                                        <expr:param name="counter">
                                            <expr:path>$counter</expr:path>
                                        </expr:param>
                                        <expr:param name="sjEvaluateAbanksAccountRequest">
                                            <expr:path>$request.inputParameters</expr:path>
                                        </expr:param>
                                    </expr:xqueryTransform>
                                </trf:expr>
                            </trf:assign>
                        </bpel:extensionAssignOperation>
                    </bpel:assign>
                    <bpel:if>
                        <bpel:condition>string-length($AccountNumber) &gt; 6 and string-length($AccountNumber) &lt;= 14</bpel:condition>
                        <bpel:sequence>
                            <bpel:empty/>
                            <bpel:assign>
                                <bpel:extensionAssignOperation>
                                    <trf:javaCallout varName="BoolResponse">
                                        <trf:archive ref="CommonResources/JavaCallout/Utilities"/>
                                        <trf:className>ficohsa.utilities.Utilities</trf:className>
                                        <trf:method>public static boolean DigitoVerificadorMod10(java.lang.String)</trf:method>
                                        <trf:expr>
                                            <expr:xqueryTransform>
                                                <expr:resource ref="CoreBankingHN/RequestorServices/v1.0/AccountValidation/XQ/EvaluateAbanksAccountIn"/>
                                                <expr:param name="counter">
                                                    <expr:path>$counter</expr:path>
                                                </expr:param>
                                                <expr:param name="sjEvaluateAbanksAccountRequest">
                                                    <expr:path>$request.inputParameters</expr:path>
                                                </expr:param>
                                            </expr:xqueryTransform>
                                        </trf:expr>
                                    </trf:javaCallout>
                                </bpel:extensionAssignOperation>
                                <bpel:extensionAssignOperation>
                                    <trf:assign varName="FormatAccount">
                                        <trf:expr>
                                            <expr:xqueryTransform>
                                                <expr:resource ref="CoreBankingHN/RequestorServices/v1.0/AccountValidation/XQ/FormatAccountIn"/>
                                                <expr:param name="counter">
                                                    <expr:path>$counter</expr:path>
                                                </expr:param>
                                                <expr:param name="sjEvaluateAbanksAccountRequest">
                                                    <expr:path>$request.inputParameters</expr:path>
                                                </expr:param>
                                            </expr:xqueryTransform>
                                        </trf:expr>
                                    </trf:assign>
                                </bpel:extensionAssignOperation>
                                <bpel:extensionAssignOperation>
                                    <trf:javaCallout varName="FormatAccount">
                                        <trf:archive ref="CommonResources/JavaCallout/Utilities"/>
                                        <trf:className>ficohsa.utilities.Utilities</trf:className>
                                        <trf:method>public static java.lang.String formatearCuentaAbks(java.lang.String)</trf:method>
                                        <trf:expr>
                                            <expr:xqueryText>$FormatAccount</expr:xqueryText>
                                        </trf:expr>
                                    </trf:javaCallout>
                                </bpel:extensionAssignOperation>
                                <bpel:extensionAssignOperation>
                                    <trf:assign varName="SubApplication">
                                        <trf:expr>
                                            <expr:xqueryText>fn:substring($FormatAccount,4,3)</expr:xqueryText>
                                        </trf:expr>
                                    </trf:assign>
                                </bpel:extensionAssignOperation>
                                <bpel:extensionAssignOperation>
                                    <trf:assign varName="REQGetValidSubApplication.InputParameters">
                                        <trf:expr>
                                            <expr:xqueryTransform>
                                                <expr:resource ref="CoreBankingHN/RequestorServices/v1.0/AccountValidation/XQ/GetValidSubApplicationIn"/>
                                                <expr:param name="SubApplication">
                                                    <expr:path>$SubApplication</expr:path>
                                                </expr:param>
                                            </expr:xqueryTransform>
                                        </trf:expr>
                                    </trf:assign>
                                </bpel:extensionAssignOperation>
                            </bpel:assign>
                            <bpel:assign>
                                <bpel:extensionAssignOperation>
                                    <trf:assign varName="bodyRegLog.InputParameters">
                                        <trf:expr>
                                            <expr:xqueryTransform>
                                                <expr:resource ref="CommonResources/MiddlewareDB/ProviderServices/XQ/Tx_Msg_To_SetLogInfo"/>
                                                <expr:param name="codigoAplicacion">
                                                    <expr:path>1</expr:path>
                                                </expr:param>
                                                <expr:param name="codigoServicio">
                                                    <expr:path>6</expr:path>
                                                </expr:param>
                                                <expr:param name="codigoError">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="contenido">
                                                    <expr:path>fn-bea:serialize($REQGetValidSubApplication.InputParameters)</expr:path>
                                                </expr:param>
                                                <expr:param name="estado">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="codigoSistema">
                                                    <expr:path>2</expr:path>
                                                </expr:param>
                                                <expr:param name="nombreFlujoError">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="fechaHora">
                                                    <expr:path>fn:current-dateTime()</expr:path>
                                                </expr:param>
                                                <expr:param name="parametros">
                                                    <expr:path>fn-bea:serialize($REQGetValidSubApplication.InputParameters)</expr:path>
                                                </expr:param>
                                                <expr:param name="uuid">
                                                    <expr:path>fn:data($request.inputParameters/sjev:Uuid)</expr:path>
                                                </expr:param>
                                                <expr:param name="version">
                                                    <expr:path>'1'</expr:path>
                                                </expr:param>
                                                <expr:param name="operacionServicio">
                                                    <expr:path>'GetValidSubApplication'</expr:path>
                                                </expr:param>
                                                <expr:param name="bancoDestino">
                                                    <expr:path>fn:data($request.inputParameters/sjev:GeneralInfo/com:DestinationBank)</expr:path>
                                                </expr:param>
                                                <expr:param name="endpoint">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="bancoOrigen">
                                                    <expr:path>fn:data($request.inputParameters/sjev:GeneralInfo/com:SourceBank)</expr:path>
                                                </expr:param>
                                                <expr:param name="fechaTX">
                                                    <expr:path>fn:current-dateTime()</expr:path>
                                                </expr:param>
                                                <expr:param name="usuario">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="descripcionError">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="tipoMensaje">
                                                    <expr:path>'Request'</expr:path>
                                                </expr:param>
                                                <expr:param name="metodo">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                            </expr:xqueryTransform>
                                        </trf:expr>
                                    </trf:assign>
                                </bpel:extensionAssignOperation>
                            </bpel:assign>
                            <bpel:invoke partnerLink="SetLogInfoService_BS" operation="SetLogInfoService_BS"
                                         inputVariable="bodyRegLog" outputVariable="bodyRspLog">
                                <rescon:invokeInfo>
                                    <rescon:service ref="CommonResources/MiddlewareDB/ProviderServices/BusinessServices/SetLogInfoService/v1.0/SetLogInfoService_BS"
                                                    xsi:type="ns0:BusinessServiceRef"/>
                                </rescon:invokeInfo>
                            </bpel:invoke>
                            <bpel:invoke partnerLink="GetValidSubApplication_BS" operation="GetValidSubApplication"
                                         inputVariable="REQGetValidSubApplication"
                                         outputVariable="RSPGetValidSubApplication">
                                <rescon:invokeInfo>
                                    <rescon:service ref="CoreBankingHN/ProviderServices/BusinessServices/GetValidSubApplication/GetValidSubApplication_BS"
                                                    xsi:type="ns0:BusinessServiceRef"/>
                                </rescon:invokeInfo>
                            </bpel:invoke>
                            <bpel:assign>
                                <bpel:extensionAssignOperation>
                                    <trf:assign varName="bodyRegLog.InputParameters">
                                        <trf:expr>
                                            <expr:xqueryTransform>
                                                <expr:resource ref="CommonResources/MiddlewareDB/ProviderServices/XQ/Tx_Msg_To_SetLogInfo"/>
                                                <expr:param name="codigoAplicacion">
                                                    <expr:path>1</expr:path>
                                                </expr:param>
                                                <expr:param name="codigoServicio">
                                                    <expr:path>6</expr:path>
                                                </expr:param>
                                                <expr:param name="codigoError">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="contenido">
                                                    <expr:path>fn-bea:serialize($RSPGetValidSubApplication.OutputParameters)</expr:path>
                                                </expr:param>
                                                <expr:param name="estado">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="codigoSistema">
                                                    <expr:path>2</expr:path>
                                                </expr:param>
                                                <expr:param name="nombreFlujoError">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="fechaHora">
                                                    <expr:path>fn:current-dateTime()</expr:path>
                                                </expr:param>
                                                <expr:param name="parametros">
                                                    <expr:path>fn-bea:serialize($RSPGetValidSubApplication.OutputParameters)</expr:path>
                                                </expr:param>
                                                <expr:param name="uuid">
                                                    <expr:path>fn:data($request.inputParameters/sjev:Uuid)</expr:path>
                                                </expr:param>
                                                <expr:param name="version">
                                                    <expr:path>'1'</expr:path>
                                                </expr:param>
                                                <expr:param name="operacionServicio">
                                                    <expr:path>'GetValidSubApplication'</expr:path>
                                                </expr:param>
                                                <expr:param name="bancoDestino">
                                                    <expr:path>fn:data($request.inputParameters/sjev:GeneralInfo/com:DestinationBank)</expr:path>
                                                </expr:param>
                                                <expr:param name="endpoint">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="bancoOrigen">
                                                    <expr:path>fn:data($request.inputParameters/sjev:GeneralInfo/com:SourceBank)</expr:path>
                                                </expr:param>
                                                <expr:param name="fechaTX">
                                                    <expr:path>fn:current-dateTime()</expr:path>
                                                </expr:param>
                                                <expr:param name="usuario">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="descripcionError">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                                <expr:param name="tipoMensaje">
                                                    <expr:path>'Response'</expr:path>
                                                </expr:param>
                                                <expr:param name="metodo">
                                                    <expr:path>''</expr:path>
                                                </expr:param>
                                            </expr:xqueryTransform>
                                        </trf:expr>
                                    </trf:assign>
                                </bpel:extensionAssignOperation>
                            </bpel:assign>
                            <bpel:if>
                                <bpel:condition>string($RSPGetValidSubApplication.OutputParameters/get:VA_FOUND) = 'true'</bpel:condition>
                                <bpel:sequence>
                                    <bpel:empty/>
                                    <bpel:assign>
                                        <bpel:extensionAssignOperation>
                                            <trf:insert varName="response.outputParameters">
                                                <trf:where>first-child</trf:where>
                                                <trf:expr>
                                                    <expr:xqueryText>&lt;sjev:EvaluateAbanksAccount&gt;
&lt;sjev:AccountId&gt;{$FormatAccount}&lt;/sjev:AccountId&gt;
&lt;sjev:Mod10Indicator&gt;{$BoolResponse}&lt;/sjev:Mod10Indicator&gt;
&lt;/sjev:EvaluateAbanksAccount&gt;</expr:xqueryText>
                                                </trf:expr>
                                            </trf:insert>
                                        </bpel:extensionAssignOperation>
                                    </bpel:assign>
                                </bpel:sequence>
                                <bpel:else>
                                    <bpel:sequence>
                                        <bpel:empty/>
                                    </bpel:sequence>
                                </bpel:else>
                            </bpel:if>
                        </bpel:sequence>
                        <bpel:else>
                            <bpel:sequence>
                                <bpel:empty/>
                            </bpel:sequence>
                        </bpel:else>
                    </bpel:if>
                </bpel:sequence>
            </bpel:scope>
        </bpel:forEach>
        <bpel:reply partnerLink="sjEvaluateAbanksAccount" operation="sjEvaluateAbanksAccount" variable="response"></bpel:reply>
    </bpel:sequence>
</bpel:process>