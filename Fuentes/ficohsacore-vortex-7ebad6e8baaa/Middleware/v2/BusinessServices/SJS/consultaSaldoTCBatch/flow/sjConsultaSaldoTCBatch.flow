<bpel:process name="sjConsultaSaldoTCBatch" targetNamespace="http://www.example.com/flow/Middleware/v2/BusinessServices/SJS/consultaSaldoTCBatch/flow/sjConsultaSaldoTCBatch" bea:name="sjConsultaSaldoTCBatch" xmlns:tns="http://www.example.com/flow/Middleware/v2/BusinessServices/SJS/consultaSaldoTCBatch/flow/sjConsultaSaldoTCBatch" xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable" xmlns:rescon="http://www.bea.com/alsb/flow/resources/config" xmlns:bea="http://www.bea.com/bpel/ui/extensions" xmlns:ext="http://www.bea.com/bpel/extensions" xmlns:expr="http://www.bea.com/wli/sb/stages/config" xmlns:trf="http://www.bea.com/wli/sb/stages/transform/config" xmlns:bind="http://www.ficohsa.com.hn/middleware.services/sjConsultaSaldoTCBatch" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:ns1="http://www.ficohsa.com.hn/middleware.services/ConsultaSaldoTCBatchInterno" xmlns:ns0="http://www.ficohsa.com.hn/middleware.services/consultaSaldoTCBatchInternoPS/">
    <bpel:partnerLinks>
        <bpel:partnerLink name="sjConsultaSaldoTCBatch" partnerLinkType="tns:sjConsultaSaldoTCBatch" myRole="sjConsultaSaldoTCBatch">
	       </bpel:partnerLink>
	   <bpel:partnerLink name="ConsultaSaldoTCBatchInterno" partnerLinkType="tns:ConsultaSaldoTCBatchInterno_plnkType" partnerRole="ConsultaSaldoTCBatchInterno_PartnerRole">
	   </bpel:partnerLink></bpel:partnerLinks>

	   <bpel:variables>
        <bpel:variable name="request" messageType="bind:sjConsultaSaldoTCBatch">
	       </bpel:variable>
	       <bpel:variable name="response" messageType="bind:sjConsultaSaldoTCBatchResponse">
	       </bpel:variable>
    <bpel:variable name="totalGroup" type="xsd:int"/>
    <bpel:variable name="groupByCountry" type="xsd:anyType"/>
    <bpel:variable name="modifyRequest" element="bind:sjConsultaSaldoTCBatch">
    </bpel:variable></bpel:variables>

    <bpel:sequence>
        <bpel:receive partnerLink="sjConsultaSaldoTCBatch" operation="consultaSaldoTCBatch" variable="request" createInstance="yes">
	           <rescon:receiveInfo>
                
            <rescon:wsdl ref="Middleware/v2/BusinessServices/SJS/consultaSaldoTCBatch/wsdl/sjConsultaSaldoTCBatchBS" binding="bind:sjConsultaSaldoTCBatchBSSOAP"/></rescon:receiveInfo>
        </bpel:receive>
        <bpel:assign>
        	<bpel:extensionAssignOperation>
        		<trf:assign varName="response.outputParameters">
        			<trf:expr>
        				<expr:xqueryText>&lt;outputParameters>
	&lt;CARDS>&lt;/CARDS>
&lt;/outputParameters></expr:xqueryText></trf:expr></trf:assign>
        	</bpel:extensionAssignOperation>
        <bpel:extensionAssignOperation>
		<bpel:documentation/>
		<trf:assign varName="modifyRequest">
			<trf:expr>
				<expr:xqueryTransform>
					<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaSaldoTCBatch/xq/diferenciarPaises"/>
					<expr:param name="sjConsultaSaldoTCBatch">
						<expr:path>$request.inputParameters</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign>
        </bpel:extensionAssignOperation>
	<bpel:extensionAssignOperation>
		<trf:assign varName="groupByCountry">
			<trf:expr>
				<expr:xqueryTransform>
					<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaSaldoTCBatch/xq/agruparPaises"/>
					<expr:param name="sjConsultaSaldoTCBatch">
						<expr:path>$modifyRequest</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign>
        </bpel:extensionAssignOperation>
	
        <bpel:extensionAssignOperation>
        	<trf:assign varName="totalGroup">
        		<trf:expr>
        			<expr:xqueryText>count($groupByCountry/COUNTRY)</expr:xqueryText></trf:expr></trf:assign>
        </bpel:extensionAssignOperation>
        </bpel:assign>
        <bpel:forEach parallel="yes" counterName="pointerCountry">
        	<bpel:startCounterValue>1</bpel:startCounterValue>
        	<bpel:finalCounterValue>$totalGroup</bpel:finalCounterValue>
        	<bpel:scope>
        		
        		<bpel:variables>
        			<bpel:variable name="REQConsultaSaldoTCBatchInterno" messageType="ns0:consultaSaldoTCBatchInternoRequest">
        			</bpel:variable>
        			<bpel:variable name="RSPConsultaSaldoTCBatchInterno" messageType="ns0:consultaSaldoTCBatchInternoResponse">
        			</bpel:variable>
        			</bpel:variables>
        		<bpel:sequence>
        			<bpel:assign>
        				<bpel:extensionAssignOperation>
        					<trf:assign varName="REQConsultaSaldoTCBatchInterno.parameters">
        						<trf:expr>
        							<expr:xqueryTransform>
        								<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaSaldoTCBatch/xq/consultaSaldoTCBatchInternoIn"/>
        								<expr:param name="groupByCountry">
        									<expr:path>$groupByCountry</expr:path></expr:param>
        								<expr:param name="pointerCountry">
        									<expr:path>$pointerCountry</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign>
        				</bpel:extensionAssignOperation>
        			</bpel:assign>
        			<bpel:invoke operation="consultaSaldoTCBatchInterno" partnerLink="ConsultaSaldoTCBatchInterno" inputVariable="REQConsultaSaldoTCBatchInterno" outputVariable="RSPConsultaSaldoTCBatchInterno">
        				<rescon:invokeInfo><rescon:service ref="Middleware/v2/ProxyServices/ConsultaSaldoTCBatchInterno" xsi:type="con:PipelineRef" xmlns:ref="http://www.bea.com/wli/sb/reference" xmlns:con="http://www.bea.com/wli/sb/pipeline/config" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></rescon:invokeInfo></bpel:invoke>
        			<bpel:assign>
        				<bpel:extensionAssignOperation>
        					<trf:insert varName="response.outputParameters">
        						<trf:location>
        							<expr:xpathText>./CARDS</expr:xpathText></trf:location>
        						<trf:where>last-child</trf:where>
        						<trf:expr>
        							<expr:xqueryText>$RSPConsultaSaldoTCBatchInterno.parameters/CARDS/CARD</expr:xqueryText></trf:expr></trf:insert></bpel:extensionAssignOperation></bpel:assign>
        			</bpel:sequence>
        	</bpel:scope>
        </bpel:forEach>
        <bpel:reply partnerLink="sjConsultaSaldoTCBatch" operation="consultaSaldoTCBatch" variable="response"/>
    </bpel:sequence>
</bpel:process>