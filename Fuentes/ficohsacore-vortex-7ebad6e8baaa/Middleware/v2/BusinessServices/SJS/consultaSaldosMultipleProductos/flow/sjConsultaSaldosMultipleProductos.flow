<bpel:process name="sjConsultaMultipleProductosHN" targetNamespace="http://www.example.com/flow/Middleware/v2/BusinessServices/SJS/consultaMultipleProductosHN/flow/sjConsultaMultipleProductosHN" bea:name="sjConsultaSaldosMultipleProductos" xmlns:tns="http://www.example.com/flow/Middleware/v2/BusinessServices/SJS/consultaMultipleProductosHN/flow/sjConsultaMultipleProductosHN" xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable" xmlns:rescon="http://www.bea.com/alsb/flow/resources/config" xmlns:bea="http://www.bea.com/bpel/ui/extensions" xmlns:ext="http://www.bea.com/bpel/extensions" xmlns:expr="http://www.bea.com/wli/sb/stages/config" xmlns:trf="http://www.bea.com/wli/sb/stages/transform/config" xmlns:bind="http://www.ficohsa.com.hn/middleware.services/sjConsultaMultipleProductosHN" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:ns1="T24WebServicesImpl" xmlns:ns0="http://xmlns.oracle.com/pcbpel/adapter/db/InterbancaSOAApplication/ConsultaFICOPEN/consultaFICOPEN" xmlns:ns2="http://xmlns.oracle.com/pcbpel/adapter/db/InterbancaSOAApplication/ConsultaGeneralPrestamo/consultaGeneralPrestamo" xmlns:ns3="http://tempuri.org/" xmlns:ns4="http://www.ficohsa.com.hn/middleware.services/sjConsultaSaldosMultipleProductos">
    <bpel:partnerLinks>
        <bpel:partnerLink name="sjConsultaMultipleProductosHN" partnerLinkType="tns:sjConsultaMultipleProductosHN" myRole="sjConsultaMultipleProductosHN">
	       </bpel:partnerLink>
	   
	   
	   
	   
	   
	   
	   
	   <bpel:partnerLink name="consultaMultipleProducto" partnerLinkType="tns:consultaMultipleProducto_plnkType" partnerRole="consultaMultipleProducto_PartnerRole">
	   </bpel:partnerLink></bpel:partnerLinks>

	   

    <bpel:variables>
    	
    	<bpel:variable name="response" messageType="ns4:sjConsultaSaldosMultipleProductosResponse">
    	</bpel:variable>
    	<bpel:variable name="request" messageType="ns4:sjConsultaSaldosMultipleProductosRequest">
    	</bpel:variable>
    	
    	
    	<bpel:variable name="successIndicatorT24" type="xsd:string"/>
    	<bpel:variable name="REQConsultaMultipleProducto" messageType="ns1:ConsultaMultipleProducto">
    	</bpel:variable>
    	<bpel:variable name="RSPConsultaMultipleProducto" messageType="ns1:ConsultaMultipleProductoResponse">
    	</bpel:variable></bpel:variables>
    <bpel:sequence>
        <bpel:receive partnerLink="sjConsultaMultipleProductosHN" operation="consultaProductos" createInstance="yes" variable="request">
	           <rescon:receiveInfo>
                
            <rescon:wsdl ref="Middleware/v2/BusinessServices/SJS/consultaSaldosMultipleProductos/wsdl/sjConsultaSaldosMultipleProductos" binding="ns4:sjConsultaSaldosMultipleProductosPSSOAP"/></rescon:receiveInfo>
        </bpel:receive>
        
        
        
        
        
        <bpel:assign>
        	<bpel:extensionAssignOperation>
        		<bpel:documentation/>
        		<trf:assign varName="response.outputParameters">
        			<trf:expr>
        				<expr:xqueryText>&lt;outputParameters>
	&lt;ns4:ASSETS/>
	&lt;ns4:LIABILITIES/>
&lt;/outputParameters></expr:xqueryText></trf:expr></trf:assign>
        	</bpel:extensionAssignOperation>
        </bpel:assign>
        <bpel:scope>
        	<bpel:faultHandlers>
        		<bpel:catchAll>
        			<bpel:sequence>
        				<bpel:empty/>
        			<bpel:assign>
		
        			<bpel:extensionAssignOperation>
		<bpel:documentation/>
		<trf:insert varName="response.outputParameters">
			<trf:location>
				<expr:xpathText>./ns4:ASSETS</expr:xpathText></trf:location>
			<trf:where>last-child</trf:where>
			<trf:expr>
				<expr:xqueryText><![CDATA[for $ID in $request.inputParameters/ns4:PRODUCTS/ns4:ID
return
<ns4:ASSET>
	<ns4:ID>{ data($ID) }</ns4:ID>
	<ns4:TYPE>{string($request.inputParameters/TYPE/text())}</ns4:TYPE>
	<ns4:SOURCE_BANK>HN01</ns4:SOURCE_BANK>
	<ns4:SUCCESS_INDICATOR>ERROR</ns4:SUCCESS_INDICATOR>
	<ns4:ERROR_MESSAGE>ERROR CONSULTANDO EL PRODUCTO</ns4:ERROR_MESSAGE>
</ns4:ASSET>]]></expr:xqueryText></trf:expr></trf:insert>
        			</bpel:extensionAssignOperation></bpel:assign></bpel:sequence>
        		</bpel:catchAll></bpel:faultHandlers>
        	<bpel:sequence>
        		<bpel:assign>
        			
        			<bpel:extensionAssignOperation>
        				<trf:assign varName="REQConsultaMultipleProducto.parameters">
        					<trf:expr>
        						<expr:xqueryTransform>
        							<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaSaldosMultipleProductos/xq/consultaMultipleProductoIn"/>
        							<expr:param name="sjConsultaSaldosMultipleProductos">
        								<expr:path>$request.inputParameters</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign></bpel:extensionAssignOperation>
        			</bpel:assign>
        		<bpel:invoke operation="ConsultaMultipleProducto" partnerLink="consultaMultipleProducto" inputVariable="REQConsultaMultipleProducto" outputVariable="RSPConsultaMultipleProducto">
        			<rescon:invokeInfo><rescon:service ref="Middleware/v2/BusinessServices/ConsultaMultipleProducto/biz/consultaMultipleProducto" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></rescon:invokeInfo></bpel:invoke>
        		<bpel:assign>
        			<bpel:extensionAssignOperation>
        				<trf:assign varName="successIndicatorT24">
        					<trf:expr>
        						<expr:xqueryText>upper-case(string($RSPConsultaMultipleProducto.parameters/Status/successIndicator/text()))</expr:xqueryText></trf:expr></trf:assign></bpel:extensionAssignOperation>
        			
        			<bpel:extensionAssignOperation>
        				<bpel:documentation/>
        				<trf:insert varName="response.outputParameters">
        					<trf:location>
        						<expr:xpathText>./ns4:ASSETS</expr:xpathText></trf:location>
        					<trf:where>last-child</trf:where>
        					<trf:expr>
        						<expr:xqueryText><![CDATA[if($successIndicatorT24 = 'SUCCESS')then(
	for $ID in $request.inputParameters/ns4:PRODUCTS/ns4:ID
	let $cuenta := $RSPConsultaMultipleProducto.parameters/WSFICOACCTDETMULTPRODType/gWSFICOACCTDETMULTPRODDetailType/mWSFICOACCTDETMULTPRODDetailType[ACCOUNTNUMBER=xs:string($ID/text()) or ALTACCTID=xs:string($ID/text())]
	return
	if(count($cuenta) > 0)then(
		<ns4:ASSET>
			<ns4:ID>{ data($ID) }</ns4:ID>
			<ns4:PRODUCT_NAME>{ string($cuenta/ACCOUNTTITLE/text()) }</ns4:PRODUCT_NAME>
			<ns4:CURRENCY>{ string($cuenta/CURRENCY/text()) }</ns4:CURRENCY>
			<ns4:RESERVE_BALANCE>{ string($cuenta/CLEARINGBAL/text()) }</ns4:RESERVE_BALANCE>
			<ns4:LOCKED_BALANCE>{ string($cuenta/LOCKEDBALANCE/text()) }</ns4:LOCKED_BALANCE>
			<ns4:VISA_FLOATING_BALANCE>{ string($cuenta/LOCKEDVISABAL/text()) }</ns4:VISA_FLOATING_BALANCE>
			<ns4:CASH_ADVANCE_LIMIT>{ string($cuenta/AUTHLIMITCASHADV/text()) }</ns4:CASH_ADVANCE_LIMIT>
            <ns4:CASH_ADVANCE_AVAILABLE>{ fn-bea:format-number(number($cuenta/AUTHLIMITCASHADV/text()) - number($cuenta/UTILCASHADVVAL/text()),"###.00") }</ns4:CASH_ADVANCE_AVAILABLE>
		    <ns4:TOTAL_BALANCE>{ string($cuenta/TOTALAVAILBAL/text()) }</ns4:TOTAL_BALANCE>
			<ns4:AVAILABLE_BALANCE>{ string($cuenta/AVAILBALANCE/text()) }</ns4:AVAILABLE_BALANCE>
		    <ns4:TYPE>{ string($request.inputParameters/ns4:TYPE/text()) }</ns4:TYPE>
			<ns4:SOURCE_BANK>HN01</ns4:SOURCE_BANK>
			<ns4:SUCCESS_INDICATOR>SUCCESS</ns4:SUCCESS_INDICATOR>
		</ns4:ASSET>
	)else(
		<ns4:ASSET>
			<ns4:ID>{ data($ID) }</ns4:ID>
			<ns4:TYPE>{ string($request.inputParameters/ns4:TYPE/text()) }</ns4:TYPE>
			<ns4:SOURCE_BANK>HN01</ns4:SOURCE_BANK>
			<ns4:SUCCESS_INDICATOR>NO RECORDS</ns4:SUCCESS_INDICATOR>
			<ns4:ERROR_MESSAGE>PRODUCTO NO ENCONTRADO</ns4:ERROR_MESSAGE>
		</ns4:ASSET>
	)
)else(
	for $ID in $request.inputParameters/ns4:PRODUCTS/ns4:ID
	return
	<ns4:ASSET>
		<ns4:ID>{ data($ID) }</ns4:ID>
		<ns4:TYPE>{string($request.inputParameters/ns4:TYPE/text())}</ns4:TYPE>
		<ns4:SOURCE_BANK>HN01</ns4:SOURCE_BANK>
		<ns4:SUCCESS_INDICATOR>ERROR</ns4:SUCCESS_INDICATOR>
		<ns4:ERROR_MESSAGE>{ string-join($RSPConsultaMultipleProducto.parameters/Status/messages/text(),". ") }</ns4:ERROR_MESSAGE>
	</ns4:ASSET>
)]]></expr:xqueryText></trf:expr></trf:insert>
</bpel:extensionAssignOperation></bpel:assign></bpel:sequence>
        </bpel:scope>
        
        
        
        
        
        <bpel:reply partnerLink="sjConsultaMultipleProductosHN" operation="consultaProductos" variable="response"/>
    </bpel:sequence>
</bpel:process>