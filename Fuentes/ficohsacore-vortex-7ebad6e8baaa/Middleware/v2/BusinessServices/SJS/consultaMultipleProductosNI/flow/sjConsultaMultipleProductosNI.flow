<bpel:process name="sjConsultaMultipleProductosNI" targetNamespace="http://www.example.com/flow/Middleware/v2/BusinessServices/SJS/consultaMultipleProductosNI/flow/sjConsultaMultipleProductosNI" bea:name="sjConsultaMultipleProductosNI" xmlns:tns="http://www.example.com/flow/Middleware/v2/BusinessServices/SJS/consultaMultipleProductosNI/flow/sjConsultaMultipleProductosNI" xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable" xmlns:rescon="http://www.bea.com/alsb/flow/resources/config" xmlns:bea="http://www.bea.com/bpel/ui/extensions" xmlns:ext="http://www.bea.com/bpel/extensions" xmlns:expr="http://www.bea.com/wli/sb/stages/config" xmlns:trf="http://www.bea.com/wli/sb/stages/transform/config" xmlns:bind="http://www.ficohsa.com.hn/middleware.services/sjConsultaMultipleProductosNI" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:ns1="http://impl.service.srvaplcobiscertificadodeposito.ecobis.cobiscorp/" xmlns:ns0="http://impl.service.srvaplcobisprestamo.ecobis.cobiscorp/" xmlns:ns2="http://impl.service.srvaplcobiscuenta.ecobis.cobiscorp/" xmlns:ns3="http://www.ficohsa.com.hn/middleware.services/consultaTasaCambioPS/" xmlns:ctc="http://www.ficohsa.com.hn/middleware.services/consultaTasaCambioTypes" xmlns:ns4="http://impl.service.srvaplcobistarjetacredito.ecobis.cobiscorp/" xmlns:ns5="http://www.ficohsa.com.hn/middleware.services/consultaSaldosTarjetaCreditoPS/" xmlns:aut="http://www.ficohsa.com.hn/middleware.services/autType">
    <bpel:partnerLinks>
        <bpel:partnerLink name="sjConsultaMultipleProductosNI" partnerLinkType="tns:sjConsultaMultipleProductosNI" myRole="sjConsultaMultipleProductosNI">
	       </bpel:partnerLink>
	   <bpel:partnerLink name="deposito" partnerLinkType="tns:deposito_plnkType" partnerRole="deposito_PartnerRole">
	   </bpel:partnerLink>
	   <bpel:partnerLink name="prestamo" partnerLinkType="tns:prestamo_plnkType" partnerRole="prestamo_PartnerRole">
	   </bpel:partnerLink>
	   <bpel:partnerLink name="cuenta" partnerLinkType="tns:cuenta_plnkType" partnerRole="cuenta_PartnerRole">
	   </bpel:partnerLink>
	   <bpel:partnerLink name="ConsultaTasaCambio" partnerLinkType="tns:ConsultaTasaCambio_plnkType" partnerRole="ConsultaTasaCambio_PartnerRole">
	   </bpel:partnerLink>
	   <bpel:partnerLink name="ConsultaSaldosTarjetaCredito" partnerLinkType="tns:ConsultaSaldosTarjetaCredito_plnkType" partnerRole="ConsultaSaldosTarjetaCredito_PartnerRole">
	   </bpel:partnerLink></bpel:partnerLinks>

	   <bpel:variables>
        <bpel:variable name="request" messageType="bind:sjConsultaMultipleProductosNIRequest">
	       </bpel:variable>
	       <bpel:variable name="response" messageType="bind:sjConsultaMultipleProductosNIResponse">
	       </bpel:variable>
    <bpel:variable name="productoxTipo" type="xsd:anyType"/>
    <bpel:variable name="totalTipos" type="xsd:int"/></bpel:variables>

    <bpel:sequence>
        <bpel:receive partnerLink="sjConsultaMultipleProductosNI" operation="consultaProductosNI" variable="request" createInstance="yes">
	           <rescon:receiveInfo>
                
            <rescon:wsdl ref="Middleware/v2/BusinessServices/SJS/consultaMultipleProductosNI/wsdl/sjConsultaMultipleProductosNI" binding="bind:sjConsultaMultipleProductosNIPSSOAP"/></rescon:receiveInfo>
        </bpel:receive>
        <bpel:assign>
        	<bpel:extensionAssignOperation>
        		<trf:assign varName="response.outputParameters">
        			<trf:expr>
        				<expr:xqueryText>&lt;outputParameters>
	&lt;bind:ASSETS/>
	&lt;bind:LIABILITIES/>
&lt;/outputParameters></expr:xqueryText></trf:expr></trf:assign>
        	</bpel:extensionAssignOperation>
        <bpel:extensionAssignOperation>
		<trf:assign varName="productoxTipo">
			<trf:expr>
				<expr:xqueryTransform>
					<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaMultipleProductosNI/xq/agruparTipos"/>
					<expr:param name="sjConsultaMultipleProductosNI">
						<expr:path>$request.inputParameters</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign>
        </bpel:extensionAssignOperation>
        <bpel:extensionAssignOperation>
        	<trf:assign varName="totalTipos">
        		<trf:expr>
        			<expr:xqueryText>count($productoxTipo/TYPE)</expr:xqueryText></trf:expr></trf:assign>
        </bpel:extensionAssignOperation></bpel:assign>
        <bpel:forEach parallel="yes" counterName="typePosition">
        	<bpel:startCounterValue>1</bpel:startCounterValue>
        	<bpel:finalCounterValue>$totalTipos</bpel:finalCounterValue>
        	<bpel:scope>
        		<bpel:variables>
        			<bpel:variable name="type" type="xsd:string"/>
        			<bpel:variable name="totalIDs" type="xsd:int"/><bpel:variable name="REQConsultaTasaCambio" messageType="ns3:consultaTasaCambioRequest">
</bpel:variable>
        			<bpel:variable name="RSPConsultaTasaCambio" messageType="ns3:consultaTasaCambioResponse">
        			</bpel:variable>
        			<bpel:variable name="tasaCambio" type="xsd:string">
        			</bpel:variable>
        			<bpel:variable name="successIndicator" type="xsd:string">
        			</bpel:variable></bpel:variables>
        		<bpel:sequence>
        			<bpel:assign>
        				<bpel:extensionAssignOperation>
        					<trf:assign varName="type">
        						<trf:expr>
        							<expr:xqueryText>string($productoxTipo/TYPE[xs:int($typePosition)]/NAME_TYPE/text())</expr:xqueryText></trf:expr></trf:assign>
        				</bpel:extensionAssignOperation>
        			<bpel:extensionAssignOperation>
		<trf:assign varName="totalIDs">
			<trf:expr>
				<expr:xqueryText>count($productoxTipo/TYPE[xs:int($typePosition)]/PRODUCTS/ID)</expr:xqueryText></trf:expr></trf:assign>
        			</bpel:extensionAssignOperation></bpel:assign>
        			<bpel:if>
        				<bpel:condition>$type = 'AHO'
or
$type = 'CHQ'</bpel:condition>
        				<bpel:sequence>
        					<bpel:empty/>
        				<bpel:forEach parallel="yes" counterName="idPosition">
		<bpel:startCounterValue>1</bpel:startCounterValue>
		<bpel:finalCounterValue>$totalIDs</bpel:finalCounterValue>
		<bpel:scope>
			<bpel:variables>
				<bpel:variable name="productID" type="xsd:string"/>
				<bpel:variable name="REQConsultaMaestraSaldosCuenta" messageType="ns2:MsjOpConsultaMaestraSaldosSolicitud">
				</bpel:variable>
				<bpel:variable name="RSPConsultaMaestraSaldosCuenta" messageType="ns2:MsjOpConsultaMaestraSaldosRespuesta">
				</bpel:variable></bpel:variables>
			<bpel:faultHandlers>
				<bpel:catchAll>
					<bpel:sequence>
						<bpel:empty/>
					<bpel:assign>
		<bpel:extensionAssignOperation>
			<bpel:documentation/>
			<trf:insert varName="response.outputParameters">
				<trf:location>
					<expr:xpathText>./bind:ASSETS</expr:xpathText></trf:location>
				<trf:where>last-child</trf:where>
				<trf:expr>
					<expr:xqueryText><![CDATA[<bind:ASSET>
	<bind:ID>{ $productID }</bind:ID>
	<bind:TYPE>{$type}</bind:TYPE>
	<bind:SOURCE_BANK>NI01</bind:SOURCE_BANK>
	<bind:SUCCESS_INDICATOR>ERROR</bind:SUCCESS_INDICATOR>
	<bind:ERROR_MESSAGE>ERROR CONSULTANDO EL PRODUCTO</bind:ERROR_MESSAGE>
</bind:ASSET>]]></expr:xqueryText></trf:expr></trf:insert>
		</bpel:extensionAssignOperation>
					</bpel:assign></bpel:sequence>
				</bpel:catchAll></bpel:faultHandlers>
			<bpel:sequence>
				<bpel:assign>
					<bpel:extensionAssignOperation>
						<bpel:documentation/>
						<trf:assign varName="productID">
							<trf:expr>
								<expr:xqueryText>fn:string($productoxTipo/TYPE[xs:int($typePosition)]/PRODUCTS/ID[xs:int($idPosition)])</expr:xqueryText></trf:expr></trf:assign>
					</bpel:extensionAssignOperation>
				<bpel:extensionAssignOperation>
		<trf:assign varName="REQConsultaMaestraSaldosCuenta.parameters">
			<trf:expr>
				<expr:xqueryTransform>
					<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaMultipleProductosNI/xq/consultaMaestraSaldoCuentaIn"/>
					<expr:param name="productID">
						<expr:path>$productID</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign>
				</bpel:extensionAssignOperation></bpel:assign>
				<bpel:invoke operation="OpConsultaMaestraSaldos" partnerLink="cuenta" inputVariable="REQConsultaMaestraSaldosCuenta" outputVariable="RSPConsultaMaestraSaldosCuenta">
					<rescon:invokeInfo><rescon:service ref="Middleware/v2/BusinessServices/CTS/cuenta/biz/cuenta" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></rescon:invokeInfo></bpel:invoke>
				<bpel:assign>
					<bpel:extensionAssignOperation>
						<bpel:documentation/>
						<trf:insert varName="response.outputParameters">
							<trf:location>
								<expr:xpathText>./bind:ASSETS</expr:xpathText></trf:location>
							<trf:where>last-child</trf:where>
							<trf:expr>
								<expr:xqueryTransform>
									<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaMultipleProductosNI/xq/consultaMaestraSaldoCuentaOut"/>
									
									
									
									
									<expr:param name="productID">
										<expr:path>$productID</expr:path></expr:param>
									<expr:param name="producType">
										<expr:path>$type</expr:path></expr:param>
									<expr:param name="opConsultaMaestraSaldosRespuesta">
										<expr:path>$RSPConsultaMaestraSaldosCuenta.parameters</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:insert>
					</bpel:extensionAssignOperation>
					
				</bpel:assign></bpel:sequence>
		</bpel:scope>
        				</bpel:forEach></bpel:sequence>
        				<bpel:elseif>
        					<bpel:condition>$type = 'TRC'
or
$type = 'PTC'</bpel:condition>
        					<bpel:sequence>
        						<bpel:empty/>
        					<bpel:scope>
		<bpel:faultHandlers>
			<bpel:catch faultName="tns:tasaDeCambioFault">
				<bpel:sequence>
					<bpel:empty/>
				<bpel:assign>
		<bpel:extensionAssignOperation>
			<bpel:documentation/>
			<trf:insert varName="response.outputParameters">
				<trf:location>
					<expr:xpathText>./bind:LIABILITIES</expr:xpathText></trf:location>
				<trf:where>last-child</trf:where>
				<trf:expr>
					<expr:xqueryText><![CDATA[for $productID in $productoxTipo/TYPE[xs:int($typePosition)]/PRODUCTS/ID
return(
	<bind:LIABILITY>
		<bind:ID>{ data($productID) }</bind:ID>
		<bind:TYPE>{$type}</bind:TYPE>
		<bind:SOURCE_BANK>NI01</bind:SOURCE_BANK>
		<bind:SUCCESS_INDICATOR>ERROR</bind:SUCCESS_INDICATOR>
		<bind:ERROR_MESSAGE>ERROR CONSULTANDO LA TASA DE CAMBIO</bind:ERROR_MESSAGE>
	</bind:LIABILITY>
)]]></expr:xqueryText></trf:expr></trf:insert></bpel:extensionAssignOperation></bpel:assign></bpel:sequence>
			</bpel:catch>
			<bpel:catchAll>
				<bpel:sequence>
					<bpel:empty/>
				<bpel:assign>
		<bpel:extensionAssignOperation>
			<bpel:documentation/>
			<trf:insert varName="response.outputParameters">
				<trf:location>
					<expr:xpathText>./bind:LIABILITIES</expr:xpathText></trf:location>
				<trf:where>last-child</trf:where>
				<trf:expr>
					<expr:xqueryText><![CDATA[for $productID in $productoxTipo/TYPE[xs:int($typePosition)]/PRODUCTS/ID
return(
	<bind:LIABILITY>
		<bind:ID>{ data($productID) }</bind:ID>
		<bind:TYPE>{$type}</bind:TYPE>
		<bind:SOURCE_BANK>NI01</bind:SOURCE_BANK>
		<bind:SUCCESS_INDICATOR>ERROR</bind:SUCCESS_INDICATOR>
		<bind:ERROR_MESSAGE>ERROR CONSULTANDO LA TASA DE CAMBIO</bind:ERROR_MESSAGE>
	</bind:LIABILITY>
)]]></expr:xqueryText></trf:expr></trf:insert></bpel:extensionAssignOperation></bpel:assign></bpel:sequence>
			</bpel:catchAll></bpel:faultHandlers>
	<bpel:sequence>
			<bpel:assign>
				<bpel:extensionAssignOperation>
					<trf:assign varName="REQConsultaTasaCambio.RequestHeader">
						<trf:expr>
							<expr:xqueryTransform>
								<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaMultipleProductosNI/xq/consultaTasaCambioHeaderIn"/>
								<expr:param name="sjConsultaMultipleProductosNI">
									<expr:path>$request.inputParameters</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign></bpel:extensionAssignOperation>
				<bpel:extensionAssignOperation>
					<trf:assign varName="REQConsultaTasaCambio.parameters">
						<trf:expr>
							<expr:xqueryText><![CDATA[<ctc:consultaTasaCambio>
    <SOURCE_CURRENCY>NIO</SOURCE_CURRENCY>
    <TARGET_CURRENCY>USD</TARGET_CURRENCY>
</ctc:consultaTasaCambio>]]></expr:xqueryText></trf:expr></trf:assign></bpel:extensionAssignOperation></bpel:assign>
			<bpel:invoke operation="consultaTasaCambio" partnerLink="ConsultaTasaCambio" inputVariable="REQConsultaTasaCambio" outputVariable="RSPConsultaTasaCambio">
				<rescon:invokeInfo><rescon:service ref="Middleware/v2/ProxyServices/ConsultaTasaCambio" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></rescon:invokeInfo></bpel:invoke>
			<bpel:assign>
				<bpel:extensionAssignOperation>
					<trf:assign varName="successIndicator">
						<trf:expr>
							<expr:xqueryText>upper-case(string($RSPConsultaTasaCambio.ResponseHeader/successIndicator/text()))</expr:xqueryText></trf:expr></trf:assign></bpel:extensionAssignOperation></bpel:assign>
			<bpel:if>
				<bpel:condition>$successIndicator = 'SUCCESS'</bpel:condition>
				<bpel:sequence>
					<bpel:empty/>
					<bpel:assign>
						<bpel:extensionAssignOperation>
							<trf:assign varName="tasaCambio">
								<trf:expr>
									<expr:xqueryText>data($RSPConsultaTasaCambio.result/ctc:consultaTasaCambioResponseType/ctc:consultaTasaCambioResponseRecordType[1]/BUY_RATE)</expr:xqueryText></trf:expr></trf:assign></bpel:extensionAssignOperation></bpel:assign>
					<bpel:forEach parallel="yes" counterName="idPosition">
						<bpel:startCounterValue>1</bpel:startCounterValue>
						<bpel:finalCounterValue>$totalIDs</bpel:finalCounterValue>
						<bpel:scope>
							<bpel:variables>
								<bpel:variable type="xsd:string" name="productID"/>
								
								
								<bpel:variable name="productType" type="xsd:string">
								</bpel:variable>
								<bpel:variable name="REQconsultaSaldosTarjetaCreditoRequest" messageType="ns5:consultaSaldosTarjetaCreditoRequest">
								</bpel:variable>
								<bpel:variable name="RSPconsultaSaldosTarjetaCreditoResponse" messageType="ns5:consultaSaldosTarjetaCreditoResponse">
								</bpel:variable></bpel:variables>
							<bpel:faultHandlers>
								<bpel:catchAll>
									<bpel:sequence>
										<bpel:empty/>
										
										<bpel:assign>
											<bpel:extensionAssignOperation>
												<bpel:documentation/>
												<trf:insert varName="response.outputParameters">
													<trf:location>
														<expr:xpathText>./bind:LIABILITIES</expr:xpathText></trf:location>
													<trf:where>last-child</trf:where>
													<trf:expr>
														<expr:xqueryText><![CDATA[<bind:LIABILITY>
	<bind:ID>{ $productID }</bind:ID>
	<bind:TYPE>{$type}</bind:TYPE>
	<bind:SOURCE_BANK>NI01</bind:SOURCE_BANK>
	<bind:SUCCESS_INDICATOR>ERROR</bind:SUCCESS_INDICATOR>
	<bind:ERROR_MESSAGE>ERROR CONSULTANDO EL PRODUCTO</bind:ERROR_MESSAGE>
</bind:LIABILITY>]]></expr:xqueryText></trf:expr></trf:insert></bpel:extensionAssignOperation></bpel:assign></bpel:sequence></bpel:catchAll></bpel:faultHandlers>
							<bpel:sequence>
								<bpel:assign>
									<bpel:extensionAssignOperation>
										<bpel:documentation/>
										<trf:assign varName="productID">
											<trf:expr>
												<expr:xqueryText>fn:string($productoxTipo/TYPE[xs:int($typePosition)]/PRODUCTS/ID[xs:int($idPosition)])</expr:xqueryText></trf:expr></trf:assign></bpel:extensionAssignOperation>
									
									<bpel:extensionAssignOperation>
										<trf:assign varName="REQconsultaSaldosTarjetaCreditoRequest.RequestHeader">
											<trf:expr>
												<expr:xqueryText><![CDATA[
      <aut:RequestHeader>
         <Authentication>
            <UserName>{fn:string($request.inputParameters/bind:USERNAME/text())}</UserName>
            <Password>{fn:string($request.inputParameters/bind:PASSWORD/text())}</Password>
         </Authentication>
         <Region>
            <SourceBank>NI01</SourceBank>
            <DestinationBank>NI01</DestinationBank>
         </Region>
        </aut:RequestHeader>
]]></expr:xqueryText></trf:expr></trf:assign>
									</bpel:extensionAssignOperation>
									<bpel:extensionAssignOperation>
										<trf:assign varName="REQconsultaSaldosTarjetaCreditoRequest.parameters">
											<trf:expr>
												<expr:xqueryTransform>
													<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaMultipleProductosNI/xq/consultaSaldosTCIn"/>
													<expr:param name="productID">
														<expr:path>$productID</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign></bpel:extensionAssignOperation></bpel:assign>
								<bpel:invoke operation="consultaSaldosTarjetaCredito" partnerLink="ConsultaSaldosTarjetaCredito" inputVariable="REQconsultaSaldosTarjetaCreditoRequest" outputVariable="RSPconsultaSaldosTarjetaCreditoResponse">
									<rescon:invokeInfo><rescon:service ref="Middleware/v2/ProxyServices/ConsultaSaldosTarjetaCredito" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></rescon:invokeInfo></bpel:invoke>
								<bpel:assign>
									<bpel:extensionAssignOperation>
										<bpel:documentation/>
										<trf:insert varName="response.outputParameters">
											<trf:location>
												<expr:xpathText>./bind:LIABILITIES</expr:xpathText></trf:location>
											<trf:where>last-child</trf:where>
											<trf:expr>
												<expr:xqueryTransform>
													<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaMultipleProductosNI/xq/consultaSaldosTCOut"/>
													
													
													
													
													
													
													
													
													
													
													
													
													
													
													
													
													
													
													
													
													
													
													
													
													<expr:param name="consultaSaldosTarjetaCreditoResponse">
														<expr:path>$RSPconsultaSaldosTarjetaCreditoResponse.result</expr:path></expr:param>
													<expr:param name="productID">
														<expr:path>$productID</expr:path></expr:param>
													<expr:param name="buyRate">
														<expr:path>$tasaCambio</expr:path></expr:param>
													<expr:param name="productType">
														<expr:path>$type</expr:path></expr:param>
													<expr:param name="responseHeader">
														<expr:path>$RSPconsultaSaldosTarjetaCreditoResponse.ResponseHeader</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:insert></bpel:extensionAssignOperation></bpel:assign></bpel:sequence></bpel:scope></bpel:forEach></bpel:sequence>
				<bpel:else>
					<bpel:sequence>
						<bpel:empty/>
						
						<bpel:throw faultName="tns:tasaDeCambioFault"/></bpel:sequence></bpel:else></bpel:if></bpel:sequence>
        					</bpel:scope>
	
	
	
	
	
	</bpel:sequence>
        				</bpel:elseif>
        				<bpel:elseif>
        					<bpel:condition>$type = 'DEP'</bpel:condition>
        					<bpel:sequence>
        						<bpel:empty/>
        					<bpel:forEach parallel="yes" counterName="idPosition">
		<bpel:startCounterValue>1</bpel:startCounterValue>
		<bpel:finalCounterValue>$totalIDs</bpel:finalCounterValue>
		<bpel:scope>
			<bpel:variables>
				<bpel:variable name="REQBuscarCertificadoDeposito" messageType="ns1:MsjOpBuscarCertificadoDPFSolicitud">
				</bpel:variable>
				<bpel:variable name="RSPBuscarCertificadoDeposito" messageType="ns1:MsjOpBuscarCertificadoDPFRespuesta">
				</bpel:variable>
				<bpel:variable name="productID" type="xsd:string"/></bpel:variables>
			<bpel:faultHandlers>
				<bpel:catchAll>
					<bpel:sequence>
						<bpel:empty/>
					<bpel:assign>
		<bpel:extensionAssignOperation>
			<trf:insert varName="response.outputParameters">
				<trf:location>
					<expr:xpathText>./bind:ASSETS</expr:xpathText></trf:location>
				<trf:where>last-child</trf:where>
			<trf:expr>
				<expr:xqueryText><![CDATA[<bind:ASSET>
	<bind:ID>{ $productID }</bind:ID>
	<bind:TYPE>{$type}</bind:TYPE>
	<bind:SOURCE_BANK>NI01</bind:SOURCE_BANK>
	<bind:SUCCESS_INDICATOR>ERROR</bind:SUCCESS_INDICATOR>
	<bind:ERROR_MESSAGE>ERROR CONSULTANDO EL PRODUCTO</bind:ERROR_MESSAGE>
</bind:ASSET>]]></expr:xqueryText></trf:expr></trf:insert>
		</bpel:extensionAssignOperation>
					</bpel:assign></bpel:sequence>
				</bpel:catchAll></bpel:faultHandlers>
			<bpel:sequence>
				<bpel:assign>
					
				<bpel:extensionAssignOperation>
		<trf:assign varName="productID">
			<trf:expr>
				<expr:xqueryText>fn:string($productoxTipo/TYPE[xs:int($typePosition)]/PRODUCTS/ID[xs:int($idPosition)])</expr:xqueryText></trf:expr></trf:assign>
				</bpel:extensionAssignOperation>
	<bpel:extensionAssignOperation>
		<trf:assign varName="REQBuscarCertificadoDeposito.parameters">
			<trf:expr>
				<expr:xqueryTransform>
					<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaMultipleProductosNI/xq/buscarCertificadoDepositoIn"/>
					<expr:param name="productID">
						<expr:path>$productID</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign>
				</bpel:extensionAssignOperation></bpel:assign>
				<bpel:invoke operation="OpBuscarCertificadoDPF" partnerLink="deposito" inputVariable="REQBuscarCertificadoDeposito" outputVariable="RSPBuscarCertificadoDeposito">
					<rescon:invokeInfo><rescon:service ref="Middleware/v2/BusinessServices/CTS/deposito/biz/deposito" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></rescon:invokeInfo></bpel:invoke>
				<bpel:assign>
					<bpel:extensionAssignOperation>
						<trf:insert varName="response.outputParameters">
							<trf:location>
								<expr:xpathText>./bind:ASSETS</expr:xpathText></trf:location>
							<trf:where>last-child</trf:where>
						<trf:expr>
							<expr:xqueryTransform>
								<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaMultipleProductosNI/xq/buscarCertificadoDepositoOut"/>
								
								
								<expr:param name="productID">
									<expr:path>$productID</expr:path></expr:param>
								<expr:param name="opBuscarCertificadoDPFRespuesta">
									<expr:path>$RSPBuscarCertificadoDeposito.parameters</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:insert>
					</bpel:extensionAssignOperation>
				</bpel:assign></bpel:sequence>
		</bpel:scope>
        					</bpel:forEach></bpel:sequence>
        				</bpel:elseif>
        				<bpel:elseif>
        					<bpel:condition>$type = 'PTM'</bpel:condition>
        					<bpel:sequence>
        						<bpel:empty/>
        					<bpel:forEach parallel="yes" counterName="idPosition">
		<bpel:startCounterValue>1</bpel:startCounterValue>
		<bpel:finalCounterValue>$totalIDs</bpel:finalCounterValue>
		<bpel:scope>
			<bpel:variables>
				<bpel:variable name="productID" type="xsd:string"/>
				<bpel:variable name="REQConsultaPrestamo" messageType="ns0:MsjOpConsultaPrestamoSolicitud">
				</bpel:variable>
				<bpel:variable name="RSPConsultaPrestamo" messageType="ns0:MsjOpConsultaPrestamoRespuesta">
				</bpel:variable></bpel:variables>
			<bpel:faultHandlers>
				<bpel:catchAll>
					<bpel:sequence>
						<bpel:empty/>
					<bpel:assign>
		<bpel:extensionAssignOperation>
			<trf:insert varName="response.outputParameters">
				<trf:location>
					<expr:xpathText>./bind:LIABILITIES</expr:xpathText></trf:location>
				<trf:where>last-child</trf:where>
			<trf:expr>
				<expr:xqueryText><![CDATA[<bind:LIABILITY>
	<bind:ID>{ $productID }</bind:ID>
	<bind:TYPE>{$type}</bind:TYPE>
	<bind:SOURCE_BANK>NI01</bind:SOURCE_BANK>
	<bind:SUCCESS_INDICATOR>ERROR</bind:SUCCESS_INDICATOR>
	<bind:ERROR_MESSAGE>ERROR CONSULTANDO EL PRODUCTO</bind:ERROR_MESSAGE>
</bind:LIABILITY>]]></expr:xqueryText></trf:expr></trf:insert>
		</bpel:extensionAssignOperation>
					</bpel:assign></bpel:sequence>
				</bpel:catchAll></bpel:faultHandlers>
			<bpel:sequence>
				<bpel:assign>
					<bpel:extensionAssignOperation>
						<trf:assign varName="productID">
							<trf:expr>
								<expr:xqueryText>fn:string($productoxTipo/TYPE[xs:int($typePosition)]/PRODUCTS/ID[xs:int($idPosition)])</expr:xqueryText></trf:expr></trf:assign>
					</bpel:extensionAssignOperation>
				<bpel:extensionAssignOperation>
		<trf:assign varName="REQConsultaPrestamo.parameters">
			<trf:expr>
				<expr:xqueryTransform>
					<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaMultipleProductosNI/xq/consultaPrestamoIn"/>
					<expr:param name="productID">
						<expr:path>$productID</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign>
				</bpel:extensionAssignOperation></bpel:assign>
				<bpel:invoke operation="OpConsultaPrestamo" partnerLink="prestamo" inputVariable="REQConsultaPrestamo" outputVariable="RSPConsultaPrestamo">
					<rescon:invokeInfo><rescon:service ref="Middleware/v2/BusinessServices/CTS/prestamo/biz/prestamo" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></rescon:invokeInfo></bpel:invoke>
				<bpel:assign>
					<bpel:extensionAssignOperation>
						<trf:insert varName="response.outputParameters">
							<trf:location>
								<expr:xpathText>./bind:LIABILITIES</expr:xpathText></trf:location>
							<trf:where>first-child</trf:where>
						<trf:expr>
							<expr:xqueryTransform>
								<expr:resource ref="Middleware/v2/BusinessServices/SJS/consultaMultipleProductosNI/xq/consultaPrestamoOut"/>
								<expr:param name="productID">
									<expr:path>$productID</expr:path></expr:param>
								<expr:param name="opConsultaPrestamoRespuesta">
									<expr:path>$RSPConsultaPrestamo.parameters</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:insert>
					</bpel:extensionAssignOperation>
				</bpel:assign></bpel:sequence>
		</bpel:scope>
        					</bpel:forEach></bpel:sequence>
        				</bpel:elseif>
        				<bpel:else>
        					<bpel:sequence>
        						<bpel:empty/>
        					<bpel:assign>
		<bpel:extensionAssignOperation>
			<bpel:documentation/>
			<trf:insert varName="response.outputParameters">
				<trf:location>
					<expr:xpathText>./bind:ASSETS</expr:xpathText></trf:location>
				<trf:where>last-child</trf:where>
				<trf:expr>
					<expr:xqueryText><![CDATA[for $productID in $productoxTipo/TYPE[xs:int($typePosition)]/PRODUCTS/ID
return(
	<bind:ASSET>
		<bind:ID>{ data($productID) }</bind:ID>
		<bind:TYPE>{$type}</bind:TYPE>
		<bind:SOURCE_BANK>NI01</bind:SOURCE_BANK>
		<bind:SUCCESS_INDICATOR>ERROR</bind:SUCCESS_INDICATOR>
		<bind:ERROR_MESSAGE>PRODUCTO NO IMPLEMENTADO</bind:ERROR_MESSAGE>
	</bind:ASSET>
)]]></expr:xqueryText></trf:expr></trf:insert>
		</bpel:extensionAssignOperation>
        					</bpel:assign>
	
	
	</bpel:sequence>
        				</bpel:else>
        			</bpel:if></bpel:sequence>
        	</bpel:scope>
        </bpel:forEach>
        <bpel:reply partnerLink="sjConsultaMultipleProductosNI" operation="consultaProductosNI" variable="response"/>
    </bpel:sequence>
</bpel:process>