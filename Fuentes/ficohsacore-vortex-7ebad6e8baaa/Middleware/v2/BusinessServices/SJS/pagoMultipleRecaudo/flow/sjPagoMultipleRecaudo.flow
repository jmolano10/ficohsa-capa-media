<bpel:process name="sjPagoMultipleRecaudo" targetNamespace="http://www.example.com/flow/Middleware/v2/BusinessServices/SJS/pagoMultipleRecaudo/flow/sjPagoMultipleRecaudo" bea:name="sjPagoMultipleRecaudo" xmlns:tns="http://www.example.com/flow/Middleware/v2/BusinessServices/SJS/pagoMultipleRecaudo/flow/sjPagoMultipleRecaudo" xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable" xmlns:rescon="http://www.bea.com/alsb/flow/resources/config" xmlns:bea="http://www.bea.com/bpel/ui/extensions" xmlns:ext="http://www.bea.com/bpel/extensions" xmlns:expr="http://www.bea.com/wli/sb/stages/config" xmlns:trf="http://www.bea.com/wli/sb/stages/transform/config" xmlns:bind="http://www.ficohsa.com.hn/middleware.services/sjPagoMultipleRecaudoPS" xmlns:ns1="http://xmlns.oracle.com/pcbpel/adapter/db/InterbancaSOAApplication/ObtenerParametrizacion/obtenerParametrizacion" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:ns0="http://www.ficohsa.com.hn/middleware.services/sjPagoMultipleRecaudo" xmlns:ns2="http://www.ficohsa.com.hn/middleware.services/envioMensajeSMS/" xmlns:ns3="http://www.ficohsa.com.hn/middleware.services/pagoRecaudo/" xmlns:ns4="http://www.ficohsa.com.hn/middleware.services/pagoRecaudoTypes" xmlns:osb="http://xmlns.oracle.com/pcbpel/adapter/db/ORA_BANK/OSB_GET_CONFIG/" xmlns:ns5="http://www.bea.com/wli/sb/stages/logging/config">
    <bpel:partnerLinks>
        <bpel:partnerLink name="sjPagoMultipleRecaudo" partnerLinkType="tns:sjPagoMultipleRecaudo" myRole="sjPagoMultipleRecaudo">
	       </bpel:partnerLink>
	   <bpel:partnerLink name="ObtenerParametrizacion" partnerLinkType="tns:ObtenerParametrizacion_plnkType" partnerRole="ObtenerParametrizacion_PartnerRole">
	   </bpel:partnerLink>
	   <bpel:partnerLink name="PagoRecaudo" partnerLinkType="tns:PagoRecaudo_plnkType" partnerRole="PagoRecaudo_PartnerRole">
	   </bpel:partnerLink></bpel:partnerLinks>

	   <bpel:variables>
        <bpel:variable name="request" messageType="bind:sjPagoMultipleRecaudoRequest">
	       </bpel:variable>
	       <bpel:variable name="response" messageType="bind:sjPagoMultipleRecaudoResponse">
	       </bpel:variable>
    <bpel:variable name="REQobtenerParametrizacion" messageType="ns1:args_in_msg">
    </bpel:variable>
    <bpel:variable name="RSPobtenerParametrizacion" messageType="ns1:args_out_msg">
    </bpel:variable>
    
    
    
    <bpel:variable name="maxParallel" type="xsd:integer"/>
    <bpel:variable name="batches" type="xsd:anyType"/>
    <bpel:variable name="Agreements" type="xsd:anyType"/>
    <bpel:variable name="ReqMaxBillsAllowed" type="xsd:string"/>
    <bpel:variable name="ReqMaxParallel" type="xsd:string"/>
    <bpel:variable name="numberOfAgreements" type="xsd:int"/>
    <bpel:variable name="maxBills" type="xsd:int"/>
    
    <bpel:variable name="sourceBank" type="xsd:string"/><bpel:variable name="ReqSequentialAgreements" type="xsd:string">
</bpel:variable>
	   	<bpel:variable name="sequentialAgreements" type="xsd:string">
	   	</bpel:variable>
	   	<bpel:variable name="parallelAgreementsGroup" type="xsd:anyType">
	   	</bpel:variable>
	   	<bpel:variable name="sequentialAgreementsGroup" type="xsd:anyType">
	   	</bpel:variable></bpel:variables>

    
	
	
	<bpel:sequence>
        <bpel:receive partnerLink="sjPagoMultipleRecaudo" operation="PagoMultipleRecaudo" variable="request" createInstance="yes">
	           <rescon:receiveInfo>
                
            <rescon:wsdl ref="Middleware/v2/BusinessServices/SJS/pagoMultipleRecaudo/wsdl/sjPagoMultipleRecaudo" binding="bind:sjPagoMultipleRecaudoPSSOAP"/></rescon:receiveInfo>
        </bpel:receive>
        <bpel:scope>
        	<bpel:sequence>
        		<bpel:assign>
        			
        		<bpel:extensionAssignOperation bea:name="Preparar Salida">
		<trf:assign varName="response.outputParameters">
			<trf:expr>
				<expr:xqueryText><![CDATA[<outputParameters>
	<SUCCESS_INDICATOR>Success</SUCCESS_INDICATOR>
	<ERROR_MESSAGE />
	<AGREEMENTS />
</outputParameters>]]></expr:xqueryText></trf:expr></trf:assign>
        		</bpel:extensionAssignOperation>
        		<bpel:extensionAssignOperation bea:name="Prepara nodos">
        			<trf:assign varName="Agreements">
        				<trf:expr>
        					<expr:xqueryTransform>
        						<expr:resource ref="Middleware/v2/BusinessServices/SJS/pagoMultipleRecaudo/xq/groupAgreementsByBill"/>
        						<expr:param name="sjPagoMultipleRecaudo">
        							<expr:path>$request.inputParameters</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign>
        		</bpel:extensionAssignOperation>
        		<bpel:extensionAssignOperation bea:name="Source Bank">
        			<trf:assign varName="sourceBank">
        				<trf:expr>
        					<expr:xqueryText>let $sourceBank := string($request.inputParameters/SOURCE_BANK/text())
return
	if($sourceBank != "")then(
		$sourceBank
	)else(
		'HN01'
	)</expr:xqueryText></trf:expr></trf:assign>
        		</bpel:extensionAssignOperation></bpel:assign></bpel:sequence>
        </bpel:scope>
        <bpel:flow>
        	
        	<bpel:scope bea:name="Consulta parametrización">
        		<bpel:documentation>Consulta de máxima cantidad de envíos concurrentes</bpel:documentation>
        		<bpel:faultHandlers>
        			<bpel:catchAll>
        				<bpel:sequence>
        					<bpel:empty/>
        				<bpel:assign>
		<bpel:extensionAssignOperation>
			<bpel:documentation/>
			<trf:assign varName="RSPobtenerParametrizacion.OutputParameters">
				<trf:expr>
					<expr:xqueryText>&lt;osb:OutputParameters>
   &lt;osb:CONFIGURACIONES/>
   &lt;osb:ERROR_CODE/>
   &lt;osb:ERROR_MESSAGE/>
&lt;/osb:OutputParameters></expr:xqueryText></trf:expr></trf:assign></bpel:extensionAssignOperation>
		</bpel:assign></bpel:sequence>
        			</bpel:catchAll></bpel:faultHandlers>
        		<bpel:sequence>
        			<bpel:assign bea:name="Preparar petición parametrización">
        				<bpel:extensionAssignOperation>
        					<trf:assign varName="ReqMaxParallel">
        						<trf:expr>
        							<expr:xqueryText>concat("FICBCO0247.MAXPARALLEL.",$sourceBank)</expr:xqueryText></trf:expr></trf:assign></bpel:extensionAssignOperation>
        				<bpel:extensionAssignOperation>
        					<trf:assign varName="ReqMaxBillsAllowed">
        						<trf:expr>
        							<expr:xqueryText>concat("FICBCO0247.MAXPAYMENTSALLOWED.", $sourceBank)</expr:xqueryText></trf:expr></trf:assign></bpel:extensionAssignOperation>
        				<bpel:extensionAssignOperation>
        					<trf:assign varName="ReqSequentialAgreements">
        						<trf:expr>
        							<expr:xqueryText>concat("FICBCO0247.SEQUENTIALAGREEMENTS.", $sourceBank)</expr:xqueryText></trf:expr></trf:assign>
        				</bpel:extensionAssignOperation>
        				<bpel:extensionAssignOperation>
        					<trf:assign varName="REQobtenerParametrizacion.InputParameters">
        						<trf:expr>
        							<expr:xqueryTransform>
        								<expr:resource ref="Middleware/Business_Resources/general/Parametrizacion/obtenerParametrizacionIn"/>
        								<expr:param name="nombreParametros">
        									<expr:path>concat($ReqMaxParallel, '||',
	$ReqMaxBillsAllowed, '||',
	$ReqSequentialAgreements)</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign></bpel:extensionAssignOperation></bpel:assign>
        			<bpel:invoke partnerLink="ObtenerParametrizacion" operation="obtenerParametrizacion" outputVariable="RSPobtenerParametrizacion" inputVariable="REQobtenerParametrizacion">
        				<rescon:invokeInfo><rescon:service ref="Middleware/Business_Resources/general/Resources/ObtenerParametrizacion/ObtenerParametrizacion" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></rescon:invokeInfo></bpel:invoke>
        			</bpel:sequence>
        	</bpel:scope>
        </bpel:flow>
        
        
        
        
        
        
        <bpel:assign>
        	<bpel:extensionAssignOperation>
        		<bpel:documentation/>
        		<trf:assign varName="maxBills">
        			<trf:expr>
        				<expr:xqueryText>let $maxBills := $RSPobtenerParametrizacion.OutputParameters/osb:CONFIGURACIONES/osb:CONFIGURACIONES_ITEM[osb:NAME = $ReqMaxBillsAllowed ]/osb:VALUE/text()
return
if(fn:string(fn:number($maxBills)) = "NaN") then (
		10
	) else (
		xs:integer($maxBills)
	)</expr:xqueryText></trf:expr></trf:assign></bpel:extensionAssignOperation>
        	<bpel:extensionAssignOperation>
        		<trf:assign varName="sequentialAgreements">
        			<trf:expr>
        				<expr:xqueryText>$RSPobtenerParametrizacion.OutputParameters/osb:CONFIGURACIONES/osb:CONFIGURACIONES_ITEM[osb:NAME = $ReqSequentialAgreements ]/osb:VALUE/text()
</expr:xqueryText></trf:expr></trf:assign>
        	</bpel:extensionAssignOperation>
        	<bpel:extensionAssignOperation>
        		<trf:assign varName="numberOfAgreements">
        			<trf:expr>
        				<expr:xqueryText>count($Agreements/AGREEMENT)</expr:xqueryText></trf:expr></trf:assign></bpel:extensionAssignOperation>
        	<bpel:extensionAssignOperation>
        		<bpel:documentation/>
        		<trf:assign varName="sequentialAgreementsGroup">
        			<trf:expr>
        				<expr:xqueryText>&lt;DATA>
	&lt;AGREEMENTS/>
&lt;/DATA></expr:xqueryText></trf:expr></trf:assign>
        	</bpel:extensionAssignOperation>
        	<bpel:extensionAssignOperation>
        		<bpel:documentation/>
        		<trf:assign varName="parallelAgreementsGroup">
        			<trf:expr>
        				<expr:xqueryText>&lt;DATA>
	&lt;AGREEMENTS/>
&lt;/DATA></expr:xqueryText></trf:expr></trf:assign>
        	</bpel:extensionAssignOperation></bpel:assign>
        <bpel:forEach parallel="no" counterName="agreementIndex">
        	<bpel:startCounterValue>number(1)</bpel:startCounterValue>
        	<bpel:finalCounterValue>$numberOfAgreements</bpel:finalCounterValue>
        	<bpel:scope>
        		<bpel:variables>
        			<bpel:variable name="agreement" type="xsd:anyType">
        			</bpel:variable>
        			<bpel:variable name="agreementID" type="xsd:string">
        			</bpel:variable></bpel:variables>
        		<bpel:sequence>
        			<bpel:assign>
        				<bpel:copy>
        					<bpel:from>$Agreements/AGREEMENT[position() = $agreementIndex]</bpel:from>
        					<bpel:to variable="agreement"/>
        				</bpel:copy>
        			<bpel:extensionAssignOperation>
		<trf:assign varName="agreementID">
			<trf:expr>
				<expr:xqueryText>fn:string($agreement/CONTRACT_ID/text())</expr:xqueryText></trf:expr></trf:assign>
        			</bpel:extensionAssignOperation></bpel:assign>
        			<bpel:if>
        				<bpel:condition>contains($sequentialAgreements, $agreementID)</bpel:condition>
        				<bpel:sequence>
        					<bpel:empty/>
        				<bpel:assign>
		
        				<bpel:extensionAssignOperation>
		<trf:insert varName="sequentialAgreementsGroup">
			<trf:location>
				<expr:xpathText>./AGREEMENTS</expr:xpathText></trf:location>
			<trf:where>last-child</trf:where>
		<trf:expr>
			<expr:xqueryText>&lt;AGREEMENT>
	{
		$agreement/*
	}
&lt;/AGREEMENT></expr:xqueryText></trf:expr></trf:insert>
        				</bpel:extensionAssignOperation></bpel:assign></bpel:sequence>
        				<bpel:else>
        					<bpel:sequence>
        						<bpel:empty/>
        					<bpel:assign>
		
        					<bpel:extensionAssignOperation>
		<trf:insert varName="parallelAgreementsGroup">
			<trf:location>
				<expr:xpathText>./AGREEMENTS</expr:xpathText></trf:location>
			<trf:where>last-child</trf:where>
		<trf:expr>
			<expr:xqueryText>&lt;AGREEMENT>
	{
		$agreement/*
	}
&lt;/AGREEMENT></expr:xqueryText></trf:expr></trf:insert>
        					</bpel:extensionAssignOperation></bpel:assign></bpel:sequence>
        				</bpel:else>
        			</bpel:if></bpel:sequence>
        	</bpel:scope>
        </bpel:forEach>
        <bpel:flow>
        	
        	<bpel:scope bea:name="SequentialAgreementsGroupProcessing">
        		<bpel:sequence>
        			<bpel:if>
        				<bpel:condition>count($sequentialAgreementsGroup/AGREEMENTS/AGREEMENT) > 0
</bpel:condition>
        				<bpel:sequence>
        					<bpel:empty/>
        				<bpel:forEach parallel="no" counterName="agreementIndex">
		<bpel:startCounterValue>number(1)</bpel:startCounterValue>
		<bpel:finalCounterValue>count($sequentialAgreementsGroup/AGREEMENTS/AGREEMENT)</bpel:finalCounterValue>
		<bpel:scope>
			<bpel:variables>
				<bpel:variable name="sequentialAgreement" type="xsd:anyType"/>
				<bpel:variable name="REQPagoRecaudo" messageType="ns3:pagoRecaudoRequest"/>
				<bpel:variable name="RSPPagoRecaudo" messageType="ns3:pagoRecaudoResponse"/></bpel:variables>
			<bpel:faultHandlers>
				<bpel:catchAll>
					<bpel:sequence>
						<bpel:empty/>
						<bpel:assign>
							<bpel:extensionAssignOperation bea:name="Add to Response">
								<trf:insert varName="response.outputParameters">
									<trf:location>
										<expr:xpathText>./AGREEMENTS</expr:xpathText></trf:location>
									<trf:where>last-child</trf:where>
									<trf:expr>
										<expr:xqueryText>&lt;AGREEMENT>
	&lt;SUCCESS_INDICATOR>ERROR&lt;/SUCCESS_INDICATOR>
&lt;/AGREEMENT></expr:xqueryText></trf:expr></trf:insert></bpel:extensionAssignOperation></bpel:assign></bpel:sequence></bpel:catchAll></bpel:faultHandlers>
			<bpel:sequence>
				<bpel:assign>
					<bpel:copy>
						<bpel:from>$sequentialAgreementsGroup/AGREEMENTS/AGREEMENT[position() = $agreementIndex]</bpel:from>
						<bpel:to variable="sequentialAgreement"/></bpel:copy>
					<bpel:extensionAssignOperation bea:name="Prepare Request Header">
						<trf:assign varName="REQPagoRecaudo.RequestHeader">
							<trf:expr>
								<expr:xqueryTransform>
									<expr:resource ref="Middleware/v2/BusinessServices/SJS/pagoMultipleRecaudo/xq/pagoRecaudoHeaderIn"/>
									<expr:param name="sjPagoMultipleRecaudo">
										<expr:path>$request.inputParameters</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign></bpel:extensionAssignOperation>
					<bpel:extensionAssignOperation bea:name="Prepare Request Body">
						<trf:assign varName="REQPagoRecaudo.parameters">
							<trf:expr>
								<expr:xqueryTransform>
									<expr:resource ref="Middleware/v2/BusinessServices/SJS/pagoMultipleRecaudo/xq/pagoRecaudoIn"/>
									<expr:param name="agreement">
										<expr:path>$sequentialAgreement</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign></bpel:extensionAssignOperation></bpel:assign>
				<bpel:invoke outputVariable="RSPPagoRecaudo" inputVariable="REQPagoRecaudo" operation="pagoRecaudo" partnerLink="PagoRecaudo">
					<rescon:invokeInfo><rescon:service ref="Middleware/v2/ProxyServices/PagoRecaudo" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></rescon:invokeInfo></bpel:invoke>
				<bpel:assign>
					<bpel:extensionAssignOperation bea:name="Add to Response">
						<trf:insert varName="response.outputParameters">
							<trf:location>
								<expr:xpathText>./AGREEMENTS</expr:xpathText></trf:location>
							<trf:where>last-child</trf:where>
							<trf:expr>
								<expr:xqueryTransform>
									<expr:resource ref="Middleware/v2/BusinessServices/SJS/pagoMultipleRecaudo/xq/pagoRecaudoOut"/>
									<expr:param name="agreement">
										<expr:path>$sequentialAgreement</expr:path></expr:param>
									<expr:param name="responseHeader1">
										<expr:path>$RSPPagoRecaudo.ResponseHeader</expr:path></expr:param>
									<expr:param name="pagoRecaudoResponse">
										<expr:path>$RSPPagoRecaudo.result</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:insert></bpel:extensionAssignOperation></bpel:assign></bpel:sequence></bpel:scope></bpel:forEach></bpel:sequence>
        				<bpel:else>
        					<bpel:sequence>
        						<bpel:empty/>
        					</bpel:sequence>
        				</bpel:else>
        			</bpel:if>
        			</bpel:sequence>
        	</bpel:scope>
        <bpel:scope bea:name="ParallelAgreementsGroupProcessing">
		<bpel:sequence>
			<bpel:if>
				<bpel:condition>count($parallelAgreementsGroup/AGREEMENTS/*) > 0</bpel:condition>
				<bpel:sequence>
					<bpel:empty/>
				<bpel:scope>
		<bpel:faultHandlers>
			<bpel:catch faultName="tns:TooMuchAgreements">
				<bpel:sequence>
					<bpel:empty/>
					<bpel:assign>
						<bpel:extensionAssignOperation>
							<trf:replace contents-only="false" varName="response.outputParameters">
								<trf:expr>
									<expr:xqueryText><![CDATA[<outputParameters>
	<SUCCESS_INDICATOR>ERROR</SUCCESS_INDICATOR>
	<ERROR_MESSAGE>Contratos en solicitud exceden cantidad permitida</ERROR_MESSAGE>
</outputParameters>]]></expr:xqueryText></trf:expr></trf:replace></bpel:extensionAssignOperation></bpel:assign>
					<bpel:reply operation="PagoMultipleRecaudo" partnerLink="sjPagoMultipleRecaudo" variable="response"/>
					<bpel:exit/>
					<bpel:exit/>
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					</bpel:sequence></bpel:catch></bpel:faultHandlers>
		<bpel:sequence>
			<bpel:if>
				<bpel:condition>$maxBills &lt; $numberOfAgreements</bpel:condition>
				<bpel:sequence>
					<bpel:empty/>
					<bpel:throw faultName="tns:TooMuchAgreements"/></bpel:sequence>
				<bpel:else>
					<bpel:sequence>
						<bpel:empty/>
						<bpel:assign>
							<bpel:extensionAssignOperation bea:name="Obtiene parametro maxParallel">
								<trf:assign varName="maxParallel">
									<trf:expr>
										<expr:xqueryText>let $maxParallel := $RSPobtenerParametrizacion.OutputParameters/osb:CONFIGURACIONES/osb:CONFIGURACIONES_ITEM[osb:NAME= $ReqMaxParallel ]/osb:VALUE/text()
return 
	if(fn:string(fn:number($maxParallel)) = "NaN") then (
		5
	) else (
		xs:integer($maxParallel)
	)</expr:xqueryText></trf:expr></trf:assign></bpel:extensionAssignOperation>
							<bpel:extensionAssignOperation bea:name="Preparar grupos">
								<trf:assign varName="batches">
									<trf:expr>
										<expr:xqueryTransform>
											<expr:resource ref="Middleware/v2/Resources/Generales/xq/splitIntoBatches"/>
											<expr:param name="requests">
												<expr:path>$parallelAgreementsGroup</expr:path></expr:param>
											<expr:param name="maxParallel">
												<expr:path>$maxParallel</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign></bpel:extensionAssignOperation></bpel:assign>
						<bpel:forEach parallel="no" counterName="batchIndex">
							<bpel:startCounterValue>number(1)</bpel:startCounterValue>
							<bpel:finalCounterValue>count($batches/Batch)</bpel:finalCounterValue>
							<bpel:scope>
								<bpel:variables>
									<bpel:variable name="batch" type="xsd:anyType"/>
									<bpel:variable name="variablePrueba" type="xsd:integer">
									</bpel:variable></bpel:variables>
								<bpel:sequence>
									<bpel:assign>
										<bpel:copy>
											<bpel:from>$batches/Batch[position() = $batchIndex]</bpel:from>
											<bpel:to variable="batch"/></bpel:copy>
										<bpel:extensionAssignOperation>
											<trf:assign varName="variablePrueba">
												<trf:expr>
													<expr:xqueryText>count($batch/AGREEMENT)</expr:xqueryText></trf:expr></trf:assign>
										</bpel:extensionAssignOperation></bpel:assign>
									<bpel:forEach parallel="yes" counterName="reqCounter">
										<bpel:startCounterValue>number(1)</bpel:startCounterValue>
										<bpel:finalCounterValue>count($batch/AGREEMENT)</bpel:finalCounterValue>
										<bpel:scope>
											<bpel:variables>
												<bpel:variable name="REQPagoRecaudo" messageType="ns3:pagoRecaudoRequest"/>
												<bpel:variable name="RSPPagoRecaudo" messageType="ns3:pagoRecaudoResponse"/></bpel:variables>
											<bpel:faultHandlers>
												<bpel:catchAll>
													<bpel:sequence>
														<bpel:empty/>
														<bpel:assign>
															<bpel:extensionAssignOperation bea:name="Agregar a la respuesta">
																<trf:insert varName="response.outputParameters">
																	<trf:location>
																		<expr:xpathText>./AGREEMENTS</expr:xpathText></trf:location>
																	<trf:where>last-child</trf:where>
																	<trf:expr>
																		<expr:xqueryText>&lt;AGREEMENT>
	&lt;SUCCESS_INDICATOR>ERROR&lt;/SUCCESS_INDICATOR>
&lt;/AGREEMENT></expr:xqueryText></trf:expr></trf:insert></bpel:extensionAssignOperation></bpel:assign></bpel:sequence></bpel:catchAll></bpel:faultHandlers>
											<bpel:sequence>
												<bpel:assign>
													<bpel:extensionAssignOperation bea:name="Preparar header">
														<trf:assign varName="REQPagoRecaudo.RequestHeader">
															<trf:expr>
																<expr:xqueryTransform>
																	<expr:resource ref="Middleware/v2/BusinessServices/SJS/pagoMultipleRecaudo/xq/pagoRecaudoHeaderIn"/>
																	<expr:param name="sjPagoMultipleRecaudo">
																		<expr:path>$request.inputParameters</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign></bpel:extensionAssignOperation>
													<bpel:extensionAssignOperation bea:name="Preparar body">
														<bpel:documentation/>
														<trf:assign varName="REQPagoRecaudo.parameters">
															<trf:expr>
																<expr:xqueryTransform>
																	<expr:resource ref="Middleware/v2/BusinessServices/SJS/pagoMultipleRecaudo/xq/pagoRecaudoIn"/>
																	<expr:param name="agreement">
																		<expr:path>$batch/AGREEMENT[position() = $reqCounter]</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign></bpel:extensionAssignOperation></bpel:assign>
												<bpel:invoke outputVariable="RSPPagoRecaudo" inputVariable="REQPagoRecaudo" operation="pagoRecaudo" partnerLink="PagoRecaudo">
													<rescon:invokeInfo><rescon:service ref="Middleware/v2/ProxyServices/PagoRecaudo" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></rescon:invokeInfo></bpel:invoke>
												<bpel:assign>
													<bpel:extensionAssignOperation bea:name="Agregar a la respuesta">
														<bpel:documentation/>
														<trf:insert varName="response.outputParameters">
															<trf:location>
																<expr:xpathText>./AGREEMENTS</expr:xpathText></trf:location>
															<trf:where>last-child</trf:where>
															<trf:expr>
																<expr:xqueryTransform>
																	<expr:resource ref="Middleware/v2/BusinessServices/SJS/pagoMultipleRecaudo/xq/pagoRecaudoOut"/>
																	
																	
																	
																	
																	<expr:param name="agreement">
																		<expr:path>$batch/AGREEMENT[position() = $reqCounter]</expr:path></expr:param>
																	<expr:param name="responseHeader1">
																		<expr:path>$RSPPagoRecaudo.ResponseHeader</expr:path></expr:param>
																	<expr:param name="pagoRecaudoResponse">
																		<expr:path>$RSPPagoRecaudo.result</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:insert></bpel:extensionAssignOperation></bpel:assign></bpel:sequence></bpel:scope></bpel:forEach></bpel:sequence></bpel:scope></bpel:forEach></bpel:sequence></bpel:else></bpel:if></bpel:sequence></bpel:scope></bpel:sequence>
				<bpel:else>
					<bpel:sequence>
						<bpel:empty/>
					</bpel:sequence>
				</bpel:else>
			</bpel:if>
			</bpel:sequence>
        </bpel:scope></bpel:flow>
        
        
        <bpel:reply partnerLink="sjPagoMultipleRecaudo" operation="PagoMultipleRecaudo" variable="response"/>
    </bpel:sequence>
</bpel:process>