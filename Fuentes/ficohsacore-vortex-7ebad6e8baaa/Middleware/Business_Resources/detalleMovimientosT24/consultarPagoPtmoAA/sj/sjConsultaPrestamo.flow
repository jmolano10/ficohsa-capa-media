<bpel:process name="sjConsultaPrestamo" targetNamespace="http://www.example.com/flow/MiddlewareCaja/Resources/splitJoin/PagoPrestamoCaja/sjConsultaPrestamo" bea:name="sjConsultaPrestamo" xmlns:tns="http://www.example.com/flow/MiddlewareCaja/Resources/splitJoin/PagoPrestamoCaja/sjConsultaPrestamo" xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable" xmlns:rescon="http://www.bea.com/alsb/flow/resources/config" xmlns:bea="http://www.bea.com/bpel/ui/extensions" xmlns:ext="http://www.bea.com/bpel/extensions" xmlns:expr="http://www.bea.com/wli/sb/stages/config" xmlns:trf="http://www.bea.com/wli/sb/stages/transform/config" xmlns:bind="http://www.ficohsa.com.hn/middleware.services/sjConsultaPrestamoPS/" xmlns:ns1="T24WebServicesImpl" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:ns0="http://www.bea.com/wli/sb/stages/logging/config" xmlns:ns2="http://xmlns.oracle.com/pcbpel/adapter/db/InterbancaSOAApplication/ObtenerParametrizacion/obtenerParametrizacion" xmlns:osb="http://xmlns.oracle.com/pcbpel/adapter/db/ORA_BANK/OSB_GET_CONFIG/">
    <bpel:partnerLinks>
        <bpel:partnerLink name="sjConsultaPrestamo" partnerLinkType="tns:sjConsultaPrestamo" myRole="sjConsultaPrestamo">
	       </bpel:partnerLink>
	   
	   <bpel:partnerLink name="ObtenerParametrizacion_db" partnerLinkType="tns:ObtenerParametrizacion_db_plnkType" partnerRole="ObtenerParametrizacion_db_PartnerRole">
	   </bpel:partnerLink>
	   <bpel:partnerLink name="PrestamosT24BS" partnerLinkType="tns:PrestamosT24BS_plnkType" partnerRole="PrestamosT24BS_PartnerRole">
	   </bpel:partnerLink></bpel:partnerLinks>

	   <bpel:variables>
        <bpel:variable name="request" messageType="bind:sjConsultaPrestamoRequest">
	       </bpel:variable>
	       <bpel:variable name="response" messageType="bind:sjConsultaPrestamoResponse">
	       </bpel:variable>
    <bpel:variable name="REQConsultaDatosPrestamo" messageType="ns1:Consultadesaldodeprestamo">
    </bpel:variable>
    <bpel:variable name="RSPConsultaDatosPrestamo" messageType="ns1:ConsultadesaldodeprestamoResponse">
    </bpel:variable>
    <bpel:variable name="REQConsultaPagoPrestamo" messageType="ns1:ConsultadepagodeprestamoAA">
    </bpel:variable>
    <bpel:variable name="RSPConsultaPagoPrestamo" messageType="ns1:ConsultadepagodeprestamoAAResponse">
    </bpel:variable>
    
    <bpel:variable name="RSPConsultaAplicaPagoPrestamo" messageType="ns1:ConsultaaplicacionpagoptmoResponse">
    </bpel:variable>
    <bpel:variable name="REQConsultaAplicaPagoPrestamo" messageType="ns1:Consultaaplicacionpagoptmo">
    </bpel:variable>
    <bpel:variable name="REQConsultaPagoPrestamoBO" messageType="ns1:ConsultabackofficepagoptmoAA">
    </bpel:variable>
    <bpel:variable name="RSPConsultaPagoPrestamoBO" messageType="ns1:ConsultabackofficepagoptmoAAResponse">
    </bpel:variable>
    <bpel:variable name="transactionType" type="xsd:string"/></bpel:variables>

    <bpel:sequence>
        <bpel:receive partnerLink="sjConsultaPrestamo" operation="sjConsultaPrestamo" createInstance="yes" variable="request">
	           <rescon:receiveInfo>
                
            <rescon:wsdl ref="Middleware/Business_Resources/detalleMovimientosT24/consultarPagoPtmoAA/wsdl/SjConsultaPrestamo" binding="bind:sjConsultaPrestamoPSSOAP"/></rescon:receiveInfo>
        </bpel:receive>
        <bpel:assign>
        	<bpel:extensionAssignOperation>
        		<trf:assign varName="transactionType">
        			<trf:expr>
        				<expr:xqueryText>if (fn:substring(fn:string($request.inputParameters/TRANSACTION_ID/text()),1,2) = ("FI","FT")) then (
	"DIRECT"
) else if (fn:substring(fn:string($request.inputParameters/TRANSACTION_ID/text()),1,3) = "TFS") then (
	"TELLER"
) else (
	"ERROR"
)</expr:xqueryText></trf:expr></trf:assign>
        	</bpel:extensionAssignOperation>
        </bpel:assign>
        <bpel:flow>
        	<bpel:scope bea:name="ConsultaDatosPtmo">
        		<bpel:sequence>
        			<bpel:assign>
        				<bpel:extensionAssignOperation>
        					<trf:assign varName="REQConsultaDatosPrestamo.parameters">
        						<trf:expr>
        							<expr:xqueryTransform>
        								<expr:resource ref="Middleware/Business_Resources/detalleMovimientosT24/consultarPagoPtmoAA/xq/sjConsultaDatosPrestamoIn"/>
        								<expr:param name="sjConsultaPrestamo1">
        									<expr:path>$request.inputParameters</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign>
        				</bpel:extensionAssignOperation>
        			</bpel:assign>
        			<bpel:invoke operation="Consultadesaldodeprestamo" partnerLink="PrestamosT24BS" inputVariable="REQConsultaDatosPrestamo" outputVariable="RSPConsultaDatosPrestamo">
        				<rescon:invokeInfo><rescon:service ref="Middleware/Business_Resources/consultaGeneralPrestamo/Resources/PrestamosT24BS" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></rescon:invokeInfo></bpel:invoke></bpel:sequence>
        	</bpel:scope>
        	<bpel:scope bea:name="ConsultaPagoPtmo">
        		<bpel:sequence>
        			<bpel:if bea:name="PAGO TELLER">
        				<bpel:documentation>Condicion para determinar si pago realizado fue directo o si fue a traves de TFS. Si fue directo, se consultan detalles del pago con este servicio</bpel:documentation>
        				<bpel:condition>$transactionType = "TELLER"</bpel:condition>
        				<bpel:sequence>
        					<bpel:empty/>
        				<bpel:assign>
		<bpel:extensionAssignOperation>
			<trf:assign varName="REQConsultaPagoPrestamo.parameters">
				<trf:expr>
					<expr:xqueryTransform>
						<expr:resource ref="Middleware/Business_Resources/detalleMovimientosT24/consultarPagoPtmoAA/xq/sjConsultaPagoPrestamoIn"/>
						<expr:param name="sjConsultaPrestamo1">
							<expr:path>$request.inputParameters</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign></bpel:extensionAssignOperation></bpel:assign>
        				<bpel:invoke operation="ConsultadepagodeprestamoAA" partnerLink="PrestamosT24BS" inputVariable="REQConsultaPagoPrestamo" outputVariable="RSPConsultaPagoPrestamo">
        					<rescon:invokeInfo><rescon:service ref="Middleware/Business_Resources/consultaGeneralPrestamo/Resources/PrestamosT24BS" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></rescon:invokeInfo></bpel:invoke></bpel:sequence>
        				<bpel:else>
        					<bpel:sequence>
        						<bpel:empty/>
        					<bpel:assign>
		<bpel:extensionAssignOperation>
			<trf:assign varName="RSPConsultaPagoPrestamo.parameters">
				<trf:expr>
					<expr:xqueryText>&lt;ns2:ConsultadepagodeprestamoAAResponse xmlns:ns2="T24WebServicesImpl"/>
</expr:xqueryText></trf:expr></trf:assign>
		</bpel:extensionAssignOperation>
        					</bpel:assign></bpel:sequence>
        				</bpel:else>
        			</bpel:if>
        			
        			</bpel:sequence>
        	</bpel:scope>
        <bpel:scope bea:name="ConsultaAplicacionPagoPtmo">
		
	<bpel:variables>
		<bpel:variable name="count" type="xsd:integer"/>
		<bpel:variable name="successInd" type="xsd:string"/>
		<bpel:variable name="REQObtenerParams" messageType="ns2:args_in_msg">
		</bpel:variable>
		<bpel:variable name="RSPObtenerParams" messageType="ns2:args_out_msg">
		</bpel:variable>
		<bpel:variable name="maxAttempts" type="xsd:integer"/></bpel:variables>
	<bpel:sequence>
			
			<bpel:assign>
				<bpel:extensionAssignOperation>
					<trf:assign varName="REQConsultaAplicaPagoPrestamo.parameters">
						<trf:expr>
							<expr:xqueryTransform>
								<expr:resource ref="Middleware/Business_Resources/detalleMovimientosT24/consultarPagoPtmoAA/xq/sjConsultaAplicacionPrestamoIn"/>
								<expr:param name="sjConsultaPrestamo1">
									<expr:path>$request.inputParameters</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign></bpel:extensionAssignOperation>
				<bpel:extensionAssignOperation>
					<trf:assign varName="count">
						<trf:expr>
							<expr:xqueryText>1</expr:xqueryText></trf:expr></trf:assign></bpel:extensionAssignOperation>
				<bpel:extensionAssignOperation>
					<bpel:documentation/>
					<trf:assign varName="REQObtenerParams.InputParameters">
						<trf:expr>
							<expr:xqueryTransform>
								<expr:resource ref="Middleware/Business_Resources/general/Parametrizacion/obtenerParametrizacionIn"/>
								<expr:param name="nombreParametros">
									<expr:path>"T24C189.LOANAPPLQRYATTEMPTS"</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign></bpel:extensionAssignOperation></bpel:assign>
			<bpel:invoke operation="Consultaaplicacionpagoptmo" partnerLink="PrestamosT24BS" outputVariable="RSPConsultaAplicaPagoPrestamo" inputVariable="REQConsultaAplicaPagoPrestamo">
				<rescon:invokeInfo><rescon:service ref="Middleware/Business_Resources/consultaGeneralPrestamo/Resources/PrestamosT24BS" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></rescon:invokeInfo></bpel:invoke>
			<bpel:invoke operation="obtenerParametrizacion" partnerLink="ObtenerParametrizacion_db" outputVariable="RSPObtenerParams" inputVariable="REQObtenerParams">
				<rescon:invokeInfo><rescon:service ref="Middleware/Business_Resources/general/Resources/ObtenerParametrizacion/ObtenerParametrizacion" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></rescon:invokeInfo></bpel:invoke>
			<bpel:assign>
				<bpel:extensionAssignOperation>
					<bpel:documentation/>
					<trf:assign varName="successInd">
						<trf:expr>
							<expr:xqueryText>if (fn:string($RSPConsultaAplicaPagoPrestamo.parameters/WSFICOADVDEALSLIPENTRYType[1]/ZERORECORDS/text()) = "") then (
	"1"
) else (
	"0"
)</expr:xqueryText></trf:expr></trf:assign></bpel:extensionAssignOperation>
				<bpel:extensionAssignOperation>
					<trf:assign varName="maxAttempts">
						<trf:expr>
							<expr:xqueryText>fn:string($RSPObtenerParams.OutputParameters/osb:CONFIGURACIONES/osb:CONFIGURACIONES_ITEM[osb:NAME="T24C189.LOANAPPLQRYATTEMPTS"]/osb:VALUE/text())</expr:xqueryText></trf:expr></trf:assign></bpel:extensionAssignOperation></bpel:assign>
			<bpel:while>
				<bpel:condition>$count &lt; $maxAttempts and $successInd = "0"</bpel:condition>
				<bpel:sequence>
					<bpel:wait>
						<bpel:for>"PT3S"</bpel:for></bpel:wait>
					<bpel:invoke operation="Consultaaplicacionpagoptmo" partnerLink="PrestamosT24BS" outputVariable="RSPConsultaAplicaPagoPrestamo" inputVariable="REQConsultaAplicaPagoPrestamo">
						<rescon:invokeInfo><rescon:service ref="Middleware/Business_Resources/consultaGeneralPrestamo/Resources/PrestamosT24BS" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></rescon:invokeInfo></bpel:invoke>
					<bpel:assign>
						<bpel:extensionAssignOperation>
							<trf:assign varName="successInd">
								<trf:expr>
									<expr:xqueryText>if (fn:string($RSPConsultaAplicaPagoPrestamo.parameters/WSFICOADVDEALSLIPENTRYType[1]/ZERORECORDS/text()) = "") then (
	"1"
) else (
	"0"
)</expr:xqueryText></trf:expr></trf:assign></bpel:extensionAssignOperation>
						<bpel:extensionAssignOperation>
							<bpel:documentation/>
							<trf:assign varName="count">
								<trf:expr>
									<expr:xqueryText>xs:int($count) + 1</expr:xqueryText></trf:expr></trf:assign></bpel:extensionAssignOperation></bpel:assign></bpel:sequence></bpel:while>
			
			
			
			
			
			
			
			
			
			
			</bpel:sequence>
        </bpel:scope>
        <bpel:scope bea:name="ConsultaPagoPrestamoBO">
        	
        	<bpel:sequence>
        		<bpel:if bea:name="PAGO DIRECTO">
        			<bpel:documentation>Condicion para determinar si pago realizado fue directo o si fue a traves de TFS. Si fue directo, se consultan detalles del pago con este servicio</bpel:documentation>
        			<bpel:condition>$transactionType = "DIRECT"</bpel:condition>
        			<bpel:sequence>
        				<bpel:empty/>
        			<bpel:assign>
		<bpel:extensionAssignOperation>
			<trf:assign varName="REQConsultaPagoPrestamoBO.parameters">
				<trf:expr>
					<expr:xqueryTransform>
						<expr:resource ref="Middleware/Business_Resources/detalleMovimientosT24/consultarPagoPtmoAA/xq/sjConsultaPagoPrestamoBOIn"/>
						<expr:param name="sjConsultaPrestamo1">
							<expr:path>$request.inputParameters</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign></bpel:extensionAssignOperation></bpel:assign>
        			<bpel:invoke operation="ConsultabackofficepagoptmoAA" partnerLink="PrestamosT24BS" inputVariable="REQConsultaPagoPrestamoBO" outputVariable="RSPConsultaPagoPrestamoBO">
        				<rescon:invokeInfo><rescon:service ref="Middleware/Business_Resources/consultaGeneralPrestamo/Resources/PrestamosT24BS" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/></rescon:invokeInfo></bpel:invoke></bpel:sequence>
        			<bpel:else>
        				<bpel:sequence>
        					<bpel:empty/>
        				<bpel:assign>
		<bpel:extensionAssignOperation>
			<trf:assign varName="RSPConsultaPagoPrestamoBO.parameters">
				<trf:expr>
					<expr:xqueryText><![CDATA[<ns2:ConsultabackofficepagoptmoAAResponse xmlns:ns2="T24WebServicesImpl">
	<Status>
		<successIndicator>Success</successIndicator>
	</Status>
	<WSFICOBOPAYMENTDETAILSType>
		<ZERORECORDS>0 Records Returned</ZERORECORDS>
	</WSFICOBOPAYMENTDETAILSType>
</ns2:ConsultabackofficepagoptmoAAResponse>
]]></expr:xqueryText></trf:expr></trf:assign>
		</bpel:extensionAssignOperation>
        				</bpel:assign></bpel:sequence>
        			</bpel:else>
        		</bpel:if>
        		
        		</bpel:sequence>
        </bpel:scope></bpel:flow>
        <bpel:assign>
        	<bpel:extensionAssignOperation>
        		<trf:assign varName="response.outputParameters">
        			<trf:expr>
        				<expr:xqueryTransform>
        					<expr:resource ref="Middleware/Business_Resources/detalleMovimientosT24/consultarPagoPtmoAA/xq/sjConsultaDatosPagoPrestamoOut"/>
        					
        					
        					
        					
        					
        					
        					
        					
        					
        					<expr:param name="transactionType">
        						<expr:path>$transactionType</expr:path></expr:param>
        					<expr:param name="consultadesaldodeprestamoResponse1">
        						<expr:path>$RSPConsultaDatosPrestamo.parameters</expr:path></expr:param>
        					<expr:param name="consultadepagodeprestamoAAResponse1">
        						<expr:path>$RSPConsultaPagoPrestamo.parameters</expr:path></expr:param>
        					<expr:param name="consultabackofficepagoptmoAAResponse1">
        						<expr:path>$RSPConsultaPagoPrestamoBO.parameters</expr:path></expr:param>
        					<expr:param name="consultaaplicacionpagoptmoResponse1">
        						<expr:path>$RSPConsultaAplicaPagoPrestamo.parameters</expr:path></expr:param></expr:xqueryTransform></trf:expr></trf:assign>
        	</bpel:extensionAssignOperation>
        </bpel:assign>
        <bpel:reply partnerLink="sjConsultaPrestamo" operation="sjConsultaPrestamo" variable="response"/>
    </bpel:sequence>
</bpel:process>